function getURLQueryStringParameterByName(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(location.search);return null===e?null:decodeURIComponent(e[1].replace(/\+/g," "))}function cloneObject(t){var e=t instanceof Array?[]:{};for(var a in t)"clone"!=a&&(t[a]&&"object"==typeof t[a]?e[a]=cloneObject(t[a]):e[a]=t[a]);return e}function arraysEqual(t,e){if(!(t instanceof Array&&e instanceof Array))return!1;if(t.length!=e.length)return!1;for(var a=0;a<t.length;a++){if(t[a]instanceof Array||e[a]instanceof Array){if(!arraysEqual(t[a],e[a]))return!1}else if(t[a]!=e[a])return!1}return!0}function cross(t,e){return{x:t.y*e.z-t.z*e.y,y:t.z*e.x-t.x*e.z,z:t.x*e.y-t.y*e.x}}function dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function magnitude(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}function normalize(t){var e=magnitude(t);return t.x=t.x/e,t.y=t.y/e,t.z=t.z/e,t}function multiply(t,e){return t.x*=e,t.y*=e,t.z*=e,t}function add(t,e){return t.x+=e.x,t.y+=e.y,t.z+=e.z,t}function sub(t,e){return t.x-=e.x,t.y-=e.y,t.z-=e.z,t}function negate(t){return multiply(t,-1),t}function BounceGA(t,e){if(this.gaConfig=t,void 0===(this.fitnessConfig=e).axis1)for(var a=0;a<this.fitnessConfig.surfaces.length;a++){var n,s=this.fitnessConfig.surfaces[a];normalize(s.normal),n=0==s.normal.x&&0==s.normal.z?{x:1,y:0,z:0}:{x:-s.normal.z,y:0,z:s.normal.x};var o=cross(s.normal,n);normalize(n),normalize(o),multiply(n,s.scale),multiply(o,s.scale),s.axis1=n,s.axis2=o}this.simple=!1,1==e.numBounces&&1==e.surfaces.length&&0==e.surfaces[0].normal.x&&0==e.surfaces[0].normal.z&&e.minT==e.maxT&&(this.simple=!0),this.generations=0,this.rankedPopulation=[],this.fittestMembers=[],this.ableToFindSolution=void 0}Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]}),Array.prototype.getIndexCyclic||(Array.prototype.getIndexCyclic=function(t){return this[t%this.length]}),Array.prototype.getNextCyclic||(Array.prototype.getNextCyclic=function(t){return t%=this.length,this.length-1==t?this[0]:this[t+1]}),Array.prototype.getPreviousCyclic||(Array.prototype.getPreviousCyclic=function(t){return 0==(t%=this.length)?this[this.length-1]:this[t-1]}),window.randomColors=["red","blue","green","black","yellow","purple"],BounceGA.prototype.getBouncePath=function(t){var e=cloneObject(this.fitnessConfig.p0),a=cloneObject(t),n=[],s=[];n.push(cloneObject(e)),s.push(cloneObject(a));for(var o=0;o<this.fitnessConfig.surfaces.length;o++)this.fitnessConfig.surfaces[o].bounces=0,this.fitnessConfig.surfaces[o].colliding=!1;for(var r=0,i=[],l=[],h=0;h<=this.fitnessConfig.maxT;h+=this.fitnessConfig.dt){add(e,multiply(cloneObject(a),this.fitnessConfig.dt)),a.y+=this.fitnessConfig.G*this.fitnessConfig.dt,n.push(cloneObject(e)),s.push(cloneObject(a));for(o=0;o<this.fitnessConfig.surfaces.length;o++){var u=this.fitnessConfig.surfaces[o],p=u.normal.x*e.x+u.normal.y*e.y+u.normal.z*e.z-u.normal.x*u.position.x-u.normal.y*u.position.y-u.normal.z*u.position.z;if(Math.abs(p)<=this.fitnessConfig.R&&Math.abs(dot(sub(cloneObject(e),u.position),normalize(cloneObject(u.axis1))))<=u.scale&&Math.abs(dot(sub(cloneObject(e),u.position),normalize(cloneObject(u.axis2))))<=u.scale&&!u.colliding){u.colliding=!0,u.bounces++,i.push(o),r++;var g=(new THREE.Vector3).copy(u.normal);multiply(g=cloneObject(u.normal),dot(a,u.normal)),multiply(g,2*this.fitnessConfig.C),negate(g),add(a,g)}else Math.abs(p)>this.fitnessConfig.R&&u.colliding&&(u.colliding=!1)}if(h>=this.fitnessConfig.minT||h+this.fitnessConfig.dt>this.fitnessConfig.maxT){var d=!0;this.fitnessConfig.surfaceBounceOrder&&i.toString()!=this.fitnessConfig.surfaceBounceOrder.toString()&&(d=!1);var c=!1;r==this.fitnessConfig.numBounces&&(c=!0),d&&c&&(1==this.fitnessConfig.catchSign&&0<=a.y||-1==this.fitnessConfig.catchSign&&a.y<=0||null==this.fitnessConfig.catchSign)&&(1==this.fitnessConfig.tossSign&&0<=t.y||-1==this.fitnessConfig.tossSign&&t.y<=0||null==this.fitnessConfig.tossSign)&&l.push({pT:cloneObject(e),T:h,actualpT:this.fitnessConfig.pT})}}return 0<l.length?(l.sort(function(t,e){return magnitude(sub(cloneObject(t.pT),t.actualpT))-magnitude(sub(cloneObject(e.pT),t.actualpT))}),{path:n.splice(0,l[0].T/this.fitnessConfig.dt),velocities:s.splice(0,l[0].T/this.fitnessConfig.dt),T:l[0].T}):{path:void 0,velocities:void 0,T:void 0}},BounceGA.prototype.generateMember=function(t){var e={x:0,y:0,z:0};if(t&&t.fitness<100)Math.random()<this.gaConfig.mutationChance?(e.y=(1-2*Math.random())*(t.fitness<this.gaConfig.mutationScale?t.fitness:this.gaConfig.mutationScale),this.simple||(e.x=(1-2*Math.random())*(t.fitness<this.gaConfig.mutationScale?t.fitness:this.gaConfig.mutationScale),e.z=(1-2*Math.random())*(t.fitness<this.gaConfig.mutationScale?t.fitness:this.gaConfig.mutationScale)),add(e,t.v)):e=cloneObject(t.v);else if(this.simple)e.x=(this.fitnessConfig.pT.x-this.fitnessConfig.p0.x)/this.fitnessConfig.minT,e.z=(this.fitnessConfig.pT.z-this.fitnessConfig.p0.z)/this.fitnessConfig.minT,e.y=this.fitnessConfig.tossSign*Math.random()*this.gaConfig.initialScale;else{var a;add(e=cloneObject((a=this.fitnessConfig.surfaceBounceOrder?this.fitnessConfig.surfaces[this.fitnessConfig.surfaceBounceOrder[0]]:this.fitnessConfig.surfaces[Math.floor(Math.random()*this.fitnessConfig.surfaces.length)]).position),multiply(cloneObject(a.axis1),1-2*Math.random())),add(e,multiply(cloneObject(a.axis2),1-2*Math.random()));var n=e.y;e.y=0;var s=cloneObject(this.fitnessConfig.p0);s.y=0;var o=cloneObject(this.fitnessConfig.pT).y=0,r=this.gaConfig.initialScale;sub(e,s),normalize(e),multiply(e,o+(r-o)*Math.random()),o=1==this.fitnessConfig.tossSign||n>this.fitnessConfig.p0.y?0:-2*(this.fitnessConfig.p0.y-n)/this.fitnessConfig.minT,r=this.gaConfig.initialScale,e.y=o+(r-o)*Math.random()}var i=this.getBouncePath(e);return{v:e,T:i.T,fitness:i.path?magnitude(sub(cloneObject(i.path[i.path.length-1]),this.fitnessConfig.pT)):100}},BounceGA.prototype.evolve=function(){if(this.generations>=this.gaConfig.maxGenerations)this.ableToFindSolution=!1;else if(0<this.rankedPopulation.length&&this.rankedPopulation[0].fitness<=this.gaConfig.fitnessThreshold)this.ableToFindSolution=!0;else{if(0==this.rankedPopulation.length||this.gaConfig.noGA){this.rankedPopulation=[];for(var t=0;t<this.gaConfig.populationSize;t++)this.rankedPopulation.push(this.generateMember(void 0))}else{var e=0,a=[];for(t=0;t<this.rankedPopulation.length;t++)e+=1/this.rankedPopulation[t].fitness,a.push(e);var n=[];for(t=0;t<this.gaConfig.populationSize;t++)if(t<.5*this.gaConfig.populationSize)n.push(this.generateMember(void 0));else for(var s=Math.random()*e,o=0;o<a.length;o++)if(s<a[o]){n.push(this.generateMember(this.rankedPopulation[o]));break}this.rankedPopulation=n}this.rankedPopulation.sort(function(t,e){return t.fitness-e.fitness});var r=this.rankedPopulation[0];this.fittestMembers.push(r),this.generations++,this.generations%100==0&&console.log(this.generations+" "+r.fitness),this.evolve()}},function(t){t.interpolateBezierSpline=function(t,e,a,n,s,o,r){var i;if(0==e)i=t[0];else if(1==e)i=t.last();else{1==t.length&&t.push(t[0]);for(var l,h=[{x:t[0].x+a.dx*s,y:t[0].y+a.dy*s,z:t[0].z+a.dz*s},{x:t.last().x-n.dx*o,y:t.last().y-n.dy*o,z:t.last().z-n.dz*o}],u=[],p=[],g=0;g<t.length-1;g++){var d,c=t[g],f=t[g+1];if(0==g)v=h[0];else{var y=u[u.length-1],v={x:c.x+(c.x-y.x),y:c.y+(c.y-y.y),z:c.z+(c.z-y.z)};u.push(v)}if(g+1==t.length-1)d=h[1];else{var m=(t[g].x+t[g+1].x)/2,x=(t[g].y+t[g+1].y)/2,b=(t[g].z+t[g+1].z)/2,w=(t[g+1].x+t[g+2].x)/2,z=(t[g+1].y+t[g+2].y)/2,M=(t[g+1].z+t[g+2].z)/2,P=Math.sqrt(Math.pow(t[g].x-t[g+1].x,2)+Math.pow(t[g].y-t[g+1].y,2)+Math.pow(t[g].z-t[g+1].z,2)),C=(1-(j=P/(P+Math.sqrt(Math.pow(t[g+1].x-t[g+2].x,2)+Math.pow(t[g+1].y-t[g+2].y,2)+Math.pow(t[g+1].z-t[g+2].z,2)))))*m+j*w,O=(1-j)*x+j*z,T=(1-j)*b+j*M;d={x:f.x+(m-C),y:f.y+(x-O),z:f.z+(b-T)},u.push(d)}for(var j=0;j<=1+1e-5;j+=.02)p.push({x:Math.pow(1-j,3)*c.x+3*Math.pow(1-j,2)*j*v.x+3*(1-j)*Math.pow(j,2)*d.x+Math.pow(j,3)*f.x,y:Math.pow(1-j,3)*c.y+3*Math.pow(1-j,2)*j*v.y+3*(1-j)*Math.pow(j,2)*d.y+Math.pow(j,3)*f.y,z:Math.pow(1-j,3)*c.z+3*Math.pow(1-j,2)*j*v.z+3*(1-j)*Math.pow(j,2)*d.z+Math.pow(j,3)*f.z}),1==p.length?p.last().dist=0:p.last().dist=p[p.length-2].dist+Math.sqrt(Math.pow(p.last().x-p[p.length-2].x,2)+Math.pow(p.last().y-p[p.length-2].y,2)+Math.pow(p.last().z-p[p.length-2].z,2))}if(r){var S=Math.sqrt(Math.pow(a.dx,2)+Math.pow(a.dy,2)+Math.pow(a.dz,2)),D=Math.sqrt(Math.pow(n.dx,2)+Math.pow(n.dy,2)+Math.pow(n.dz,2)),B=p.last().dist,I=siteswap.dwellDuration,A=(6*I*(D+S)-12*B)/Math.pow(I,3),R=e*I,E=S*R+.5*((D-S-.5*A*Math.pow(I,2))/I)*Math.pow(R,2)+1/6*A*Math.pow(R,3);for(g=l=0;g<p.length;g++)p[g].dist<=E&&(l=g)}else l=Math.floor(e*p.length);i=p[l<0?0:l]}return i}}("undefined"==typeof exports?this.Bezier={}:exports),function(t){function M(t){for(var e=0,a=0;a<t.length;a++)parseInt(t[a])?e+=parseInt(t[a]):97<=t.charCodeAt(a)&&t.charCodeAt(a)<=119&&(e+=t.charCodeAt(a)-87),"P"!=t[a]&&"S"!=t[a]||!parseInt(t[a+1])||a++,"B"!=t[a]&&"D"!=t[a]&&"T"!=t[a]&&"C"!=t[a]&&"S"!=t[a]||"{"!=t[a+1]||(a=t.indexOf("}",a));return e}window.sumThrows=M;var bt={};t.CreateSiteswap=function(z,u){var H,F,m,J,G,k,x,b,ct={siteswap:z,validSyntax:!1,validPattern:!1,collision:void 0,multiplex:void 0,sync:void 0,pass:void 0,startingHand:1,numJugglers:void 0,numProps:void 0,maxHeight:void 0,tosses:void 0,beats:void 0,states:void 0,propOrbits:void 0,propPositions:void 0,propRotations:void 0,jugglerHandPositions:void 0,jugglerElbowPositions:void 0,jugglers:void 0,validationOnly:void 0,numStepsPerBeat:void 0,numSteps:void 0,beatDuration:void 0,dwellDuration:void 0,props:void 0,dwellPath:void 0,tossMatchVelocity:void 0,catchMatchVelocity:void 0,dwellCatchScale:void 0,dwellTossScale:void 0,emptyTossScale:void 0,emptyCatchScale:void 0,armAngle:void 0,surfaces:void 0,errorMessage:void 0,stateDiagram:void 0};return function(){z=z.replace(/\s/g,"");var t=1;if(/<[^ ]+>/.test(z)){var e=z.match(/<[^ <>]+>/g);if(1==(t=e[0].split("|").length))return;var a=t;e.map(function(t){if(t.split("|").length!=a)return ct})}var n="";2==t?n="P":2<t&&(n="P[1-"+t+"]");var s="([\\da-o])x?A?("+n+")?(C{(C|P)?})?(T{(C|P)?})?(B({\\d*(L|HL|F|HF)?\\d*})?)?(S{-?\\d+(.\\d+)?(,-?\\d+(.\\d+)?,-?\\d+(.\\d+)?,-?\\d+(.\\d+)?)?})?(D{\\d*\\.?\\d*})?",o="\\[("+s+")+\\]",r=s+"|"+o,i="\\(("+r+"),("+r+")\\)",l="("+r+"|"+i+")",h="<"+l+"(\\|"+l+")+>",u="^("+h+")+|("+l+")+\\*?$",p="<"+l+"+(\\|"+l+"+)+>";if(H=new RegExp(s,"g"),F=new RegExp(o,"g"),m=new RegExp(r,"g"),J=new RegExp(i,"g"),G=new RegExp(l,"g"),k=new RegExp(h,"g"),x=new RegExp(u,"g"),b=new RegExp(p,"g"),z.match(b)==z){for(var g="",d=z.split("|"),c=[],f=0;f<d.length;f++)c.push(d[f].match(G));for(var f=0;f<c[0].length;f++){g+="<";for(var y=0;y<c.length;y++)g+=c[y][f],y<c.length-1&&(g+="|");g+=">"}z=g}if("*"==z.charAt(z.length-1)){var g=z.slice(0,-1),v=g.match(J);if(null!==v){for(var f=0;f<v.length;f++)g+="("+v[f].match(m).reverse().join(",")+")";z=g}}z.match(x)==z?(ct.validSyntax=!0,ct.multiplex=!!z.match(F),ct.sync=!!z.match(J),ct.pass=!!z.match(k),ct.numJugglers=t):ct.errorMessage="Invalid syntax"}(),function(){void 0===u&&(u={});ct.validationOnly=void 0!==u.validationOnly&&u.validationOnly,ct.beatDuration=void 0===u.beatDuration?.2:u.beatDuration,ct.dwellDuration=void 0===u.dwellRatio?.5*ct.beatDuration:ct.beatDuration*u.dwellRatio,ct.numStepsPerBeat=void 0===u.numStepsPerBeat?Math.floor(200*ct.beatDuration):u.numStepsPerBeat,ct.matchVelocity=void 0!==u.matchVelocity&&u.matchVelocity,ct.dwellCatchScale=void 0===u.dwellCatchScale?.05:u.dwellCatchScale,ct.dwellTossScale=void 0===u.dwellTossScale?.05:u.dwellTossScale,ct.emptyTossScale=void 0===u.emptyTossScale?.05:u.emptyTossScale,ct.emptyCatchScale=void 0===u.emptyCatchScale?.05:u.emptyCatchScale,ct.armAngle=void 0===u.armAngle?.1:u.armAngle,"L"==u.startingHand||"LEFT"==u.startingHand?ct.startingHand=0:ct.startingHand=1;void 0===u.props?ct.props=[{type:"ball",radius:.05,C:.95}]:ct.props=u.props;if(void 0===u.dwellPath)ct.dwellPath=[[{x:.3,y:0,z:0,rotation:{x:4,y:0,z:-1,th:Math.PI/2},empty:!1},{x:.1,y:0,z:0,rotation:{x:4,y:0,z:1,th:Math.PI/2},empty:!1}]];else{var t=u.dwellPath.split(").").map(function(t,e,a){return e<a.length-1?t+")":t});ct.dwellPath=[];for(var e=0;e<t.length;e++){-1==t[e].indexOf("e")&&(t[e]+="e");var a,n=t[e].split("e")[0].match(/\(-?\d+(\.\d+)?(,-?\d+(\.\d+)?)?(,-?\d+(\.\d+)?)?(,\{-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?\})?\)/g),s=t[e].split("e")[1].match(/\(-?\d+(\.\d+)?(,-?\d+(\.\d+)?)?(,-?\d+(\.\d+)?)?(,\{-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?\})?\)/g);if(a=null==s?(s=[],0):s.reduce(function(t,e){return t+e}).length,n.reduce(function(t,e){return t+e}).length==t[e].split("e")[0].length&&a==t[e].split("e")[1].length){function o(t,e,a){var n,s,o=t.match(/\(-?\d+(\.\d+)?(,-?\d+(\.\d+)?)?(,-?\d+(\.\d+)?)?/g)[0].match(/-?\d+(\.\d+)?/g),r=t.match(/\{-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?\}/g);return r&&(n=r[0].match(/-?\d+(\.\d+)?/g)),s=n?{x:parseFloat(n[0]),y:parseFloat(n[1]),z:parseFloat(n[2]),th:parseFloat(n[3])}:"club"==ct.props[0].type?{x:4,y:0,z:0==e?-1:1,th:Math.PI/2+(0==e?.5:-.7)}:"ring"==ct.props[0].type?{x:0,y:1,z:0,th:Math.PI/2}:{x:1,y:0,z:0,th:0},{x:parseFloat(o[0])/100,y:o[1]?parseFloat(o[1])/100:0,z:o[2]?parseFloat(o[2])/100:0,rotation:s,empty:a}}ct.dwellPath.push(n.map(function(t,e){return o(t,e,!1)}).concat(s.map(function(t,e){return o(t,e,!0)})))}else ct.errorMessage="Invalid custom dwell path"}}void 0===u.surfaces?ct.surfaces=[{position:{x:0,y:0,z:0},normal:{x:0,y:1,z:0},scale:5,color:"grey"}]:ct.surfaces=u.surfaces;if(ct.jugglers=[],void 0===u.jugglers||ct.numJugglers!=u.jugglers.length)if(1==ct.numJugglers)ct.jugglers.push({position:{x:0,z:-2*e},rotation:e*Math.PI,color:"grey"});else for(var e=0;e<ct.numJugglers;e++){var r=2*e*Math.PI/ct.numJugglers;ct.jugglers.push({position:{x:Math.cos(r),z:Math.sin(r)},rotation:r-Math.PI/2,color:"grey"})}else for(var e=0;e<u.jugglers.length;e++)ct.jugglers.push({position:u.jugglers[e].position,rotation:u.jugglers[e].rotation,color:u.jugglers[e].color});for(var e=0;e<ct.surfaces.length;e++){var i,l=ct.surfaces[e];normalize(l.normal),i=0==l.normal.x&&0==l.normal.z?{x:1,y:0,z:0}:{x:-l.normal.z,y:0,z:l.normal.x};var h=cross(l.normal,i);normalize(i),multiply(i,l.scale),normalize(h),multiply(h,l.scale),l.axis1=i,l.axis2=h}}(),ct.errorMessage?ct:(function(){ct.beats=ct.pass?z.match(k):z.match(G),console.log("siteswap.beats",ct.beats);for(var t=0;t<ct.beats.length;t++)ct.beats[t].match(J)&&(ct.beats.splice(t+1,0,"(0,0)"),t++);var n=0;{if(ct.beats.map(function(t){if(t.match(k))for(var e=t.split("|"),a=0;a<e.length;a++)0==a&&(e[a]=e[a].substr(1)),a==e.length-1&&(e[a]=e[a].substr(0,e[a].length-1)),n+=M(e[a]);else n+=M(t)}),!(n/ct.beats.length%1==0&&0<n/ct.beats.length))return ct.errorMessage="Cannot determine number of props";ct.numProps=n/ct.beats.length}for(;ct.props.length<ct.numProps;)ct.props.push(cloneObject(ct.props.last()));for(;ct.props.length>ct.numProps;)ct.props.pop();ct.tosses=[];for(var e=0,t=0;t<ct.beats.length;t++){var a=[];e=L(a,ct.beats[t],0,void 0,void 0,e),console.log("ss",z,"beat #"+t,"tosses",a,"dwellpath",e),ct.tosses.push(a),t==ct.beats.length-1&&0!=e&&(t=-1)}console.log("final tosses",ct.tosses);for(var t=ct.maxHeight=0;t<ct.tosses.length;t++)for(var s=0;s<ct.tosses[t].length;s++)ct.tosses[t][s].numBeats>ct.maxHeight&&(ct.maxHeight=ct.tosses[t][s].numBeats);for(var o=[],t=0;t<ct.numProps;t++)o.push(t);ct.states=[],ct.propOrbits=[],ct.stateDiagram=[];for(var r=[],s=0;s<ct.numJugglers;s++){r.push([[],[]]);for(var i=0;i<ct.maxHeight;i++)r[s][0].push(void 0),r[s][1].push(void 0)}var l=!1,h=!1,u=0,p=0,g=ct.startingHand;for(;!l;){ct.stateDiagram.push([1==g?"R":"L"]),0==u&&h&&(ct.stateDiagram[p][0]+="*");for(var d=cloneObject(ct.propOrbits),c=[],s=0;s<ct.numJugglers;s++){var f=r[s][0].shift();if(f)for(var i=0;i<f.length;i++)c.push({propId:f[i],juggler:s,hand:0});var y=r[s][1].shift();if(y)for(var i=0;i<y.length;i++)c.push({propId:y[i],juggler:s,hand:1});r[s][0].push(void 0),r[s][1].push(void 0)}for(var v="",s=0;s<ct.tosses[u%ct.tosses.length].length;s++){for(var m=ct.tosses[u%ct.tosses.length][s],x=null==m.hand?g:m.hand,b=m.crossing?1-x:x,w=void 0,i=0;i<c.length;i++)if(c[i].juggler==m.juggler&&c[i].hand==x){if(0==m.numBeats)return ct.errorMessage="Prop landing on 0 toss at beat "+u;w=c.splice(i,1)[0].propId;break}if(null==w&&0<m.numBeats&&(w=o.shift()),null==w&&0<m.numBeats)return ct.errorMessage="No prop available to toss at beat "+u;v+=(void 0===w?"X":w)+"-"+m.siteswapStr,s<ct.tosses[u%ct.tosses.length].length-1&&(v+=","),0<m.numBeats&&(d[w]||(d[w]=[]),d[w].push({beat:u,numBeats:m.numBeats,juggler:m.juggler,hand:x,numBounces:m.numBounces,bounceType:m.bounceType,bounceOrder:m.bounceOrder,numSpins:m.numSpins,dwellPathIx:m.dwellPathIx,dwellDuration:m.dwellDuration,tossType:m.tossType,catchType:m.catchType,tossOrientation:m.tossOrientation,rotationAxis:m.rotationAxis,hold:m.hold}),null==r[m.targetJuggler][b][m.numBeats-1]?r[m.targetJuggler][b][m.numBeats-1]=[w]:r[m.targetJuggler][b][m.numBeats-1].push(w))}if(ct.stateDiagram[p].push(v),r[0][0].map(function(t){null==t?ct.stateDiagram[p].push("X"):ct.stateDiagram[p].push(t.reduce(function(t,e){return t.toString()+e.toString()}))}),r[0][1].map(function(t){null==t?ct.stateDiagram[p].push("X"):ct.stateDiagram[p].push(t.reduce(function(t,e){return t.toString()+e.toString()}))}),h&&u%ct.tosses.length==0&&arraysEqual(ct.states[0],r)?l=!0:(ct.states.push(cloneObject(r)),ct.propOrbits=d),0!=o.length||(u+1)%ct.tosses.length!=0||h||(h=!0,u=-1,ct.states=[],ct.propOrbits=[]),p++,g=1-g,1e3<++u)return ct.errorMessage="Pattern took more than 1000 beats to repeat states"}for(var t=0;t<ct.tosses.length;t++)for(var s=0;s<ct.tosses[t].length;s++)0<ct.tosses[t][s].numBeats&&ct.tosses[t][s].dwellDuration>=ct.beatDuration*ct.tosses[t][s].numBeats&&(ct.errorMessage="Cannot have a '1' toss with a dwellRatio >= 1");ct.numSteps=ct.states.length*ct.numStepsPerBeat,ct.validPattern=!0}(),ct.errorMessage||(ct.validationOnly||function(){try{bt={};for(var t=[],e=0;e<ct.numProps;e++)t.push([]);for(var a=[],e=0;e<ct.numProps;e++)a.push([]);for(var n=[],e=0;e<ct.numJugglers;e++)n.push([[],[]]);for(var s=[],e=0;e<ct.numJugglers;e++)s.push([[],[]]);for(var o=0;o<ct.numSteps;o++){for(var r=[],e=0;e<ct.numJugglers;e++)r.push([void 0,void 0]);for(var i=Math.floor(o*ct.states.length/ct.numSteps),l=ct.beatDuration*o*ct.states.length/ct.numSteps,h=0;h<ct.numProps;h++){for(var u=void 0,p=void 0,g=void 0,d=!1,e=0;e<ct.propOrbits[h].length;e++)!d&&(e==ct.propOrbits[h].length-1||ct.propOrbits[h][e].beat<=i&&ct.propOrbits[h][e+1].beat>i)&&(u=ct.propOrbits[h].getPreviousCyclic(e),p=ct.propOrbits[h][e],g=ct.propOrbits[h].getNextCyclic(e),d=!0);var c=p.beat*ct.beatDuration+p.dwellDuration,f=g.beat*ct.beatDuration;f<c&&f<=l?f+=ct.beatDuration*ct.states.length:f<c&&l<f&&(c-=ct.beatDuration*ct.states.length);var y=u.beat*ct.beatDuration+u.dwellDuration,v=p.beat*ct.beatDuration;if(v<y&&v<=l?v+=ct.beatDuration*ct.states.length:v<y&&l<v&&(y-=ct.beatDuration*ct.states.length),l<c){var m=[],x=[];if(ct.multiplex)for(var e=0;e<ct.propOrbits.length;e++)if(e!=h)for(j=0;j<ct.propOrbits[e].length;j++){var b=ct.propOrbits[e][j];if(p.beat==b.beat&&p.juggler==b.juggler&&p.hand==b.hand){var w=j==ct.propOrbits[e].length-1?ct.propOrbits[e][0]:ct.propOrbits[e][j+1],z=0==j?ct.propOrbits[e][ct.propOrbits[e].length-1]:ct.propOrbits[e][j-1],M=b.beat*ct.beatDuration+b.dwellDuration,P=w.beat*ct.beatDuration;P<M&&P<=l?P+=ct.beatDuration*ct.states.length:P<M&&l<P&&(M-=ct.beatDuration*ct.states.length);var C=z.beat*ct.beatDuration+z.dwellDuration,O=b.beat*ct.beatDuration;O<C&&O<=l?O+=ct.beatDuration*ct.states.length:O<C&&l<O&&(C-=ct.beatDuration*ct.states.length),m.push(ft(vt(yt(ct.dwellPath[b.dwellPathIx]),b.juggler,b.hand,1),vt(yt(ct.dwellPath[w.dwellPathIx]),w.juggler,w.hand,0),P-M,0,{numBounces:b.numBounces,bounceType:b.bounceType,bounceOrder:b.bounceOrder,R:ct.props[e].radius,C:ct.props[e].C})),x.push(ft(vt(yt(ct.dwellPath[z.dwellPathIx]),z.juggler,z.hand,1),vt(yt(ct.dwellPath[b.dwellPathIx]),b.juggler,b.hand,0),O-C,O-C,{numBounces:z.numBounces,bounceType:z.bounceType,bounceOrder:z.bounceOrder,R:ct.props[e].radius,C:ct.props[e].C}))}}m.push(ft(vt(yt(ct.dwellPath[p.dwellPathIx]),p.juggler,p.hand,1),vt(yt(ct.dwellPath[g.dwellPathIx]),g.juggler,g.hand,0),f-c,0,{numBounces:p.numBounces,bounceType:p.bounceType,bounceOrder:p.bounceOrder,R:ct.props[h].radius,C:ct.props[h].C})),x.push(ft(vt(yt(ct.dwellPath[u.dwellPathIx]),u.juggler,u.hand,1),vt(yt(ct.dwellPath[p.dwellPathIx]),p.juggler,p.hand,0),v-y,v-y,{numBounces:u.numBounces,bounceType:u.bounceType,bounceOrder:u.bounceOrder,R:ct.props[h].radius,C:ct.props[h].C}));var T={dx:0,dy:0,dz:0,x:0,y:0,z:0},S={dx:0,dy:0,dz:0,x:0,y:0,z:0};for(e=0;e<x.length;e++)T.dx+=x[e].dx/x.length,T.dy+=x[e].dy/x.length,T.dz+=x[e].dz/x.length,T.x+=x[e].x/x.length,T.y+=x[e].y/x.length,T.z+=x[e].z/x.length,S.dx+=m[e].dx/x.length,S.dy+=m[e].dy/x.length,S.dz+=m[e].dz/x.length,S.x+=m[e].x/x.length,S.y+=m[e].y/x.length,S.z+=m[e].z/x.length;var D=1-(c-l)/p.dwellDuration,B=vt(yt(ct.dwellPath[p.dwellPathIx]),p.juggler,p.hand,D,T,S,ct.dwellCatchScale,ct.dwellTossScale),I=vt(yt(ct.dwellPath[p.dwellPathIx]),p.juggler,p.hand,0),A={x:T.x-I.x,y:T.y-I.y,z:T.z-I.z};B.x+=(1-D)*A.x,B.y+=(1-D)*A.y,B.z+=(1-D)*A.z;var R=Math.atan2(-T.dx,-T.dy),E=Math.atan2(S.dx,S.dy);"claw"==p.tossType?E-=Math.PI:"penguin"==p.tossTypeId&&(E-=2*Math.PI),"claw"==p.catchType?R-=Math.PI:"penguin"==p.catchType&&(R-=2*Math.PI),B.angle=R+D*(E-R),1==p.hand&&(B.angle*=-1),B.dwell=!0,t[h].push(B),null==r[p.juggler][p.hand]&&(r[p.juggler][p.hand]=B);var H=xt(u.tossOrientation,u.rotationAxis,ct.jugglers[u.juggler].rotation,2*u.numSpins*Math.PI,u.hand),F=xt(p.tossOrientation,p.rotationAxis,ct.jugglers[p.juggler].rotation,0,p.hand);H.slerp(F,D),a[h].push(H)}else if(p.hold){var J=[ct.dwellPath[p.dwellPathIx].last(),ct.dwellPath[g.dwellPathIx][0]],G=p.numBeats*ct.beatDuration-p.dwellDuration,k=ft(vt(yt(ct.dwellPath[p.dwellPathIx]),p.juggler,p.hand,1),vt(yt(ct.dwellPath[g.dwellPathIx]),g.juggler,g.hand,0),G,0),L=ft(vt(yt(ct.dwellPath[p.dwellPathIx]),p.juggler,p.hand,1),vt(yt(ct.dwellPath[g.dwellPathIx]),g.juggler,g.hand,0),G,G);B=vt(yt(J),p.juggler,p.hand,(l-c)/(f-c),k,L,ct.emptyTossScale,ct.emptyCatchScale);var R=Math.atan2(-k.dx,-k.dy),E=Math.atan2(L.dx,L.dy);"claw"==p.tossType?E-=Math.PI:"penguin"==p.tossTypeId&&(E-=2*Math.PI),"claw"==p.catchType?R-=Math.PI:"penguin"==p.catchType&&(R-=2*Math.PI),B.angle=R+(l-(c-p.dwellDuration))/(f-(c-p.dwellDuration))*(E-R),1==p.hand&&(B.angle*=-1),B.dwell=!0,t[h].push(B),null==r[p.juggler][p.hand]&&(r[p.juggler][p.hand]=B);var H=xt(p.tossOrientation,p.rotationAxis,ct.jugglers[p.juggler].rotation,0,p.hand),F=xt(g.tossOrientation,g.rotationAxis,ct.jugglers[g.juggler].rotation,0,g.hand);H.slerp(F,(l-(c-p.dwellDuration))/(f-(c-p.dwellDuration))),a[h].push(H)}else{var G=f-c,D=l-c;(B=ft(vt(yt(ct.dwellPath[p.dwellPathIx]),p.juggler,p.hand,1),vt(yt(ct.dwellPath[g.dwellPathIx]),g.juggler,g.hand,0),G,D,{numBounces:p.numBounces,bounceType:p.bounceType,bounceOrder:p.bounceOrder,R:ct.props[h].radius,C:ct.props[h].C})).dwell=!1,t[h].push(B);var q=2*p.numSpins*Math.PI,N=0+D/G*(q-0);a[h].push(xt(p.tossOrientation,p.rotationAxis,ct.jugglers[p.juggler].rotation,N,p.hand))}}for(var V=0;V<ct.numJugglers;V++)for(var Q=0;Q<=1;Q++){if(null==r[V][Q]){for(var g=void 0,U=void 0,X=void 0,$=void 0,K=void 0,W=void 0,Y=void 0,Z=void 0,_=void 0,tt=void 0,et=void 0,at=void 0,nt=void 0,st=void 0,h=0;h<ct.propOrbits.length;h++)for(var ot=0;ot<ct.propOrbits[h].length;ot++)ct.propOrbits[h][ot].juggler==V&&ct.propOrbits[h][ot].hand==Q&&((null==U||ct.propOrbits[h][ot].beat<U.beat)&&(U=ct.propOrbits[h][ot],K=h,W=ot),ct.propOrbits[h][ot].beat>i&&(null==g||ct.propOrbits[h][ot].beat<g.beat)&&(g=ct.propOrbits[h][ot],Y=h,Z=ot),(null==$||ct.propOrbits[h][ot].beat>$.beat)&&($=ct.propOrbits[h][ot],_=h,tt=ot),ct.propOrbits[h][ot].beat<=i&&(null==X||ct.propOrbits[h][ot].beat>X.beat)&&(X=ct.propOrbits[h][ot],et=h,at=ot));if(null==g&&(g=U,Y=K,Z=W),null==X&&(X=$,et=_,at=tt),null==g&&null==X){var B=vt([{x:.2,y:0,z:0}],V,Q,0);B.angle=0}else{nt=0==Z?ct.propOrbits[Y].last():ct.propOrbits[Y][Z-1],st=at==ct.propOrbits[et].length-1?ct.propOrbits[et][0]:ct.propOrbits[et][at+1];var rt=g.beat*ct.beatDuration;rt<l&&(rt+=ct.beatDuration*ct.states.length);var it=X.beat*ct.beatDuration+X.dwellDuration;l<it&&(it-=ct.beatDuration*ct.states.length);var lt=st.beat*ct.beatDuration;lt<it&&(lt+=ct.beatDuration*ct.states.length);var ht=nt.beat*ct.beatDuration+nt.dwellDuration;rt<ht&&(ht-=ct.beatDuration*ct.states.length);for(var k=ft(vt(yt(ct.dwellPath[X.dwellPathIx]),X.juggler,X.hand,1),vt(yt(ct.dwellPath[st.dwellPathIx]),st.juggler,st.hand,0),X.numBeats*ct.beatDuration-X.dwellDuration,0,{numBounces:X.numBounces,bounceType:X.bounceType,bounceOrder:X.bounceOrder,R:ct.props[et].radius,C:ct.props[et].C}),L=ft(vt(yt(ct.dwellPath[nt.dwellPathIx]),nt.juggler,nt.hand,1),vt(yt(ct.dwellPath[g.dwellPathIx]),g.juggler,g.hand,0),nt.numBeats*ct.beatDuration-nt.dwellDuration,nt.numBeats*ct.beatDuration-nt.dwellDuration,{numBounces:nt.numBounces,bounceType:nt.bounceType,bounceOrder:nt.bounceOrder,R:ct.props[Y].radius,C:ct.props[Y].C}),D=(l-it)/(rt-it),ut=[],pt=ct.dwellPath[X.dwellPathIx],e=0;e<pt.length;e++)pt[e].empty&&(0==ut.length&&ut.push(pt[e-1]),ut.push(pt[e]));0==ut.length&&ut.push(pt.last()),ut.push(ct.dwellPath[g.dwellPathIx][0]);var B=vt(ut,X.juggler,X.hand,D,k,L,ct.emptyTossScale,ct.emptyCatchScale),gt=vt(ut,X.juggler,X.hand,1),dt={x:L.x-gt.x,y:L.y-gt.y,z:L.z-gt.z};B.x+=D*dt.x,B.y+=D*dt.y,B.z+=D*dt.z;var R=Math.atan2(-L.dx,-L.dy),E=Math.atan2(k.dx,k.dy);"claw"==X.tossType?E-=Math.PI:"penguin"==X.tossType&&(E-=2*Math.PI),"claw"==g.catchType?R-=Math.PI:"penguin"==g.catchType&&(R-=2*Math.PI),B.angle=E+D*(R-E),1==Q&&(B.angle*=-1)}r[V][Q]=B}n[V][Q].push(r[V][Q]),s[V][Q].push(mt({x:ct.jugglers[V].position.x+Math.cos(ct.jugglers[V].rotation)*(0==Q?-1:1)*.225,y:1.425,z:ct.jugglers[V].position.z+Math.sin(ct.jugglers[V].rotation)*(0==Q?-1:1)*.225},r[V][Q],.45,ct.armAngle,Q))}}ct.propPositions=t,ct.propRotations=a,ct.jugglerHandPositions=n,ct.jugglerElbowPositions=s,ct.collision=function(){for(var t,e,a=0;a<ct.propPositions.length;a++){t=ct.props[a].radius;for(var n=0;n<ct.propPositions[a].length;n++)for(var s=a+1;s<ct.propPositions.length;s++)if(e=ct.props[a].radius,Math.sqrt(Math.pow(ct.propPositions[a][n].x-ct.propPositions[s][n].x,2)+Math.pow(ct.propPositions[a][n].y-ct.propPositions[s][n].y,2)+Math.pow(ct.propPositions[a][n].z-ct.propPositions[s][n].z,2))<=t+e)return!0}return!1}()}catch(t){ct.errorMessage=t.message}}(),window.getTosses=L),ct);function L(n,t,s,e,o,r){if(t.match(k))(l=t.match(G)).map(function(t,e){r=L(n,t,e,void 0,void 0,r)});else if(t.match(J)){var a=(l=t.split(","))[0].substr(1),i=l[1].substr(0,l[1].length-1);r=L(n,a,s,!0,0,r),r=L(n,i,s,!0,1,r)}else if(t.match(F)){var l;(l=t.match(H)).map(function(t,e,a){r=L(n,t,s,void 0,o,r),e<a.length-1&&(0==r?r=ct.dwellPath.length-1:r--)})}else{var h=97<=t[0].charCodeAt(0)&&t[0].charCodeAt(0)<=119?t[0].charCodeAt(0)-87:parseInt(t[0]),u=s,p=t.indexOf("P"),g=!1;0<p&&"}"!=t[p+1]&&(u=2<ct.numJugglers?parseInt(t[p+1])-1:1-s,g=!0);var d,c=t.indexOf("D");d=0<c?ct.beatDuration*parseFloat(t.substring(c+2,t.indexOf("}"))):ct.dwellDuration;var f=0,y=[],v=t.indexOf("B");if(0<v){var m;if(m=isNaN(t[v+3])?isNaN(t[v+4])?2:4:3,"{"==t[v+1]&&null!=m){f=parseInt(t[v+m]);for(var x=v+m+1;x<t.length&&!isNaN(t[x]);x++){var b=parseInt(t[x]);if(b>=ct.surfaces.length)throw{message:"Bounce surface index out of range"};y.push(b)}}else f=1,y=[0];if(y.length<f){var w=y.length;for(x=0;x<f-w;x++)y.push(0)}}var z=void 0;if(0<f)if(t.match("HF"))z="HF";else if(t.match("HL"))z="HL";else if(t.match("F"))z="F";else if(t.match("L"))z="L";else{var M=ct.beatDuration*h-d;z=M<.68?"HF":M<1.25?"F":"L"}var P=t.indexOf("T"),C="standard";if(0<P){var O=t.substring(P+2,t.indexOf("}",P));O.match("C")?C="claw":O.match("P")&&(O="penguin")}var T=t.indexOf("C"),j="standard";if(0<T){var S=t.substring(T+2,t.indexOf("}",T));S.match("C")?j="claw":S.match("P")&&(j="penguin")}var D,B=h%2==1;1<t.length&&"x"==t[1]&&(B=!B),"R"==t[0]?o=1:"L"==t[0]&&(o=0);var I=normalize({x:.1,y:.1,z:1}),A=t.indexOf("S");if(0<A){var R=t.substring(A+2,t.indexOf("}",A)).match(/-?\d+(\.\d+)?/g);D=parseFloat(R[0]),1<R.length&&(I.x=parseFloat(R[1]),I.y=parseFloat(R[2]),I.z=parseFloat(R[3]),normalize(I))}else{var E=!0;ct.props.forEach(function(t){"ball"!=t.type&&(E=!1)}),E?D=0:(D=Math.floor(h/2)+.2,g&&(D+=.1))}n.push({juggler:s,targetJuggler:u,hand:o,crossing:B,numBeats:h,siteswapStr:t,numBounces:f,bounceOrder:y,bounceType:z,numSpins:D,dwellPathIx:r,dwellDuration:d,tossType:C,catchType:j,tossOrientation:I,rotationAxis:{x:1,y:0,z:0},hold:2==h&&!B&&-1==t.indexOf("A")}),0<h&&(r==ct.dwellPath.length-1?r=0:r++)}return r}function ft(t,e,a,n,s){a=parseFloat(a.toFixed(2)),null==s&&(s={}),s.bounceType||(s.bounceType="L"),s.dt||(s.dt=.01),s.eps||(s.eps=.01),s.dv||(s.dv=.01),s.numBounces||(s.numBounces=0),s.bounceOrder||(s.bounceOrder=[0]),s.G||(s.G=-9.8),s.C||(s.C=.95),s.tries||(s.tries=1e4),s.R||(s.R=.1);var o=JSON.stringify({p0:t,p1:e,T:a,options:s});if(0==s.numBounces)return{x:t.x+(e.x-t.x)*n/a,y:t.y+(e.y-t.y-.5*s.G*a*a)*n/a+.5*s.G*n*n,z:t.z+(e.z-t.z)*n/a,dx:(e.x-t.x)/a,dy:(e.y-t.y-.5*s.G*a*a)/a+s.G*n,dz:(e.z-t.z)/a};if(null==bt[o]){var r={p0:t,pT:e,minT:a,maxT:a,R:s.R,C:s.C,dt:s.dt,G:-9.8,numBounces:s.numBounces,surfaceBounceOrder:s.bounceOrder,tossSign:"L"==s.bounceType||"HL"==s.bounceType?1:-1,catchSign:"L"==s.bounceType||"HF"==s.bounceType?1:-1,surfaces:ct.surfaces};if(ga=new BounceGA({maxGenerations:500,populationSize:50,mutationChance:.7,mutationScale:5,initialScale:40,fitnessThreshold:.05,noGA:!1},r),ga.evolve(),!ga.ableToFindSolution)throw{message:"Unable to calculate bounce path"};var i=ga.getBouncePath(ga.fittestMembers[ga.fittestMembers.length-1].v);bt[o]={path:i.path,velocities:i.velocities}}var l=bt[o];return{x:l.path[Math.floor((l.path.length-1)*n/a)].x,y:l.path[Math.floor((l.path.length-1)*n/a)].y,z:l.path[Math.floor((l.path.length-1)*n/a)].z,dx:l.velocities[Math.floor((l.velocities.length-1)*n/a)].x,dy:l.velocities[Math.floor((l.velocities.length-1)*n/a)].y,dz:l.velocities[Math.floor((l.velocities.length-1)*n/a)].z}}function yt(t){for(var e=[],a=0;a<t.length;a++)t[a].empty||e.push(t[a]);return e}function vt(t,e,a,n,s,o,r,i,l){0==a&&(s||o)&&(s.dx*=-1,o.dx*=-1);var h=Bezier.interpolateBezierSpline(t,n,s,o,r,i,l);return{x:ct.jugglers[e].position.x+(0==a?-1:1)*h.x*Math.cos(ct.jugglers[e].rotation)-(h.z-.4125)*Math.sin(ct.jugglers[e].rotation),y:1.0125+h.y,z:ct.jugglers[e].position.z+(0==a?-1:1)*h.x*Math.sin(ct.jugglers[e].rotation)+(h.z-.4125)*Math.cos(ct.jugglers[e].rotation)}}function mt(t,e,a,n,s){n*=-1;var o={};o.x=e.x-t.x,o.y=e.y-t.y,o.z=e.z-t.z;var r={};r.x=Math.sqrt(o.x*o.x+o.z*o.z),r.y=o.y,r.z=0;var i=Math.atan2(o.z,o.x),l=Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z);2*a<l&&(a=l/2);var h={};h.x=r.y/l,h.y=-r.x/l;var u={x:h.z=0,y:0};u.z=1==s?-1:1;var p=Math.sqrt(a*a-.25*l*l),g={};g.x=r.x/2+p*h.x*Math.cos(n)+p*u.x*Math.sin(n),g.y=r.y/2+p*h.y*Math.cos(n)+p*u.y*Math.sin(n),g.z=r.z/2+p*h.z*Math.cos(n)+p*u.z*Math.sin(n);var d={};d.x=g.x*Math.cos(i)-g.z*Math.sin(i),d.y=g.y,d.z=g.x*Math.sin(i)+g.z*Math.cos(i);var c={};return c.x=d.x+t.x,c.y=d.y+t.y,c.z=d.z+t.z,c}function xt(t,e,a,n,s){T=new THREE.Vector3(t.x,t.y,t.z),R=new THREE.Vector3(e.x,e.y,e.z),C=new THREE.Vector3(0,-1,0),0==s&&(T.x*=-1,R.x*=-1);var o=new THREE.Quaternion;o.setFromAxisAngle(new THREE.Vector3(0,-1,0),a),T.applyQuaternion(o);var r=new THREE.Quaternion;r.setFromAxisAngle(new THREE.Vector3(T.z,0,-T.x),Math.acos(T.y));var i=new THREE.Quaternion;i.setFromAxisAngle(new THREE.Vector3(0,1,0),Math.acos(-R.z*T.x+R.x*T.z)),R.applyQuaternion(i);var l=new THREE.Quaternion;l.setFromAxisAngle(R,n);new THREE.Quaternion;return(new THREE.Quaternion).multiplyQuaternions(r,l)}}}("undefined"==typeof exports?this.SiteswapJS={}:exports);