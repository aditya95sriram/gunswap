function getURLQueryStringParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?null:decodeURIComponent(c[1].replace(/\+/g," "))}function cloneObject(a){var b=a instanceof Array?[]:{};for(var c in a)"clone"!=c&&(a[c]&&"object"==typeof a[c]?b[c]=cloneObject(a[c]):b[c]=a[c]);return b}function arraysEqual(a,b){if(!(a instanceof Array&&b instanceof Array))return!1;if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]instanceof Array||b[c]instanceof Array){var d=arraysEqual(a[c],b[c]);if(!d)return!1}else if(a[c]!=b[c])return!1;return!0}function cross(a,b){return{x:a.y*b.z-a.z*b.y,y:a.z*b.x-a.x*b.z,z:a.x*b.y-a.y*b.x}}function dot(a,b){return a.x*b.x+a.y*b.y+a.z*b.z}function magnitude(a){return Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z)}function normalize(a){var b=magnitude(a);return a.x=a.x/b,a.y=a.y/b,a.z=a.z/b,a}function multiply(a,b){return a.x*=b,a.y*=b,a.z*=b,a}function add(a,b){return a.x+=b.x,a.y+=b.y,a.z+=b.z,a}function sub(a,b){return a.x-=b.x,a.y-=b.y,a.z-=b.z,a}function negate(a){return multiply(a,-1),a}function BounceGA(a,b){if(this.gaConfig=a,this.fitnessConfig=b,void 0===b.axis1)for(var c=0;c<this.fitnessConfig.surfaces.length;c++){var d=this.fitnessConfig.surfaces[c];normalize(d.normal);var e;e=0==d.normal.x&&0==d.normal.z?{x:1,y:0,z:0}:{x:-d.normal.z,y:0,z:d.normal.x};var f=cross(d.normal,e);normalize(e),normalize(f),multiply(e,d.scale),multiply(f,d.scale),d.axis1=e,d.axis2=f}this.simple=!1,1==b.numBounces&&1==b.surfaces.length&&0==b.surfaces[0].normal.x&&0==b.surfaces[0].normal.z&&b.minT==b.maxT&&(this.simple=!0),this.generations=0,this.rankedPopulation=[],this.fittestMembers=[],this.ableToFindSolution=void 0}Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]}),Array.prototype.getIndexCyclic||(Array.prototype.getIndexCyclic=function(a){return this[a%this.length]}),Array.prototype.getNextCyclic||(Array.prototype.getNextCyclic=function(a){return a%=this.length,this.length-1==a?this[0]:this[a+1]}),Array.prototype.getPreviousCyclic||(Array.prototype.getPreviousCyclic=function(a){return a%=this.length,0==a?this[this.length-1]:this[a-1]}),window.randomColors=["red","blue","green","black","yellow","purple"],BounceGA.prototype.getBouncePath=function(a){var b=cloneObject(this.fitnessConfig.p0),c=cloneObject(a),d=[],e=[];d.push(cloneObject(b)),e.push(cloneObject(c));for(var f=0;f<this.fitnessConfig.surfaces.length;f++)this.fitnessConfig.surfaces[f].bounces=0,this.fitnessConfig.surfaces[f].colliding=!1;for(var g=0,h=[],i=[],j=0;j<=this.fitnessConfig.maxT;j+=this.fitnessConfig.dt){add(b,multiply(cloneObject(c),this.fitnessConfig.dt)),c.y+=this.fitnessConfig.G*this.fitnessConfig.dt,d.push(cloneObject(b)),e.push(cloneObject(c));for(var f=0;f<this.fitnessConfig.surfaces.length;f++){var k=this.fitnessConfig.surfaces[f],l=k.normal.x*b.x+k.normal.y*b.y+k.normal.z*b.z-k.normal.x*k.position.x-k.normal.y*k.position.y-k.normal.z*k.position.z;if(Math.abs(l)<=this.fitnessConfig.R&&Math.abs(dot(sub(cloneObject(b),k.position),normalize(cloneObject(k.axis1))))<=k.scale&&Math.abs(dot(sub(cloneObject(b),k.position),normalize(cloneObject(k.axis2))))<=k.scale&&!k.colliding){k.colliding=!0,k.bounces++,h.push(f),g++;var m=(new THREE.Vector3).copy(k.normal),m=cloneObject(k.normal);multiply(m,dot(c,k.normal)),multiply(m,2*this.fitnessConfig.C),negate(m),add(c,m)}else Math.abs(l)>this.fitnessConfig.R&&k.colliding&&(k.colliding=!1)}if(j>=this.fitnessConfig.minT||j+this.fitnessConfig.dt>this.fitnessConfig.maxT){var n=!0;this.fitnessConfig.surfaceBounceOrder&&h.toString()!=this.fitnessConfig.surfaceBounceOrder.toString()&&(n=!1);var o=!1;g==this.fitnessConfig.numBounces&&(o=!0),n&&o&&(1==this.fitnessConfig.catchSign&&c.y>=0||this.fitnessConfig.catchSign==-1&&c.y<=0||void 0==this.fitnessConfig.catchSign)&&(1==this.fitnessConfig.tossSign&&a.y>=0||this.fitnessConfig.tossSign==-1&&a.y<=0||void 0==this.fitnessConfig.tossSign)&&i.push({pT:cloneObject(b),T:j,actualpT:this.fitnessConfig.pT})}}return i.length>0?(i.sort(function(a,b){return magnitude(sub(cloneObject(a.pT),a.actualpT))-magnitude(sub(cloneObject(b.pT),a.actualpT))}),{path:d.splice(0,i[0].T/this.fitnessConfig.dt),velocities:e.splice(0,i[0].T/this.fitnessConfig.dt),T:i[0].T}):{path:void 0,velocities:void 0,T:void 0}},BounceGA.prototype.generateMember=function(a){var b={x:0,y:0,z:0};if(a&&a.fitness<100)Math.random()<this.gaConfig.mutationChance?(b.y=(1-2*Math.random())*(a.fitness<this.gaConfig.mutationScale?a.fitness:this.gaConfig.mutationScale),this.simple||(b.x=(1-2*Math.random())*(a.fitness<this.gaConfig.mutationScale?a.fitness:this.gaConfig.mutationScale),b.z=(1-2*Math.random())*(a.fitness<this.gaConfig.mutationScale?a.fitness:this.gaConfig.mutationScale)),add(b,a.v)):b=cloneObject(a.v);else if(this.simple)b.x=(this.fitnessConfig.pT.x-this.fitnessConfig.p0.x)/this.fitnessConfig.minT,b.z=(this.fitnessConfig.pT.z-this.fitnessConfig.p0.z)/this.fitnessConfig.minT,b.y=this.fitnessConfig.tossSign*Math.random()*this.gaConfig.initialScale;else{var c;c=this.fitnessConfig.surfaceBounceOrder?this.fitnessConfig.surfaces[this.fitnessConfig.surfaceBounceOrder[0]]:this.fitnessConfig.surfaces[Math.floor(Math.random()*this.fitnessConfig.surfaces.length)],b=cloneObject(c.position),add(b,multiply(cloneObject(c.axis1),1-2*Math.random())),add(b,multiply(cloneObject(c.axis2),1-2*Math.random()));var d=b.y;b.y=0;var e=cloneObject(this.fitnessConfig.p0);e.y=0;var f=cloneObject(this.fitnessConfig.pT);f.y=0;var g=0,h=this.gaConfig.initialScale;sub(b,e),normalize(b),multiply(b,g+(h-g)*Math.random()),g=1==this.fitnessConfig.tossSign||d>this.fitnessConfig.p0.y?0:-(2*(this.fitnessConfig.p0.y-d)/this.fitnessConfig.minT),h=this.gaConfig.initialScale,b.y=g+(h-g)*Math.random()}var i=this.getBouncePath(b);return{v:b,T:i.T,fitness:i.path?magnitude(sub(cloneObject(i.path[i.path.length-1]),this.fitnessConfig.pT)):100}},BounceGA.prototype.evolve=function(){if(this.generations>=this.gaConfig.maxGenerations)this.ableToFindSolution=!1;else if(this.rankedPopulation.length>0&&this.rankedPopulation[0].fitness<=this.gaConfig.fitnessThreshold)this.ableToFindSolution=!0;else{if(0==this.rankedPopulation.length||this.gaConfig.noGA){this.rankedPopulation=[];for(var a=0;a<this.gaConfig.populationSize;a++)this.rankedPopulation.push(this.generateMember(void 0))}else{for(var b=0,c=[],a=0;a<this.rankedPopulation.length;a++)b+=1/this.rankedPopulation[a].fitness,c.push(b);for(var d=[],a=0;a<this.gaConfig.populationSize;a++)if(a<.5*this.gaConfig.populationSize)d.push(this.generateMember(void 0));else for(var e=Math.random()*b,f=0;f<c.length;f++)if(e<c[f]){d.push(this.generateMember(this.rankedPopulation[f]));break}this.rankedPopulation=d}this.rankedPopulation.sort(function(a,b){return a.fitness-b.fitness});var g=this.rankedPopulation[0];this.fittestMembers.push(g),this.generations++,this.generations%100==0&&console.log(this.generations+" "+g.fitness),this.evolve()}},function(a){a.interpolateBezierSpline=function(a,b,c,d,e,f,g){var h;if(0==b)h=a[0];else if(1==b)h=a.last();else{1==a.length&&a.push(a[0]);for(var i=[{x:a[0].x+c.dx*e,y:a[0].y+c.dy*e,z:a[0].z+c.dz*e},{x:a.last().x-d.dx*f,y:a.last().y-d.dy*f,z:a.last().z-d.dz*f}],j=1e-5,k=[],l=[],m=0;m<a.length-1;m++){var n,o,p=a[m],q=a[m+1];if(0==m)n=i[0];else{var r=k[k.length-1],n={x:p.x+(p.x-r.x),y:p.y+(p.y-r.y),z:p.z+(p.z-r.z)};k.push(n)}if(m+1==a.length-1)o=i[1];else{var s={x:(a[m].x+a[m+1].x)/2,y:(a[m].y+a[m+1].y)/2,z:(a[m].z+a[m+1].z)/2},t={x:(a[m+1].x+a[m+2].x)/2,y:(a[m+1].y+a[m+2].y)/2,z:(a[m+1].z+a[m+2].z)/2},u=Math.sqrt(Math.pow(a[m].x-a[m+1].x,2)+Math.pow(a[m].y-a[m+1].y,2)+Math.pow(a[m].z-a[m+1].z,2)),v=Math.sqrt(Math.pow(a[m+1].x-a[m+2].x,2)+Math.pow(a[m+1].y-a[m+2].y,2)+Math.pow(a[m+1].z-a[m+2].z,2)),w=u/(u+v),x={x:(1-w)*s.x+w*t.x,y:(1-w)*s.y+w*t.y,z:(1-w)*s.z+w*t.z};o={x:q.x+(s.x-x.x),y:q.y+(s.y-x.y),z:q.z+(s.z-x.z)},k.push(o)}for(var w=0;w<=1+j;w+=.02)l.push({x:Math.pow(1-w,3)*p.x+3*Math.pow(1-w,2)*w*n.x+3*(1-w)*Math.pow(w,2)*o.x+Math.pow(w,3)*q.x,y:Math.pow(1-w,3)*p.y+3*Math.pow(1-w,2)*w*n.y+3*(1-w)*Math.pow(w,2)*o.y+Math.pow(w,3)*q.y,z:Math.pow(1-w,3)*p.z+3*Math.pow(1-w,2)*w*n.z+3*(1-w)*Math.pow(w,2)*o.z+Math.pow(w,3)*q.z}),1==l.length?l.last().dist=0:l.last().dist=l[l.length-2].dist+Math.sqrt(Math.pow(l.last().x-l[l.length-2].x,2)+Math.pow(l.last().y-l[l.length-2].y,2)+Math.pow(l.last().z-l[l.length-2].z,2))}var y;if(g){var z=Math.sqrt(Math.pow(c.dx,2)+Math.pow(c.dy,2)+Math.pow(c.dz,2)),A=Math.sqrt(Math.pow(d.dx,2)+Math.pow(d.dy,2)+Math.pow(d.dz,2)),B=l.last().dist,C=siteswap.dwellDuration,D=(6*C*(A+z)-12*B)/Math.pow(C,3),E=(A-z-.5*D*Math.pow(C,2))/C,F=b*C,G=z*F+.5*E*Math.pow(F,2)+1/6*D*Math.pow(F,3);y=0;for(var m=0;m<l.length;m++)l[m].dist<=G&&(y=m)}else y=Math.floor(b*l.length);h=l[y<0?0:y]}return h}}("undefined"==typeof exports?this.Bezier={}:exports),function(a){function b(a){for(var b=0,c=0;c<a.length;c++)parseInt(a[c])?b+=parseInt(a[c]):a.charCodeAt(c)>=97&&a.charCodeAt(c)<=119&&(b+=a.charCodeAt(c)-87),"P"!=a[c]&&"S"!=a[c]||!parseInt(a[c+1])||c++,"B"!=a[c]&&"D"!=a[c]&&"T"!=a[c]&&"C"!=a[c]&&"S"!=a[c]||"{"!=a[c+1]||(c=a.indexOf("}",c));return b}var c={},d=0,e=1;a.CreateSiteswap=function(a,f){function g(){function a(a,b,c){var d,e=a.match(/\(-?\d+(\.\d+)?(,-?\d+(\.\d+)?)?(,-?\d+(\.\d+)?)?/g)[0].match(/-?\d+(\.\d+)?/g),f=a.match(/\{-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?\}/g);f&&(d=f[0].match(/-?\d+(\.\d+)?/g));var g;return g=d?{x:parseFloat(d[0]),y:parseFloat(d[1]),z:parseFloat(d[2]),th:parseFloat(d[3])}:"club"==A.props[0].type?{x:4,y:0,z:0==b?-1:1,th:Math.PI/2+(0==b?.5:-.7)}:"ring"==A.props[0].type?{x:0,y:1,z:0,th:Math.PI/2}:{x:1,y:0,z:0,th:0},{x:parseFloat(e[0])/100,y:e[1]?parseFloat(e[1])/100:0,z:e[2]?parseFloat(e[2])/100:0,rotation:g,empty:c}}if(void 0===f&&(f={}),A.validationOnly=void 0!==f.validationOnly&&f.validationOnly,A.beatDuration=void 0===f.beatDuration?.2:f.beatDuration,A.dwellDuration=void 0===f.dwellRatio?.5*A.beatDuration:A.beatDuration*f.dwellRatio,A.numStepsPerBeat=void 0===f.numStepsPerBeat?Math.floor(200*A.beatDuration):f.numStepsPerBeat,A.matchVelocity=void 0!==f.matchVelocity&&f.matchVelocity,A.dwellCatchScale=void 0===f.dwellCatchScale?.05:f.dwellCatchScale,A.dwellTossScale=void 0===f.dwellTossScale?.05:f.dwellTossScale,A.emptyTossScale=void 0===f.emptyTossScale?.05:f.emptyTossScale,A.emptyCatchScale=void 0===f.emptyCatchScale?.05:f.emptyCatchScale,A.armAngle=void 0===f.armAngle?.1:f.armAngle,"L"==f.startingHand||"LEFT"==f.startingHand?A.startingHand=d:A.startingHand=e,void 0===f.props?A.props=[{type:"ball",radius:.05,C:.95}]:A.props=f.props,void 0===f.dwellPath)A.dwellPath=[[{x:.3,y:0,z:0,rotation:{x:4,y:0,z:-1,th:Math.PI/2},empty:!1},{x:.1,y:0,z:0,rotation:{x:4,y:0,z:1,th:Math.PI/2},empty:!1}]];else{var b=f.dwellPath.split(").").map(function(a,b,c){return b<c.length-1?a+")":a});A.dwellPath=[];for(var c=0;c<b.length;c++){b[c].indexOf("e")==-1&&(b[c]+="e");var g,h=b[c].split("e")[0].match(/\(-?\d+(\.\d+)?(,-?\d+(\.\d+)?)?(,-?\d+(\.\d+)?)?(,\{-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?\})?\)/g),i=b[c].split("e")[1].match(/\(-?\d+(\.\d+)?(,-?\d+(\.\d+)?)?(,-?\d+(\.\d+)?)?(,\{-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?\})?\)/g);null==i?(i=[],g=0):g=i.reduce(function(a,b){return a+b}).length,h.reduce(function(a,b){return a+b}).length==b[c].split("e")[0].length&&g==b[c].split("e")[1].length?A.dwellPath.push(h.map(function(b,c){return a(b,c,!1)}).concat(i.map(function(b,c){return a(b,c,!0)}))):A.errorMessage="Invalid custom dwell path"}}if(void 0===f.surfaces?A.surfaces=[{position:{x:0,y:0,z:0},normal:{x:0,y:1,z:0},scale:5,color:"grey"}]:A.surfaces=f.surfaces,A.jugglers=[],void 0===f.jugglers||A.numJugglers!=f.jugglers.length)if(1==A.numJugglers)A.jugglers.push({position:{x:0,z:-2*c},rotation:c*Math.PI,color:"grey"});else for(var c=0;c<A.numJugglers;c++){var j=2*c*Math.PI/A.numJugglers;A.jugglers.push({position:{x:Math.cos(j),z:Math.sin(j)},rotation:j-Math.PI/2,color:"grey"})}else for(var c=0;c<f.jugglers.length;c++)A.jugglers.push({position:f.jugglers[c].position,rotation:f.jugglers[c].rotation,color:f.jugglers[c].color});for(var c=0;c<A.surfaces.length;c++){var k=A.surfaces[c];normalize(k.normal);var l;l=0==k.normal.x&&0==k.normal.z?{x:1,y:0,z:0}:{x:-k.normal.z,y:0,z:k.normal.x};var m=cross(k.normal,l);normalize(l),multiply(l,k.scale),normalize(m),multiply(m,k.scale),k.axis1=l,k.axis2=m}}function h(){a=a.replace(/\s/g,"");var b=1,c=/<[^ ]+>/.test(a);if(c){var d=a.match(/<[^ <>]+>/g);if(b=d[0].split("|").length,1==b)return A;var e=b;d.map(function(a){if(a.split("|").length!=e)return A})}var f="";2==b?f="P":b>2&&(f="P[1-"+b+"]");var g="([\\da-o])x?A?("+f+")?(C{(C|P)?})?(T{(C|P)?})?(B({\\d*(L|HL|F|HF)?\\d*})?)?(S{-?\\d+(.\\d+)?(,-?\\d+(.\\d+)?,-?\\d+(.\\d+)?,-?\\d+(.\\d+)?)?})?(D{\\d*\\.?\\d*})?",h="\\[("+g+")+\\]",i=g+"|"+h,j="\\(("+i+"),("+i+")\\)",k="("+i+"|"+j+")",l="<"+k+"(\\|"+k+")+>",m="^("+l+")+|("+k+")+\\*?$",n="<"+k+"+(\\|"+k+"+)+>";if(s=new RegExp(g,"g"),t=new RegExp(h,"g"),u=new RegExp(i,"g"),v=new RegExp(j,"g"),w=new RegExp(k,"g"),x=new RegExp(l,"g"),y=new RegExp(m,"g"),z=new RegExp(n,"g"),a.match(z)==a){for(var o="",p=a.split("|"),q=[],r=0;r<p.length;r++)q.push(p[r].match(w));for(var r=0;r<q[0].length;r++){o+="<";for(var B=0;B<q.length;B++)o+=q[B][r],B<q.length-1&&(o+="|");o+=">"}a=o}if("*"==a.charAt(a.length-1)){var o=a.slice(0,-1),C=o.match(v);if(null!==C){for(var r=0;r<C.length;r++)o+="("+C[r].match(u).reverse().join(",")+")";a=o}}a.match(y)==a?(A.validSyntax=!0,A.multiplex=!!a.match(t),A.sync=!!a.match(v),A.pass=!!a.match(x),A.numJugglers=b):A.errorMessage="Invalid syntax"}function i(a,b,c,f,g,h){if(b.match(x)){var j=b.match(w);j.map(function(b,c){h=i(a,b,c,void 0,void 0,h)})}else if(b.match(v)){var j=b.split(","),k=j[0].substr(1),l=j[1].substr(0,j[1].length-1);h=i(a,k,c,!0,d,h),h=i(a,l,c,!0,e,h)}else if(b.match(t)){var j=b.match(s);j.map(function(b,d,e){h=i(a,b,c,void 0,g,h),d<e.length-1&&(0==h?h=A.dwellPath.length-1:h--)})}else{var m=b[0].charCodeAt(0)>=97&&b[0].charCodeAt(0)<=119?b[0].charCodeAt(0)-87:parseInt(b[0]),n=c,o=b.indexOf("P"),p=!1;o>0&&"}"!=b[o+1]&&(n=A.numJugglers>2?parseInt(b[o+1])-1:1-c,p=!0);var q,r=b.indexOf("D");q=r>0?A.beatDuration*parseFloat(b.substring(r+2,b.indexOf("}"))):A.dwellDuration;var u=0,y=[],z=b.indexOf("B");if(z>0){var B;if(B=isNaN(b[z+3])?isNaN(b[z+4])?2:4:3,"{"==b[z+1]&&void 0!=B){u=parseInt(b[z+B]);for(var C=z+B+1;C<b.length&&!isNaN(b[C]);C++){var D=parseInt(b[C]);if(D>=A.surfaces.length)throw{message:"Bounce surface index out of range"};y.push(D)}}else u=1,y=[0];if(y.length<u)for(var E=y.length,C=0;C<u-E;C++)y.push(0)}var F=void 0;if(u>0)if(b.match("HF"))F="HF";else if(b.match("HL"))F="HL";else if(b.match("F"))F="F";else if(b.match("L"))F="L";else{var G=A.beatDuration*m-q;F=G<.68?"HF":G<1.25?"F":"L"}var H=b.indexOf("T"),I="standard";if(H>0){var J=b.substring(H+2,b.indexOf("}",H));J.match("C")?I="claw":J.match("P")&&(J="penguin")}var K=b.indexOf("C"),L="standard";if(K>0){var M=b.substring(K+2,b.indexOf("}",K));M.match("C")?L="claw":M.match("P")&&(L="penguin")}var N=m%2==1;b.length>1&&"x"==b[1]&&(N=!N),"R"==b[0]?g=e:"L"==b[0]&&(g=d);var O,P=normalize({x:.1,y:.1,z:1}),Q=b.indexOf("S");if(Q>0){var R=b.substring(Q+2,b.indexOf("}",Q)).match(/-?\d+(\.\d+)?/g);O=parseFloat(R[0]),R.length>1&&(P.x=parseFloat(R[1]),P.y=parseFloat(R[2]),P.z=parseFloat(R[3]),normalize(P))}else{var S=!0;A.props.forEach(function(a){"ball"!=a.type&&(S=!1)}),S?O=0:(O=Math.floor(m/2)+.2,p&&(O+=.1))}a.push({juggler:c,targetJuggler:n,hand:g,crossing:N,numBeats:m,siteswapStr:b,numBounces:u,bounceOrder:y,bounceType:F,numSpins:O,dwellPathIx:h,dwellDuration:q,tossType:I,catchType:L,tossOrientation:P,rotationAxis:{x:1,y:0,z:0},hold:2==m&&!N&&b.indexOf("A")==-1}),m>0&&(h==A.dwellPath.length-1?h=0:h++)}return h}function k(){A.beats=A.pass?a.match(x):a.match(w);for(var c=0;c<A.beats.length;c++)A.beats[c].match(v)&&(A.beats.splice(c+1,0,"(0,0)"),c++);var f=0;if(A.beats.map(function(a){if(a.match(x))for(var c=a.split("|"),d=0;d<c.length;d++)0==d&&(c[d]=c[d].substr(1)),d==c.length-1&&(c[d]=c[d].substr(0,c[d].length-1)),f+=b(c[d]);else f+=b(a)}),!(f/A.beats.length%1==0&&f/A.beats.length>0))return void(A.errorMessage="Cannot determine number of props");for(A.numProps=f/A.beats.length;A.props.length<A.numProps;)A.props.push(cloneObject(A.props.last()));for(;A.props.length>A.numProps;)A.props.pop();A.tosses=[];for(var g=0,c=0;c<A.beats.length;c++){var h=[];g=i(h,A.beats[c],0,void 0,void 0,g),A.tosses.push(h),c==A.beats.length-1&&0!=g&&(c=-1)}A.maxHeight=0;for(var c=0;c<A.tosses.length;c++)for(var j=0;j<A.tosses[c].length;j++)A.tosses[c][j].numBeats>A.maxHeight&&(A.maxHeight=A.tosses[c][j].numBeats);for(var k=[],c=0;c<A.numProps;c++)k.push(c);A.states=[],A.propOrbits=[],A.stateDiagram=[];for(var l=[],j=0;j<A.numJugglers;j++){l.push([[],[]]);for(var m=0;m<A.maxHeight;m++)l[j][d].push(void 0),l[j][e].push(void 0)}for(var n=!1,o=!1,p=0,q=0,r=A.startingHand;!n;){A.stateDiagram.push([1==r?"R":"L"]),0==p&&o&&(A.stateDiagram[q][0]+="*");for(var s=cloneObject(A.propOrbits),t=[],j=0;j<A.numJugglers;j++){var u=l[j][d].shift();if(u)for(var m=0;m<u.length;m++)t.push({propId:u[m],juggler:j,hand:d});var y=l[j][e].shift();if(y)for(var m=0;m<y.length;m++)t.push({propId:y[m],juggler:j,hand:e});l[j][d].push(void 0),l[j][e].push(void 0)}for(var z="",j=0;j<A.tosses[p%A.tosses.length].length;j++){for(var B=A.tosses[p%A.tosses.length][j],C=void 0==B.hand?r:B.hand,D=B.crossing?1-C:C,E=void 0,m=0;m<t.length;m++)if(t[m].juggler==B.juggler&&t[m].hand==C){if(0==B.numBeats)return void(A.errorMessage="Prop landing on 0 toss at beat "+p);E=t.splice(m,1)[0].propId;break}if(void 0==E&&B.numBeats>0&&(E=k.shift()),void 0==E&&B.numBeats>0)return void(A.errorMessage="No prop available to toss at beat "+p);z+=(void 0===E?"X":E)+"-"+B.siteswapStr,j<A.tosses[p%A.tosses.length].length-1&&(z+=","),B.numBeats>0&&(s[E]||(s[E]=[]),s[E].push({beat:p,numBeats:B.numBeats,juggler:B.juggler,hand:C,numBounces:B.numBounces,bounceType:B.bounceType,bounceOrder:B.bounceOrder,numSpins:B.numSpins,dwellPathIx:B.dwellPathIx,dwellDuration:B.dwellDuration,tossType:B.tossType,catchType:B.catchType,tossOrientation:B.tossOrientation,rotationAxis:B.rotationAxis,hold:B.hold}),void 0==l[B.targetJuggler][D][B.numBeats-1]?l[B.targetJuggler][D][B.numBeats-1]=[E]:l[B.targetJuggler][D][B.numBeats-1].push(E))}if(A.stateDiagram[q].push(z),l[0][0].map(function(a){void 0==a?A.stateDiagram[q].push("X"):A.stateDiagram[q].push(a.reduce(function(a,b){return a.toString()+b.toString()}))}),l[0][1].map(function(a){void 0==a?A.stateDiagram[q].push("X"):A.stateDiagram[q].push(a.reduce(function(a,b){return a.toString()+b.toString()}))}),o&&p%A.tosses.length==0&&arraysEqual(A.states[0],l)?n=!0:(A.states.push(cloneObject(l)),A.propOrbits=s),0!=k.length||(p+1)%A.tosses.length!=0||o||(o=!0,p=-1,A.states=[],A.propOrbits=[]),p++,q++,r=1-r,p>1e3)return void(A.errorMessage="Pattern took more than 1000 beats to repeat states")}for(var c=0;c<A.tosses.length;c++)for(var j=0;j<A.tosses[c].length;j++)A.tosses[c][j].numBeats>0&&A.tosses[c][j].dwellDuration>=A.beatDuration*A.tosses[c][j].numBeats&&(A.errorMessage="Cannot have a '1' toss with a dwellRatio >= 1");A.numSteps=A.states.length*A.numStepsPerBeat,A.validPattern=!0}function l(){try{c={};for(var a=[],b=0;b<A.numProps;b++)a.push([]);for(var f=[],b=0;b<A.numProps;b++)f.push([]);for(var g=[],b=0;b<A.numJugglers;b++)g.push([[],[]]);for(var h=[],b=0;b<A.numJugglers;b++)h.push([[],[]]);for(var i=0;i<A.numSteps;i++){for(var k=[],b=0;b<A.numJugglers;b++)k.push([void 0,void 0]);for(var l=Math.floor(i*A.states.length/A.numSteps),s=A.beatDuration*i*A.states.length/A.numSteps,t=0;t<A.numProps;t++){for(var u=void 0,v=void 0,w=void 0,x=!1,b=0;b<A.propOrbits[t].length;b++)!x&&(b==A.propOrbits[t].length-1||A.propOrbits[t][b].beat<=l&&A.propOrbits[t][b+1].beat>l)&&(u=A.propOrbits[t].getPreviousCyclic(b),v=A.propOrbits[t][b],w=A.propOrbits[t].getNextCyclic(b),x=!0);var y=v.beat*A.beatDuration+v.dwellDuration,z=w.beat*A.beatDuration;y>z&&z<=s?z+=A.beatDuration*A.states.length:y>z&&z>s&&(y-=A.beatDuration*A.states.length);var B=u.beat*A.beatDuration+u.dwellDuration,C=v.beat*A.beatDuration;if(B>C&&C<=s?C+=A.beatDuration*A.states.length:B>C&&C>s&&(B-=A.beatDuration*A.states.length),s<y){var D=[],E=[];if(A.multiplex)for(var b=0;b<A.propOrbits.length;b++)if(b!=t)for(j=0;j<A.propOrbits[b].length;j++){var F=A.propOrbits[b][j];if(v.beat==F.beat&&v.juggler==F.juggler&&v.hand==F.hand){var G=j==A.propOrbits[b].length-1?A.propOrbits[b][0]:A.propOrbits[b][j+1],H=0==j?A.propOrbits[b][A.propOrbits[b].length-1]:A.propOrbits[b][j-1],I=F.beat*A.beatDuration+F.dwellDuration,J=G.beat*A.beatDuration;I>J&&J<=s?J+=A.beatDuration*A.states.length:I>J&&J>s&&(I-=A.beatDuration*A.states.length);var K=H.beat*A.beatDuration+H.dwellDuration,L=F.beat*A.beatDuration;K>L&&L<=s?L+=A.beatDuration*A.states.length:K>L&&L>s&&(K-=A.beatDuration*A.states.length),D.push(m(o(n(A.dwellPath[F.dwellPathIx]),F.juggler,F.hand,1),o(n(A.dwellPath[G.dwellPathIx]),G.juggler,G.hand,0),J-I,0,{numBounces:F.numBounces,bounceType:F.bounceType,bounceOrder:F.bounceOrder,R:A.props[b].radius,C:A.props[b].C})),E.push(m(o(n(A.dwellPath[H.dwellPathIx]),H.juggler,H.hand,1),o(n(A.dwellPath[F.dwellPathIx]),F.juggler,F.hand,0),L-K,L-K,{numBounces:H.numBounces,bounceType:H.bounceType,bounceOrder:H.bounceOrder,R:A.props[b].radius,C:A.props[b].C}))}}D.push(m(o(n(A.dwellPath[v.dwellPathIx]),v.juggler,v.hand,1),o(n(A.dwellPath[w.dwellPathIx]),w.juggler,w.hand,0),z-y,0,{numBounces:v.numBounces,bounceType:v.bounceType,bounceOrder:v.bounceOrder,R:A.props[t].radius,C:A.props[t].C})),E.push(m(o(n(A.dwellPath[u.dwellPathIx]),u.juggler,u.hand,1),o(n(A.dwellPath[v.dwellPathIx]),v.juggler,v.hand,0),C-B,C-B,{numBounces:u.numBounces,bounceType:u.bounceType,bounceOrder:u.bounceOrder,R:A.props[t].radius,C:A.props[t].C}));var M={dx:0,dy:0,dz:0,x:0,y:0,z:0},N={dx:0,dy:0,dz:0,x:0,y:0,z:0};for(b=0;b<E.length;b++)M.dx+=E[b].dx/E.length,M.dy+=E[b].dy/E.length,M.dz+=E[b].dz/E.length,M.x+=E[b].x/E.length,M.y+=E[b].y/E.length,M.z+=E[b].z/E.length,N.dx+=D[b].dx/E.length,N.dy+=D[b].dy/E.length,N.dz+=D[b].dz/E.length,N.x+=D[b].x/E.length,N.y+=D[b].y/E.length,N.z+=D[b].z/E.length;var O=1-(y-s)/v.dwellDuration,P=o(n(A.dwellPath[v.dwellPathIx]),v.juggler,v.hand,O,M,N,A.dwellCatchScale,A.dwellTossScale),Q=o(n(A.dwellPath[v.dwellPathIx]),v.juggler,v.hand,0),R={x:M.x-Q.x,y:M.y-Q.y,z:M.z-Q.z};P.x+=(1-O)*R.x,P.y+=(1-O)*R.y,P.z+=(1-O)*R.z;var S=Math.atan2(-M.dx,-M.dy),T=Math.atan2(N.dx,N.dy);"claw"==v.tossType?T-=Math.PI:"penguin"==v.tossTypeId&&(T-=2*Math.PI),"claw"==v.catchType?S-=Math.PI:"penguin"==v.catchType&&(S-=2*Math.PI),P.angle=S+O*(T-S),v.hand==e&&(P.angle*=-1),P.dwell=!0,a[t].push(P),void 0==k[v.juggler][v.hand]&&(k[v.juggler][v.hand]=P);var U=q(u.tossOrientation,u.rotationAxis,A.jugglers[u.juggler].rotation,2*u.numSpins*Math.PI,u.hand),V=q(v.tossOrientation,v.rotationAxis,A.jugglers[v.juggler].rotation,0,v.hand);U.slerp(V,O),f[t].push(U)}else if(v.hold){var W=[A.dwellPath[v.dwellPathIx].last(),A.dwellPath[w.dwellPathIx][0]],X=v.numBeats*A.beatDuration-v.dwellDuration,Y=m(o(n(A.dwellPath[v.dwellPathIx]),v.juggler,v.hand,1),o(n(A.dwellPath[w.dwellPathIx]),w.juggler,w.hand,0),X,0),Z=m(o(n(A.dwellPath[v.dwellPathIx]),v.juggler,v.hand,1),o(n(A.dwellPath[w.dwellPathIx]),w.juggler,w.hand,0),X,X);P=o(n(W),v.juggler,v.hand,(s-y)/(z-y),Y,Z,A.emptyTossScale,A.emptyCatchScale);var S=Math.atan2(-Y.dx,-Y.dy),T=Math.atan2(Z.dx,Z.dy);"claw"==v.tossType?T-=Math.PI:"penguin"==v.tossTypeId&&(T-=2*Math.PI),"claw"==v.catchType?S-=Math.PI:"penguin"==v.catchType&&(S-=2*Math.PI),P.angle=S+(s-(y-v.dwellDuration))/(z-(y-v.dwellDuration))*(T-S),v.hand==e&&(P.angle*=-1),P.dwell=!0,a[t].push(P),void 0==k[v.juggler][v.hand]&&(k[v.juggler][v.hand]=P);var U=q(v.tossOrientation,v.rotationAxis,A.jugglers[v.juggler].rotation,0,v.hand),V=q(w.tossOrientation,w.rotationAxis,A.jugglers[w.juggler].rotation,0,w.hand);U.slerp(V,(s-(y-v.dwellDuration))/(z-(y-v.dwellDuration))),f[t].push(U)}else{var P,X=z-y,O=s-y;P=m(o(n(A.dwellPath[v.dwellPathIx]),v.juggler,v.hand,1),o(n(A.dwellPath[w.dwellPathIx]),w.juggler,w.hand,0),X,O,{numBounces:v.numBounces,bounceType:v.bounceType,bounceOrder:v.bounceOrder,R:A.props[t].radius,C:A.props[t].C}),P.dwell=!1,a[t].push(P);var $=2*v.numSpins*Math.PI,_=0,aa=_+O/X*($-_);f[t].push(q(v.tossOrientation,v.rotationAxis,A.jugglers[v.juggler].rotation,aa,v.hand))}}for(var ba=0;ba<A.numJugglers;ba++)for(var ca=0;ca<=1;ca++){if(void 0==k[ba][ca]){for(var w=void 0,da=void 0,ea=void 0,fa=void 0,ga=void 0,ha=void 0,ia=void 0,ja=void 0,ka=void 0,la=void 0,ma=void 0,na=void 0,oa=void 0,pa=void 0,t=0;t<A.propOrbits.length;t++)for(var qa=0;qa<A.propOrbits[t].length;qa++)A.propOrbits[t][qa].juggler==ba&&A.propOrbits[t][qa].hand==ca&&((void 0==da||A.propOrbits[t][qa].beat<da.beat)&&(da=A.propOrbits[t][qa],ga=t,ha=qa),A.propOrbits[t][qa].beat>l&&(void 0==w||A.propOrbits[t][qa].beat<w.beat)&&(w=A.propOrbits[t][qa],ia=t,ja=qa),(void 0==fa||A.propOrbits[t][qa].beat>fa.beat)&&(fa=A.propOrbits[t][qa],ka=t,la=qa),A.propOrbits[t][qa].beat<=l&&(void 0==ea||A.propOrbits[t][qa].beat>ea.beat)&&(ea=A.propOrbits[t][qa],ma=t,na=qa));if(void 0==w&&(w=da,ia=ga,ja=ha),void 0==ea&&(ea=fa,ma=ka,na=la),void 0==w&&void 0==ea){var P=o([{x:.2,y:0,z:0}],ba,ca,0);P.angle=0}else{oa=0==ja?A.propOrbits[ia].last():A.propOrbits[ia][ja-1],pa=na==A.propOrbits[ma].length-1?A.propOrbits[ma][0]:A.propOrbits[ma][na+1];var ra=w.beat*A.beatDuration;ra<s&&(ra+=A.beatDuration*A.states.length);var sa=ea.beat*A.beatDuration+ea.dwellDuration;sa>s&&(sa-=A.beatDuration*A.states.length);var ta=pa.beat*A.beatDuration;ta<sa&&(ta+=A.beatDuration*A.states.length);var ua=oa.beat*A.beatDuration+oa.dwellDuration;ua>ra&&(ua-=A.beatDuration*A.states.length);for(var Y=m(o(n(A.dwellPath[ea.dwellPathIx]),ea.juggler,ea.hand,1),o(n(A.dwellPath[pa.dwellPathIx]),pa.juggler,pa.hand,0),ea.numBeats*A.beatDuration-ea.dwellDuration,0,{numBounces:ea.numBounces,bounceType:ea.bounceType,bounceOrder:ea.bounceOrder,R:A.props[ma].radius,C:A.props[ma].C}),Z=m(o(n(A.dwellPath[oa.dwellPathIx]),oa.juggler,oa.hand,1),o(n(A.dwellPath[w.dwellPathIx]),w.juggler,w.hand,0),oa.numBeats*A.beatDuration-oa.dwellDuration,oa.numBeats*A.beatDuration-oa.dwellDuration,{numBounces:oa.numBounces,bounceType:oa.bounceType,bounceOrder:oa.bounceOrder,R:A.props[ia].radius,C:A.props[ia].C}),O=(s-sa)/(ra-sa),va=[],wa=A.dwellPath[ea.dwellPathIx],b=0;b<wa.length;b++)wa[b].empty&&(0==va.length&&va.push(wa[b-1]),va.push(wa[b]));0==va.length&&va.push(wa.last()),va.push(A.dwellPath[w.dwellPathIx][0]);var P=o(va,ea.juggler,ea.hand,O,Y,Z,A.emptyTossScale,A.emptyCatchScale),xa=o(va,ea.juggler,ea.hand,1),ya={x:Z.x-xa.x,y:Z.y-xa.y,z:Z.z-xa.z};P.x+=O*ya.x,P.y+=O*ya.y,P.z+=O*ya.z;var S=Math.atan2(-Z.dx,-Z.dy),T=Math.atan2(Y.dx,Y.dy);"claw"==ea.tossType?T-=Math.PI:"penguin"==ea.tossType&&(T-=2*Math.PI),"claw"==w.catchType?S-=Math.PI:"penguin"==w.catchType&&(S-=2*Math.PI),P.angle=T+O*(S-T),ca==e&&(P.angle*=-1)}k[ba][ca]=P}g[ba][ca].push(k[ba][ca]),h[ba][ca].push(p({x:A.jugglers[ba].position.x+Math.cos(A.jugglers[ba].rotation)*(ca==d?-1:1)*.225,y:1.425,z:A.jugglers[ba].position.z+Math.sin(A.jugglers[ba].rotation)*(ca==d?-1:1)*.225},k[ba][ca],.45,A.armAngle,ca))}}A.propPositions=a,A.propRotations=f,A.jugglerHandPositions=g,A.jugglerElbowPositions=h,A.collision=r()}catch(a){A.errorMessage=a.message}}function m(a,b,d,e,f){d=parseFloat(d.toFixed(2)),void 0==f&&(f={}),f.bounceType||(f.bounceType="L"),f.dt||(f.dt=.01),f.eps||(f.eps=.01),f.dv||(f.dv=.01),f.numBounces||(f.numBounces=0),f.bounceOrder||(f.bounceOrder=[0]),f.G||(f.G=-9.8),f.C||(f.C=.95),f.tries||(f.tries=1e4),f.R||(f.R=.1);var g=JSON.stringify({p0:a,p1:b,T:d,options:f});if(0==f.numBounces)return{x:a.x+(b.x-a.x)*e/d,y:a.y+(b.y-a.y-.5*f.G*d*d)*e/d+.5*f.G*e*e,z:a.z+(b.z-a.z)*e/d,dx:(b.x-a.x)/d,dy:(b.y-a.y-.5*f.G*d*d)/d+f.G*e,dz:(b.z-a.z)/d};if(void 0==c[g]){var h={p0:a,pT:b,minT:d,maxT:d,R:f.R,C:f.C,dt:f.dt,G:-9.8,numBounces:f.numBounces,surfaceBounceOrder:f.bounceOrder,tossSign:"L"==f.bounceType||"HL"==f.bounceType?1:-1,catchSign:"L"==f.bounceType||"HF"==f.bounceType?1:-1,surfaces:A.surfaces},i={maxGenerations:500,populationSize:50,mutationChance:.7,mutationScale:5,initialScale:40,fitnessThreshold:.05,noGA:!1};if(ga=new BounceGA(i,h),ga.evolve(),!ga.ableToFindSolution)throw{message:"Unable to calculate bounce path"};var j=ga.getBouncePath(ga.fittestMembers[ga.fittestMembers.length-1].v);c[g]={path:j.path,velocities:j.velocities}}var k=c[g];return{x:k.path[Math.floor((k.path.length-1)*e/d)].x,y:k.path[Math.floor((k.path.length-1)*e/d)].y,z:k.path[Math.floor((k.path.length-1)*e/d)].z,dx:k.velocities[Math.floor((k.velocities.length-1)*e/d)].x,dy:k.velocities[Math.floor((k.velocities.length-1)*e/d)].y,dz:k.velocities[Math.floor((k.velocities.length-1)*e/d)].z}}function n(a){for(var b=[],c=0;c<a.length;c++)a[c].empty||b.push(a[c]);return b}function o(a,b,c,e,f,g,h,i,j){c==d&&(f||g)&&(f.dx*=-1,g.dx*=-1);var k=Bezier.interpolateBezierSpline(a,e,f,g,h,i,j);return{x:A.jugglers[b].position.x+(c==d?-1:1)*k.x*Math.cos(A.jugglers[b].rotation)-(k.z-.4125)*Math.sin(A.jugglers[b].rotation),y:1.0125+k.y,z:A.jugglers[b].position.z+(c==d?-1:1)*k.x*Math.sin(A.jugglers[b].rotation)+(k.z-.4125)*Math.cos(A.jugglers[b].rotation)}}function p(a,b,c,d,e){d*=-1;var f={};f.x=b.x-a.x,f.y=b.y-a.y,f.z=b.z-a.z;var g={};g.x=Math.sqrt(f.x*f.x+f.z*f.z),g.y=f.y,g.z=0;var h=Math.atan2(f.z,f.x),i=Math.sqrt(f.x*f.x+f.y*f.y+f.z*f.z);2*c<i&&(c=i/2);var j={};j.x=g.y/i,j.y=-g.x/i,j.z=0;var k={x:0,y:0};1==e?k.z=-1:k.z=1;var l=Math.sqrt(c*c-.25*i*i),m={};m.x=g.x/2+l*j.x*Math.cos(d)+l*k.x*Math.sin(d),m.y=g.y/2+l*j.y*Math.cos(d)+l*k.y*Math.sin(d),m.z=g.z/2+l*j.z*Math.cos(d)+l*k.z*Math.sin(d);var n={};n.x=m.x*Math.cos(h)-m.z*Math.sin(h),n.y=m.y,n.z=m.x*Math.sin(h)+m.z*Math.cos(h);var o={};return o.x=n.x+a.x,o.y=n.y+a.y,o.z=n.z+a.z,o}function q(a,b,c,e,f){T=new THREE.Vector3(a.x,a.y,a.z),R=new THREE.Vector3(b.x,b.y,b.z),C=new THREE.Vector3(0,-1,0),f==d&&(T.x*=-1,R.x*=-1);var g=new THREE.Quaternion;g.setFromAxisAngle(new THREE.Vector3(0,-1,0),c),T.applyQuaternion(g);var h=new THREE.Quaternion;h.setFromAxisAngle(new THREE.Vector3(T.z,0,-T.x),Math.acos(T.y));var i=new THREE.Quaternion;i.setFromAxisAngle(new THREE.Vector3(0,1,0),Math.acos(-R.z*T.x+R.x*T.z)),R.applyQuaternion(i);var j=new THREE.Quaternion;j.setFromAxisAngle(R,e);var k=new THREE.Quaternion;return k=(new THREE.Quaternion).multiplyQuaternions(h,j)}function r(){for(var a,b,c=0;c<A.propPositions.length;c++){a=A.props[c].radius;for(var d=0;d<A.propPositions[c].length;d++)for(var e=c+1;e<A.propPositions.length;e++)if(b=A.props[c].radius,Math.sqrt(Math.pow(A.propPositions[c][d].x-A.propPositions[e][d].x,2)+Math.pow(A.propPositions[c][d].y-A.propPositions[e][d].y,2)+Math.pow(A.propPositions[c][d].z-A.propPositions[e][d].z,2))<=a+b)return!0}return!1}var s,t,u,v,w,x,y,z,A={siteswap:a,validSyntax:!1,validPattern:!1,collision:void 0,multiplex:void 0,sync:void 0,pass:void 0,startingHand:e,numJugglers:void 0,numProps:void 0,maxHeight:void 0,tosses:void 0,beats:void 0,states:void 0,propOrbits:void 0,propPositions:void 0,propRotations:void 0,jugglerHandPositions:void 0,jugglerElbowPositions:void 0,jugglers:void 0,validationOnly:void 0,numStepsPerBeat:void 0,numSteps:void 0,beatDuration:void 0,dwellDuration:void 0,props:void 0,dwellPath:void 0,tossMatchVelocity:void 0,catchMatchVelocity:void 0,dwellCatchScale:void 0,dwellTossScale:void 0,emptyTossScale:void 0,emptyCatchScale:void 0,armAngle:void 0,surfaces:void 0,errorMessage:void 0,stateDiagram:void 0};return h(),g(),A.errorMessage?A:(k(),A.errorMessage?A:(A.validationOnly||l(),A))}}("undefined"==typeof exports?this.SiteswapJS={}:exports);