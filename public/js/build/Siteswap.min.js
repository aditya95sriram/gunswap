function getURLQueryStringParameterByName(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(location.search);return null===e?null:decodeURIComponent(e[1].replace(/\+/g," "))}function cloneObject(t){var e=t instanceof Array?[]:{};for(var a in t)"clone"!=a&&(t[a]&&"object"==typeof t[a]?e[a]=cloneObject(t[a]):e[a]=t[a]);return e}function arraysEqual(t,e){if(!(t instanceof Array&&e instanceof Array))return!1;if(t.length!=e.length)return!1;for(var a=0;a<t.length;a++)if(t[a]instanceof Array||e[a]instanceof Array){if(!arraysEqual(t[a],e[a]))return!1}else if(t[a]!=e[a])return!1;return!0}function cross(t,e){return{x:t.y*e.z-t.z*e.y,y:t.z*e.x-t.x*e.z,z:t.x*e.y-t.y*e.x}}function dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function magnitude(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}function normalize(t){var e=magnitude(t);return t.x=t.x/e,t.y=t.y/e,t.z=t.z/e,t}function multiply(t,e){return t.x*=e,t.y*=e,t.z*=e,t}function add(t,e){return t.x+=e.x,t.y+=e.y,t.z+=e.z,t}function sub(t,e){return t.x-=e.x,t.y-=e.y,t.z-=e.z,t}function negate(t){return multiply(t,-1),t}function BounceGA(t,e){if(this.gaConfig=t,this.fitnessConfig=e,void 0===e.axis1)for(var a=0;a<this.fitnessConfig.surfaces.length;a++){var n=this.fitnessConfig.surfaces[a];normalize(n.normal);var o;o=0==n.normal.x&&0==n.normal.z?{x:1,y:0,z:0}:{x:-n.normal.z,y:0,z:n.normal.x};var s=cross(n.normal,o);normalize(o),normalize(s),multiply(o,n.scale),multiply(s,n.scale),n.axis1=o,n.axis2=s}this.simple=!1,1==e.numBounces&&1==e.surfaces.length&&0==e.surfaces[0].normal.x&&0==e.surfaces[0].normal.z&&e.minT==e.maxT&&(this.simple=!0),this.generations=0,this.rankedPopulation=[],this.fittestMembers=[],this.ableToFindSolution=void 0}Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]}),Array.prototype.getIndexCyclic||(Array.prototype.getIndexCyclic=function(t){return this[t%this.length]}),Array.prototype.getNextCyclic||(Array.prototype.getNextCyclic=function(t){return t%=this.length,this.length-1==t?this[0]:this[t+1]}),Array.prototype.getPreviousCyclic||(Array.prototype.getPreviousCyclic=function(t){return 0==(t%=this.length)?this[this.length-1]:this[t-1]}),window.randomColors=["red","blue","green","black","yellow","purple"],BounceGA.prototype.getBouncePath=function(t){var e=cloneObject(this.fitnessConfig.p0),a=cloneObject(t),n=[],o=[];n.push(cloneObject(e)),o.push(cloneObject(a));for(var s=0;s<this.fitnessConfig.surfaces.length;s++)this.fitnessConfig.surfaces[s].bounces=0,this.fitnessConfig.surfaces[s].colliding=!1;for(var r=0,i=[],l=[],h=0;h<=this.fitnessConfig.maxT;h+=this.fitnessConfig.dt){add(e,multiply(cloneObject(a),this.fitnessConfig.dt)),a.y+=this.fitnessConfig.G*this.fitnessConfig.dt,n.push(cloneObject(e)),o.push(cloneObject(a));for(s=0;s<this.fitnessConfig.surfaces.length;s++){var u=this.fitnessConfig.surfaces[s],p=u.normal.x*e.x+u.normal.y*e.y+u.normal.z*e.z-u.normal.x*u.position.x-u.normal.y*u.position.y-u.normal.z*u.position.z;if(Math.abs(p)<=this.fitnessConfig.R&&Math.abs(dot(sub(cloneObject(e),u.position),normalize(cloneObject(u.axis1))))<=u.scale&&Math.abs(dot(sub(cloneObject(e),u.position),normalize(cloneObject(u.axis2))))<=u.scale&&!u.colliding){u.colliding=!0,u.bounces++,i.push(s),r++;var g=(new THREE.Vector3).copy(u.normal);multiply(g=cloneObject(u.normal),dot(a,u.normal)),multiply(g,2*this.fitnessConfig.C),negate(g),add(a,g)}else Math.abs(p)>this.fitnessConfig.R&&u.colliding&&(u.colliding=!1)}if(h>=this.fitnessConfig.minT||h+this.fitnessConfig.dt>this.fitnessConfig.maxT){var d=!0;this.fitnessConfig.surfaceBounceOrder&&i.toString()!=this.fitnessConfig.surfaceBounceOrder.toString()&&(d=!1);var c=!1;r==this.fitnessConfig.numBounces&&(c=!0),d&&c&&(1==this.fitnessConfig.catchSign&&a.y>=0||-1==this.fitnessConfig.catchSign&&a.y<=0||void 0==this.fitnessConfig.catchSign)&&(1==this.fitnessConfig.tossSign&&t.y>=0||-1==this.fitnessConfig.tossSign&&t.y<=0||void 0==this.fitnessConfig.tossSign)&&l.push({pT:cloneObject(e),T:h,actualpT:this.fitnessConfig.pT})}}return l.length>0?(l.sort(function(t,e){return magnitude(sub(cloneObject(t.pT),t.actualpT))-magnitude(sub(cloneObject(e.pT),t.actualpT))}),{path:n.splice(0,l[0].T/this.fitnessConfig.dt),velocities:o.splice(0,l[0].T/this.fitnessConfig.dt),T:l[0].T}):{path:void 0,velocities:void 0,T:void 0}},BounceGA.prototype.generateMember=function(t){var e={x:0,y:0,z:0};if(t&&t.fitness<100)Math.random()<this.gaConfig.mutationChance?(e.y=(1-2*Math.random())*(t.fitness<this.gaConfig.mutationScale?t.fitness:this.gaConfig.mutationScale),this.simple||(e.x=(1-2*Math.random())*(t.fitness<this.gaConfig.mutationScale?t.fitness:this.gaConfig.mutationScale),e.z=(1-2*Math.random())*(t.fitness<this.gaConfig.mutationScale?t.fitness:this.gaConfig.mutationScale)),add(e,t.v)):e=cloneObject(t.v);else if(this.simple)e.x=(this.fitnessConfig.pT.x-this.fitnessConfig.p0.x)/this.fitnessConfig.minT,e.z=(this.fitnessConfig.pT.z-this.fitnessConfig.p0.z)/this.fitnessConfig.minT,e.y=this.fitnessConfig.tossSign*Math.random()*this.gaConfig.initialScale;else{var a;add(e=cloneObject((a=this.fitnessConfig.surfaceBounceOrder?this.fitnessConfig.surfaces[this.fitnessConfig.surfaceBounceOrder[0]]:this.fitnessConfig.surfaces[Math.floor(Math.random()*this.fitnessConfig.surfaces.length)]).position),multiply(cloneObject(a.axis1),1-2*Math.random())),add(e,multiply(cloneObject(a.axis2),1-2*Math.random()));var n=e.y;e.y=0;var o=cloneObject(this.fitnessConfig.p0);o.y=0;cloneObject(this.fitnessConfig.pT).y=0;var s=0,r=this.gaConfig.initialScale;sub(e,o),normalize(e),multiply(e,s+(r-s)*Math.random()),s=1==this.fitnessConfig.tossSign||n>this.fitnessConfig.p0.y?0:-2*(this.fitnessConfig.p0.y-n)/this.fitnessConfig.minT,r=this.gaConfig.initialScale,e.y=s+(r-s)*Math.random()}var i=this.getBouncePath(e);return{v:e,T:i.T,fitness:i.path?magnitude(sub(cloneObject(i.path[i.path.length-1]),this.fitnessConfig.pT)):100}},BounceGA.prototype.evolve=function(){if(this.generations>=this.gaConfig.maxGenerations)this.ableToFindSolution=!1;else if(this.rankedPopulation.length>0&&this.rankedPopulation[0].fitness<=this.gaConfig.fitnessThreshold)this.ableToFindSolution=!0;else{if(0==this.rankedPopulation.length||this.gaConfig.noGA){this.rankedPopulation=[];for(var t=0;t<this.gaConfig.populationSize;t++)this.rankedPopulation.push(this.generateMember(void 0))}else{var e=0,a=[];for(t=0;t<this.rankedPopulation.length;t++)e+=1/this.rankedPopulation[t].fitness,a.push(e);var n=[];for(t=0;t<this.gaConfig.populationSize;t++)if(t<.5*this.gaConfig.populationSize)n.push(this.generateMember(void 0));else for(var o=Math.random()*e,s=0;s<a.length;s++)if(o<a[s]){n.push(this.generateMember(this.rankedPopulation[s]));break}this.rankedPopulation=n}this.rankedPopulation.sort(function(t,e){return t.fitness-e.fitness});var r=this.rankedPopulation[0];this.fittestMembers.push(r),this.generations++,this.generations%100==0&&console.log(this.generations+" "+r.fitness),this.evolve()}},function(t){t.interpolateBezierSpline=function(t,e,a,n,o,s,r){var i;if(0==e)i=t[0];else if(1==e)i=t.last();else{1==t.length&&t.push(t[0]);for(var l=[{x:t[0].x+a.dx*o,y:t[0].y+a.dy*o,z:t[0].z+a.dz*o},{x:t.last().x-n.dx*s,y:t.last().y-n.dy*s,z:t.last().z-n.dz*s}],h=[],u=[],p=0;p<t.length-1;p++){var g,d=t[p],c=t[p+1];if(0==p)v=l[0];else{var f=h[h.length-1],v={x:d.x+(d.x-f.x),y:d.y+(d.y-f.y),z:d.z+(d.z-f.z)};h.push(v)}if(p+1==t.length-1)g=l[1];else{var y=(t[p].x+t[p+1].x)/2,m=(t[p].y+t[p+1].y)/2,x=(t[p].z+t[p+1].z)/2,b=(t[p+1].x+t[p+2].x)/2,w=(t[p+1].y+t[p+2].y)/2,z=(t[p+1].z+t[p+2].z)/2,M=Math.sqrt(Math.pow(t[p].x-t[p+1].x,2)+Math.pow(t[p].y-t[p+1].y,2)+Math.pow(t[p].z-t[p+1].z,2)),P=(1-(T=M/(M+Math.sqrt(Math.pow(t[p+1].x-t[p+2].x,2)+Math.pow(t[p+1].y-t[p+2].y,2)+Math.pow(t[p+1].z-t[p+2].z,2)))))*y+T*b,C=(1-T)*m+T*w,O=(1-T)*x+T*z;g={x:c.x+(y-P),y:c.y+(m-C),z:c.z+(x-O)},h.push(g)}for(var T=0;T<=1+1e-5;T+=.02)u.push({x:Math.pow(1-T,3)*d.x+3*Math.pow(1-T,2)*T*v.x+3*(1-T)*Math.pow(T,2)*g.x+Math.pow(T,3)*c.x,y:Math.pow(1-T,3)*d.y+3*Math.pow(1-T,2)*T*v.y+3*(1-T)*Math.pow(T,2)*g.y+Math.pow(T,3)*c.y,z:Math.pow(1-T,3)*d.z+3*Math.pow(1-T,2)*T*v.z+3*(1-T)*Math.pow(T,2)*g.z+Math.pow(T,3)*c.z}),1==u.length?u.last().dist=0:u.last().dist=u[u.length-2].dist+Math.sqrt(Math.pow(u.last().x-u[u.length-2].x,2)+Math.pow(u.last().y-u[u.length-2].y,2)+Math.pow(u.last().z-u[u.length-2].z,2))}var j;if(r){var S=Math.sqrt(Math.pow(a.dx,2)+Math.pow(a.dy,2)+Math.pow(a.dz,2)),D=Math.sqrt(Math.pow(n.dx,2)+Math.pow(n.dy,2)+Math.pow(n.dz,2)),B=u.last().dist,I=siteswap.dwellDuration,A=(6*I*(D+S)-12*B)/Math.pow(I,3),R=e*I,E=S*R+.5*((D-S-.5*A*Math.pow(I,2))/I)*Math.pow(R,2)+1/6*A*Math.pow(R,3);j=0;for(p=0;p<u.length;p++)u[p].dist<=E&&(j=p)}else j=Math.floor(e*u.length);i=u[j<0?0:j]}return i}}("undefined"==typeof exports?this.Bezier={}:exports),function(t){function e(t){for(var e=0,a=0;a<t.length;a++)parseInt(t[a])?e+=parseInt(t[a]):t.charCodeAt(a)>=97&&t.charCodeAt(a)<=119&&(e+=t.charCodeAt(a)-87),"P"!=t[a]&&"S"!=t[a]||!parseInt(t[a+1])||a++,"B"!=t[a]&&"D"!=t[a]&&"T"!=t[a]&&"C"!=t[a]&&"S"!=t[a]||"{"!=t[a+1]||(a=t.indexOf("}",a));return e}var a={},n=0,o=1;t.CreateSiteswap=function(t,s){function r(t,e,a,s,i,l){if(e.match(v)){(d=e.match(f)).map(function(e,a){l=r(t,e,a,void 0,void 0,l)})}else if(e.match(c)){var h=(d=e.split(","))[0].substr(1),u=d[1].substr(0,d[1].length-1);l=r(t,h,a,!0,n,l),l=r(t,u,a,!0,o,l)}else if(e.match(g)){var d;(d=e.match(p)).map(function(e,n,o){l=r(t,e,a,void 0,i,l),n<o.length-1&&(0==l?l=x.dwellPath.length-1:l--)})}else{var y=e[0].charCodeAt(0)>=97&&e[0].charCodeAt(0)<=119?e[0].charCodeAt(0)-87:parseInt(e[0]),m=a,b=e.indexOf("P"),w=!1;b>0&&"}"!=e[b+1]&&(m=x.numJugglers>2?parseInt(e[b+1])-1:1-a,w=!0);var z,M=e.indexOf("D");z=M>0?x.beatDuration*parseFloat(e.substring(M+2,e.indexOf("}"))):x.dwellDuration;var P=0,C=[],O=e.indexOf("B");if(O>0){var T;if(T=isNaN(e[O+3])?isNaN(e[O+4])?2:4:3,"{"==e[O+1]&&void 0!=T){P=parseInt(e[O+T]);for(var j=O+T+1;j<e.length&&!isNaN(e[j]);j++){var S=parseInt(e[j]);if(S>=x.surfaces.length)throw{message:"Bounce surface index out of range"};C.push(S)}}else P=1,C=[0];if(C.length<P){var D=C.length;for(j=0;j<P-D;j++)C.push(0)}}var B=void 0;if(P>0)if(e.match("HF"))B="HF";else if(e.match("HL"))B="HL";else if(e.match("F"))B="F";else if(e.match("L"))B="L";else{var I=x.beatDuration*y-z;B=I<.68?"HF":I<1.25?"F":"L"}var A=e.indexOf("T"),R="standard";if(A>0){var E=e.substring(A+2,e.indexOf("}",A));E.match("C")?R="claw":E.match("P")&&(E="penguin")}var H=e.indexOf("C"),F="standard";if(H>0){var J=e.substring(H+2,e.indexOf("}",H));J.match("C")?F="claw":J.match("P")&&(F="penguin")}var G=y%2==1;e.length>1&&"x"==e[1]&&(G=!G),"R"==e[0]?i=o:"L"==e[0]&&(i=n);var k,L=normalize({x:.1,y:.1,z:1}),q=e.indexOf("S");if(q>0){var N=e.substring(q+2,e.indexOf("}",q)).match(/-?\d+(\.\d+)?/g);k=parseFloat(N[0]),N.length>1&&(L.x=parseFloat(N[1]),L.y=parseFloat(N[2]),L.z=parseFloat(N[3]),normalize(L))}else{var V=!0;x.props.forEach(function(t){"ball"!=t.type&&(V=!1)}),V?k=0:(k=Math.floor(y/2)+.2,w&&(k+=.1))}t.push({juggler:a,targetJuggler:m,hand:i,crossing:G,numBeats:y,siteswapStr:e,numBounces:P,bounceOrder:C,bounceType:B,numSpins:k,dwellPathIx:l,dwellDuration:z,tossType:R,catchType:F,tossOrientation:L,rotationAxis:{x:1,y:0,z:0},hold:2==y&&!G&&-1==e.indexOf("A")}),y>0&&(l==x.dwellPath.length-1?l=0:l++)}return l}function i(t,e,n,o,s){n=parseFloat(n.toFixed(2)),void 0==s&&(s={}),s.bounceType||(s.bounceType="L"),s.dt||(s.dt=.01),s.eps||(s.eps=.01),s.dv||(s.dv=.01),s.numBounces||(s.numBounces=0),s.bounceOrder||(s.bounceOrder=[0]),s.G||(s.G=-9.8),s.C||(s.C=.95),s.tries||(s.tries=1e4),s.R||(s.R=.1);var r=JSON.stringify({p0:t,p1:e,T:n,options:s});if(0==s.numBounces)return{x:t.x+(e.x-t.x)*o/n,y:t.y+(e.y-t.y-.5*s.G*n*n)*o/n+.5*s.G*o*o,z:t.z+(e.z-t.z)*o/n,dx:(e.x-t.x)/n,dy:(e.y-t.y-.5*s.G*n*n)/n+s.G*o,dz:(e.z-t.z)/n};if(void 0==a[r]){var i={p0:t,pT:e,minT:n,maxT:n,R:s.R,C:s.C,dt:s.dt,G:-9.8,numBounces:s.numBounces,surfaceBounceOrder:s.bounceOrder,tossSign:"L"==s.bounceType||"HL"==s.bounceType?1:-1,catchSign:"L"==s.bounceType||"HF"==s.bounceType?1:-1,surfaces:x.surfaces};if(ga=new BounceGA({maxGenerations:500,populationSize:50,mutationChance:.7,mutationScale:5,initialScale:40,fitnessThreshold:.05,noGA:!1},i),ga.evolve(),!ga.ableToFindSolution)throw{message:"Unable to calculate bounce path"};var l=ga.getBouncePath(ga.fittestMembers[ga.fittestMembers.length-1].v);a[r]={path:l.path,velocities:l.velocities}}var h=a[r];return{x:h.path[Math.floor((h.path.length-1)*o/n)].x,y:h.path[Math.floor((h.path.length-1)*o/n)].y,z:h.path[Math.floor((h.path.length-1)*o/n)].z,dx:h.velocities[Math.floor((h.velocities.length-1)*o/n)].x,dy:h.velocities[Math.floor((h.velocities.length-1)*o/n)].y,dz:h.velocities[Math.floor((h.velocities.length-1)*o/n)].z}}function l(t){for(var e=[],a=0;a<t.length;a++)t[a].empty||e.push(t[a]);return e}function h(t,e,a,o,s,r,i,l,h){a==n&&(s||r)&&(s.dx*=-1,r.dx*=-1);var u=Bezier.interpolateBezierSpline(t,o,s,r,i,l,h);return{x:x.jugglers[e].position.x+(a==n?-1:1)*u.x*Math.cos(x.jugglers[e].rotation)-(u.z-.4125)*Math.sin(x.jugglers[e].rotation),y:1.0125+u.y,z:x.jugglers[e].position.z+(a==n?-1:1)*u.x*Math.sin(x.jugglers[e].rotation)+(u.z-.4125)*Math.cos(x.jugglers[e].rotation)}}function u(t,e,a,o,s){T=new THREE.Vector3(t.x,t.y,t.z),R=new THREE.Vector3(e.x,e.y,e.z),C=new THREE.Vector3(0,-1,0),s==n&&(T.x*=-1,R.x*=-1);var r=new THREE.Quaternion;r.setFromAxisAngle(new THREE.Vector3(0,-1,0),a),T.applyQuaternion(r);var i=new THREE.Quaternion;i.setFromAxisAngle(new THREE.Vector3(T.z,0,-T.x),Math.acos(T.y));var l=new THREE.Quaternion;l.setFromAxisAngle(new THREE.Vector3(0,1,0),Math.acos(-R.z*T.x+R.x*T.z)),R.applyQuaternion(l);var h=new THREE.Quaternion;h.setFromAxisAngle(R,o);new THREE.Quaternion;return(new THREE.Quaternion).multiplyQuaternions(i,h)}var p,g,d,c,f,v,y,m,x={siteswap:t,validSyntax:!1,validPattern:!1,collision:void 0,multiplex:void 0,sync:void 0,pass:void 0,startingHand:o,numJugglers:void 0,numProps:void 0,maxHeight:void 0,tosses:void 0,beats:void 0,states:void 0,propOrbits:void 0,propPositions:void 0,propRotations:void 0,jugglerHandPositions:void 0,jugglerElbowPositions:void 0,jugglers:void 0,validationOnly:void 0,numStepsPerBeat:void 0,numSteps:void 0,beatDuration:void 0,dwellDuration:void 0,props:void 0,dwellPath:void 0,tossMatchVelocity:void 0,catchMatchVelocity:void 0,dwellCatchScale:void 0,dwellTossScale:void 0,emptyTossScale:void 0,emptyCatchScale:void 0,armAngle:void 0,surfaces:void 0,errorMessage:void 0,stateDiagram:void 0};return function(){t=t.replace(/\s/g,"");var e=1;if(/<[^ ]+>/.test(t)){var a=t.match(/<[^ <>]+>/g);if(1==(e=a[0].split("|").length))return x;var n=e;a.map(function(t){if(t.split("|").length!=n)return x})}var o="";2==e?o="P":e>2&&(o="P[1-"+e+"]");var s="([\\da-o])x?A?("+o+")?(C{(C|P)?})?(T{(C|P)?})?(B({\\d*(L|HL|F|HF)?\\d*})?)?(S{-?\\d+(.\\d+)?(,-?\\d+(.\\d+)?,-?\\d+(.\\d+)?,-?\\d+(.\\d+)?)?})?(D{\\d*\\.?\\d*})?",r="\\[("+s+")+\\]",i=s+"|"+r,l="\\(("+i+"),("+i+")\\)",h="("+i+"|"+l+")",u="<"+h+"(\\|"+h+")+>",b="^("+u+")+|("+h+")+\\*?$",w="<"+h+"+(\\|"+h+"+)+>";if(p=new RegExp(s,"g"),g=new RegExp(r,"g"),d=new RegExp(i,"g"),c=new RegExp(l,"g"),f=new RegExp(h,"g"),v=new RegExp(u,"g"),y=new RegExp(b,"g"),m=new RegExp(w,"g"),t.match(m)==t){for(var z="",M=t.split("|"),P=[],C=0;C<M.length;C++)P.push(M[C].match(f));for(C=0;C<P[0].length;C++){z+="<";for(var O=0;O<P.length;O++)z+=P[O][C],O<P.length-1&&(z+="|");z+=">"}t=z}if("*"==t.charAt(t.length-1)){var T=(z=t.slice(0,-1)).match(c);if(null!==T){for(C=0;C<T.length;C++)z+="("+T[C].match(d).reverse().join(",")+")";t=z}}t.match(y)==t?(x.validSyntax=!0,x.multiplex=!!t.match(g),x.sync=!!t.match(c),x.pass=!!t.match(v),x.numJugglers=e):x.errorMessage="Invalid syntax"}(),function(){function t(t,e,a){var n,o=t.match(/\(-?\d+(\.\d+)?(,-?\d+(\.\d+)?)?(,-?\d+(\.\d+)?)?/g)[0].match(/-?\d+(\.\d+)?/g),s=t.match(/\{-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?\}/g);s&&(n=s[0].match(/-?\d+(\.\d+)?/g));var r;return r=n?{x:parseFloat(n[0]),y:parseFloat(n[1]),z:parseFloat(n[2]),th:parseFloat(n[3])}:"club"==x.props[0].type?{x:4,y:0,z:0==e?-1:1,th:Math.PI/2+(0==e?.5:-.7)}:"ring"==x.props[0].type?{x:0,y:1,z:0,th:Math.PI/2}:{x:1,y:0,z:0,th:0},{x:parseFloat(o[0])/100,y:o[1]?parseFloat(o[1])/100:0,z:o[2]?parseFloat(o[2])/100:0,rotation:r,empty:a}}if(void 0===s&&(s={}),x.validationOnly=void 0!==s.validationOnly&&s.validationOnly,x.beatDuration=void 0===s.beatDuration?.2:s.beatDuration,x.dwellDuration=void 0===s.dwellRatio?.5*x.beatDuration:x.beatDuration*s.dwellRatio,x.numStepsPerBeat=void 0===s.numStepsPerBeat?Math.floor(200*x.beatDuration):s.numStepsPerBeat,x.matchVelocity=void 0!==s.matchVelocity&&s.matchVelocity,x.dwellCatchScale=void 0===s.dwellCatchScale?.05:s.dwellCatchScale,x.dwellTossScale=void 0===s.dwellTossScale?.05:s.dwellTossScale,x.emptyTossScale=void 0===s.emptyTossScale?.05:s.emptyTossScale,x.emptyCatchScale=void 0===s.emptyCatchScale?.05:s.emptyCatchScale,x.armAngle=void 0===s.armAngle?.1:s.armAngle,"L"==s.startingHand||"LEFT"==s.startingHand?x.startingHand=n:x.startingHand=o,void 0===s.props?x.props=[{type:"ball",radius:.05,C:.95}]:x.props=s.props,void 0===s.dwellPath)x.dwellPath=[[{x:.3,y:0,z:0,rotation:{x:4,y:0,z:-1,th:Math.PI/2},empty:!1},{x:.1,y:0,z:0,rotation:{x:4,y:0,z:1,th:Math.PI/2},empty:!1}]];else{var e=s.dwellPath.split(").").map(function(t,e,a){return e<a.length-1?t+")":t});x.dwellPath=[];for(var a=0;a<e.length;a++){-1==e[a].indexOf("e")&&(e[a]+="e");var r,i=e[a].split("e")[0].match(/\(-?\d+(\.\d+)?(,-?\d+(\.\d+)?)?(,-?\d+(\.\d+)?)?(,\{-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?\})?\)/g),l=e[a].split("e")[1].match(/\(-?\d+(\.\d+)?(,-?\d+(\.\d+)?)?(,-?\d+(\.\d+)?)?(,\{-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?\})?\)/g);null==l?(l=[],r=0):r=l.reduce(function(t,e){return t+e}).length,i.reduce(function(t,e){return t+e}).length==e[a].split("e")[0].length&&r==e[a].split("e")[1].length?x.dwellPath.push(i.map(function(e,a){return t(e,a,!1)}).concat(l.map(function(e,a){return t(e,a,!0)}))):x.errorMessage="Invalid custom dwell path"}}if(void 0===s.surfaces?x.surfaces=[{position:{x:0,y:0,z:0},normal:{x:0,y:1,z:0},scale:5,color:"grey"}]:x.surfaces=s.surfaces,x.jugglers=[],void 0===s.jugglers||x.numJugglers!=s.jugglers.length)if(1==x.numJugglers)x.jugglers.push({position:{x:0,z:-2*a},rotation:a*Math.PI,color:"grey"});else for(a=0;a<x.numJugglers;a++){var h=2*a*Math.PI/x.numJugglers;x.jugglers.push({position:{x:Math.cos(h),z:Math.sin(h)},rotation:h-Math.PI/2,color:"grey"})}else for(a=0;a<s.jugglers.length;a++)x.jugglers.push({position:s.jugglers[a].position,rotation:s.jugglers[a].rotation,color:s.jugglers[a].color});for(a=0;a<x.surfaces.length;a++){var u=x.surfaces[a];normalize(u.normal);var p;p=0==u.normal.x&&0==u.normal.z?{x:1,y:0,z:0}:{x:-u.normal.z,y:0,z:u.normal.x};var g=cross(u.normal,p);normalize(p),multiply(p,u.scale),normalize(g),multiply(g,u.scale),u.axis1=p,u.axis2=g}}(),x.errorMessage?x:(function(){x.beats=x.pass?t.match(v):t.match(f);for(var a=0;a<x.beats.length;a++)x.beats[a].match(c)&&(x.beats.splice(a+1,0,"(0,0)"),a++);var s=0;if(x.beats.map(function(t){if(t.match(v))for(var a=t.split("|"),n=0;n<a.length;n++)0==n&&(a[n]=a[n].substr(1)),n==a.length-1&&(a[n]=a[n].substr(0,a[n].length-1)),s+=e(a[n]);else s+=e(t)}),s/x.beats.length%1==0&&s/x.beats.length>0){for(x.numProps=s/x.beats.length;x.props.length<x.numProps;)x.props.push(cloneObject(x.props.last()));for(;x.props.length>x.numProps;)x.props.pop();x.tosses=[];var i=0;for(a=0;a<x.beats.length;a++){var l=[];i=r(l,x.beats[a],0,0,void 0,i),x.tosses.push(l),a==x.beats.length-1&&0!=i&&(a=-1)}for(x.maxHeight=0,a=0;a<x.tosses.length;a++)for(var h=0;h<x.tosses[a].length;h++)x.tosses[a][h].numBeats>x.maxHeight&&(x.maxHeight=x.tosses[a][h].numBeats);var u=[];for(a=0;a<x.numProps;a++)u.push(a);x.states=[],x.propOrbits=[],x.stateDiagram=[];var p=[];for(h=0;h<x.numJugglers;h++){p.push([[],[]]);for(var g=0;g<x.maxHeight;g++)p[h][n].push(void 0),p[h][o].push(void 0)}for(var d=!1,y=!1,m=0,b=0,w=x.startingHand;!d;){x.stateDiagram.push([1==w?"R":"L"]),0==m&&y&&(x.stateDiagram[b][0]+="*");var z=cloneObject(x.propOrbits),M=[];for(h=0;h<x.numJugglers;h++){var P=p[h][n].shift();if(P)for(g=0;g<P.length;g++)M.push({propId:P[g],juggler:h,hand:n});var C=p[h][o].shift();if(C)for(g=0;g<C.length;g++)M.push({propId:C[g],juggler:h,hand:o});p[h][n].push(void 0),p[h][o].push(void 0)}var O="";for(h=0;h<x.tosses[m%x.tosses.length].length;h++){var T=x.tosses[m%x.tosses.length][h],j=void 0==T.hand?w:T.hand,S=T.crossing?1-j:j,D=void 0;for(g=0;g<M.length;g++)if(M[g].juggler==T.juggler&&M[g].hand==j){if(0==T.numBeats)return void(x.errorMessage="Prop landing on 0 toss at beat "+m);D=M.splice(g,1)[0].propId;break}if(void 0==D&&T.numBeats>0&&(D=u.shift()),void 0==D&&T.numBeats>0)return void(x.errorMessage="No prop available to toss at beat "+m);O+=(void 0===D?"X":D)+"-"+T.siteswapStr,h<x.tosses[m%x.tosses.length].length-1&&(O+=","),T.numBeats>0&&(z[D]||(z[D]=[]),z[D].push({beat:m,numBeats:T.numBeats,juggler:T.juggler,hand:j,numBounces:T.numBounces,bounceType:T.bounceType,bounceOrder:T.bounceOrder,numSpins:T.numSpins,dwellPathIx:T.dwellPathIx,dwellDuration:T.dwellDuration,tossType:T.tossType,catchType:T.catchType,tossOrientation:T.tossOrientation,rotationAxis:T.rotationAxis,hold:T.hold}),void 0==p[T.targetJuggler][S][T.numBeats-1]?p[T.targetJuggler][S][T.numBeats-1]=[D]:p[T.targetJuggler][S][T.numBeats-1].push(D))}if(x.stateDiagram[b].push(O),p[0][0].map(function(t){void 0==t?x.stateDiagram[b].push("X"):x.stateDiagram[b].push(t.reduce(function(t,e){return t.toString()+e.toString()}))}),p[0][1].map(function(t){void 0==t?x.stateDiagram[b].push("X"):x.stateDiagram[b].push(t.reduce(function(t,e){return t.toString()+e.toString()}))}),y&&m%x.tosses.length==0&&arraysEqual(x.states[0],p)?d=!0:(x.states.push(cloneObject(p)),x.propOrbits=z),0!=u.length||(m+1)%x.tosses.length!=0||y||(y=!0,m=-1,x.states=[],x.propOrbits=[]),m++,b++,w=1-w,m>1e3)return void(x.errorMessage="Pattern took more than 1000 beats to repeat states")}for(a=0;a<x.tosses.length;a++)for(h=0;h<x.tosses[a].length;h++)x.tosses[a][h].numBeats>0&&x.tosses[a][h].dwellDuration>=x.beatDuration*x.tosses[a][h].numBeats&&(x.errorMessage="Cannot have a '1' toss with a dwellRatio >= 1");x.numSteps=x.states.length*x.numStepsPerBeat,x.validPattern=!0}else x.errorMessage="Cannot determine number of props"}(),x.errorMessage?x:(x.validationOnly||function(){try{a={};for(var t=[],e=0;e<x.numProps;e++)t.push([]);var s=[];for(e=0;e<x.numProps;e++)s.push([]);var r=[];for(e=0;e<x.numJugglers;e++)r.push([[],[]]);var p=[];for(e=0;e<x.numJugglers;e++)p.push([[],[]]);for(var g=0;g<x.numSteps;g++){var d=[];for(e=0;e<x.numJugglers;e++)d.push([void 0,void 0]);for(var c=Math.floor(g*x.states.length/x.numSteps),f=x.beatDuration*g*x.states.length/x.numSteps,v=0;v<x.numProps;v++){var y=void 0,m=void 0,b=void 0,w=!1;for(e=0;e<x.propOrbits[v].length;e++)!w&&(e==x.propOrbits[v].length-1||x.propOrbits[v][e].beat<=c&&x.propOrbits[v][e+1].beat>c)&&(y=x.propOrbits[v].getPreviousCyclic(e),m=x.propOrbits[v][e],b=x.propOrbits[v].getNextCyclic(e),w=!0);var z=m.beat*x.beatDuration+m.dwellDuration,M=b.beat*x.beatDuration;z>M&&M<=f?M+=x.beatDuration*x.states.length:z>M&&M>f&&(z-=x.beatDuration*x.states.length);var P=y.beat*x.beatDuration+y.dwellDuration,C=m.beat*x.beatDuration;if(P>C&&C<=f?C+=x.beatDuration*x.states.length:P>C&&C>f&&(P-=x.beatDuration*x.states.length),f<z){var O=[],T=[];if(x.multiplex)for(e=0;e<x.propOrbits.length;e++)if(e!=v)for(j=0;j<x.propOrbits[e].length;j++){var S=x.propOrbits[e][j];if(m.beat==S.beat&&m.juggler==S.juggler&&m.hand==S.hand){var D=j==x.propOrbits[e].length-1?x.propOrbits[e][0]:x.propOrbits[e][j+1],B=0==j?x.propOrbits[e][x.propOrbits[e].length-1]:x.propOrbits[e][j-1],I=S.beat*x.beatDuration+S.dwellDuration,A=D.beat*x.beatDuration;I>A&&A<=f?A+=x.beatDuration*x.states.length:I>A&&A>f&&(I-=x.beatDuration*x.states.length);var R=B.beat*x.beatDuration+B.dwellDuration,E=S.beat*x.beatDuration;R>E&&E<=f?E+=x.beatDuration*x.states.length:R>E&&E>f&&(R-=x.beatDuration*x.states.length),O.push(i(h(l(x.dwellPath[S.dwellPathIx]),S.juggler,S.hand,1),h(l(x.dwellPath[D.dwellPathIx]),D.juggler,D.hand,0),A-I,0,{numBounces:S.numBounces,bounceType:S.bounceType,bounceOrder:S.bounceOrder,R:x.props[e].radius,C:x.props[e].C})),T.push(i(h(l(x.dwellPath[B.dwellPathIx]),B.juggler,B.hand,1),h(l(x.dwellPath[S.dwellPathIx]),S.juggler,S.hand,0),E-R,E-R,{numBounces:B.numBounces,bounceType:B.bounceType,bounceOrder:B.bounceOrder,R:x.props[e].radius,C:x.props[e].C}))}}O.push(i(h(l(x.dwellPath[m.dwellPathIx]),m.juggler,m.hand,1),h(l(x.dwellPath[b.dwellPathIx]),b.juggler,b.hand,0),M-z,0,{numBounces:m.numBounces,bounceType:m.bounceType,bounceOrder:m.bounceOrder,R:x.props[v].radius,C:x.props[v].C})),T.push(i(h(l(x.dwellPath[y.dwellPathIx]),y.juggler,y.hand,1),h(l(x.dwellPath[m.dwellPathIx]),m.juggler,m.hand,0),C-P,C-P,{numBounces:y.numBounces,bounceType:y.bounceType,bounceOrder:y.bounceOrder,R:x.props[v].radius,C:x.props[v].C}));var H={dx:0,dy:0,dz:0,x:0,y:0,z:0},F={dx:0,dy:0,dz:0,x:0,y:0,z:0};for(e=0;e<T.length;e++)H.dx+=T[e].dx/T.length,H.dy+=T[e].dy/T.length,H.dz+=T[e].dz/T.length,H.x+=T[e].x/T.length,H.y+=T[e].y/T.length,H.z+=T[e].z/T.length,F.dx+=O[e].dx/T.length,F.dy+=O[e].dy/T.length,F.dz+=O[e].dz/T.length,F.x+=O[e].x/T.length,F.y+=O[e].y/T.length,F.z+=O[e].z/T.length;var J=1-(z-f)/m.dwellDuration,G=h(l(x.dwellPath[m.dwellPathIx]),m.juggler,m.hand,J,H,F,x.dwellCatchScale,x.dwellTossScale),k=h(l(x.dwellPath[m.dwellPathIx]),m.juggler,m.hand,0),L=H.x-k.x,q=H.y-k.y,N=H.z-k.z;G.x+=(1-J)*L,G.y+=(1-J)*q,G.z+=(1-J)*N;var V=Math.atan2(-H.dx,-H.dy),Q=Math.atan2(F.dx,F.dy);"claw"==m.tossType?Q-=Math.PI:"penguin"==m.tossTypeId&&(Q-=2*Math.PI),"claw"==m.catchType?V-=Math.PI:"penguin"==m.catchType&&(V-=2*Math.PI),G.angle=V+J*(Q-V),m.hand==o&&(G.angle*=-1),G.dwell=!0,t[v].push(G),void 0==d[m.juggler][m.hand]&&(d[m.juggler][m.hand]=G);var U=u(y.tossOrientation,y.rotationAxis,x.jugglers[y.juggler].rotation,2*y.numSpins*Math.PI,y.hand),X=u(m.tossOrientation,m.rotationAxis,x.jugglers[m.juggler].rotation,0,m.hand);U.slerp(X,J),s[v].push(U)}else if(m.hold){var $=[x.dwellPath[m.dwellPathIx].last(),x.dwellPath[b.dwellPathIx][0]],K=m.numBeats*x.beatDuration-m.dwellDuration,W=i(h(l(x.dwellPath[m.dwellPathIx]),m.juggler,m.hand,1),h(l(x.dwellPath[b.dwellPathIx]),b.juggler,b.hand,0),K,0),Y=i(h(l(x.dwellPath[m.dwellPathIx]),m.juggler,m.hand,1),h(l(x.dwellPath[b.dwellPathIx]),b.juggler,b.hand,0),K,K);G=h(l($),m.juggler,m.hand,(f-z)/(M-z),W,Y,x.emptyTossScale,x.emptyCatchScale),V=Math.atan2(-W.dx,-W.dy),Q=Math.atan2(Y.dx,Y.dy),"claw"==m.tossType?Q-=Math.PI:"penguin"==m.tossTypeId&&(Q-=2*Math.PI),"claw"==m.catchType?V-=Math.PI:"penguin"==m.catchType&&(V-=2*Math.PI),G.angle=V+(f-(z-m.dwellDuration))/(M-(z-m.dwellDuration))*(Q-V),m.hand==o&&(G.angle*=-1),G.dwell=!0,t[v].push(G),void 0==d[m.juggler][m.hand]&&(d[m.juggler][m.hand]=G),U=u(m.tossOrientation,m.rotationAxis,x.jugglers[m.juggler].rotation,0,m.hand),X=u(b.tossOrientation,b.rotationAxis,x.jugglers[b.juggler].rotation,0,b.hand),U.slerp(X,(f-(z-m.dwellDuration))/(M-(z-m.dwellDuration))),s[v].push(U)}else{K=M-z,J=f-z,(G=i(h(l(x.dwellPath[m.dwellPathIx]),m.juggler,m.hand,1),h(l(x.dwellPath[b.dwellPathIx]),b.juggler,b.hand,0),K,J,{numBounces:m.numBounces,bounceType:m.bounceType,bounceOrder:m.bounceOrder,R:x.props[v].radius,C:x.props[v].C})).dwell=!1,t[v].push(G);var Z=0+J/K*(2*m.numSpins*Math.PI-0);s[v].push(u(m.tossOrientation,m.rotationAxis,x.jugglers[m.juggler].rotation,Z,m.hand))}}for(var _=0;_<x.numJugglers;_++)for(var tt=0;tt<=1;tt++){if(void 0==d[_][tt]){b=void 0;var et=void 0,at=void 0,nt=void 0,ot=void 0,st=void 0,rt=void 0,it=void 0,lt=void 0,ht=void 0,ut=void 0,pt=void 0,gt=void 0,dt=void 0;for(v=0;v<x.propOrbits.length;v++)for(var ct=0;ct<x.propOrbits[v].length;ct++)x.propOrbits[v][ct].juggler==_&&x.propOrbits[v][ct].hand==tt&&((void 0==et||x.propOrbits[v][ct].beat<et.beat)&&(et=x.propOrbits[v][ct],ot=v,st=ct),x.propOrbits[v][ct].beat>c&&(void 0==b||x.propOrbits[v][ct].beat<b.beat)&&(b=x.propOrbits[v][ct],rt=v,it=ct),(void 0==nt||x.propOrbits[v][ct].beat>nt.beat)&&(nt=x.propOrbits[v][ct],lt=v,ht=ct),x.propOrbits[v][ct].beat<=c&&(void 0==at||x.propOrbits[v][ct].beat>at.beat)&&(at=x.propOrbits[v][ct],ut=v,pt=ct));if(void 0==b&&(b=et,rt=ot,it=st),void 0==at&&(at=nt,ut=lt,pt=ht),void 0==b&&void 0==at)(G=h([{x:.2,y:0,z:0}],_,tt,0)).angle=0;else{gt=0==it?x.propOrbits[rt].last():x.propOrbits[rt][it-1],dt=pt==x.propOrbits[ut].length-1?x.propOrbits[ut][0]:x.propOrbits[ut][pt+1];var ft=b.beat*x.beatDuration;ft<f&&(ft+=x.beatDuration*x.states.length);var vt=at.beat*x.beatDuration+at.dwellDuration;vt>f&&(vt-=x.beatDuration*x.states.length);var yt=dt.beat*x.beatDuration;yt<vt&&(yt+=x.beatDuration*x.states.length);var mt=gt.beat*x.beatDuration+gt.dwellDuration;mt>ft&&(mt-=x.beatDuration*x.states.length),W=i(h(l(x.dwellPath[at.dwellPathIx]),at.juggler,at.hand,1),h(l(x.dwellPath[dt.dwellPathIx]),dt.juggler,dt.hand,0),at.numBeats*x.beatDuration-at.dwellDuration,0,{numBounces:at.numBounces,bounceType:at.bounceType,bounceOrder:at.bounceOrder,R:x.props[ut].radius,C:x.props[ut].C}),Y=i(h(l(x.dwellPath[gt.dwellPathIx]),gt.juggler,gt.hand,1),h(l(x.dwellPath[b.dwellPathIx]),b.juggler,b.hand,0),gt.numBeats*x.beatDuration-gt.dwellDuration,gt.numBeats*x.beatDuration-gt.dwellDuration,{numBounces:gt.numBounces,bounceType:gt.bounceType,bounceOrder:gt.bounceOrder,R:x.props[rt].radius,C:x.props[rt].C}),J=(f-vt)/(ft-vt);var xt=[],bt=x.dwellPath[at.dwellPathIx];for(e=0;e<bt.length;e++)bt[e].empty&&(0==xt.length&&xt.push(bt[e-1]),xt.push(bt[e]));0==xt.length&&xt.push(bt.last()),xt.push(x.dwellPath[b.dwellPathIx][0]),G=h(xt,at.juggler,at.hand,J,W,Y,x.emptyTossScale,x.emptyCatchScale);var wt=h(xt,at.juggler,at.hand,1),zt=Y.x-wt.x,Mt=Y.y-wt.y,Pt=Y.z-wt.z;G.x+=J*zt,G.y+=J*Mt,G.z+=J*Pt,V=Math.atan2(-Y.dx,-Y.dy),Q=Math.atan2(W.dx,W.dy),"claw"==at.tossType?Q-=Math.PI:"penguin"==at.tossType&&(Q-=2*Math.PI),"claw"==b.catchType?V-=Math.PI:"penguin"==b.catchType&&(V-=2*Math.PI),G.angle=Q+J*(V-Q),tt==o&&(G.angle*=-1)}d[_][tt]=G}r[_][tt].push(d[_][tt]),p[_][tt].push(function(t,e,a,n,o){n*=-1;var s={};s.x=e.x-t.x,s.y=e.y-t.y,s.z=e.z-t.z;var r={};r.x=Math.sqrt(s.x*s.x+s.z*s.z),r.y=s.y,r.z=0;var i=Math.atan2(s.z,s.x),l=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);2*a<l&&(a=l/2);var h={};h.x=r.y/l,h.y=-r.x/l,h.z=0;var u={x:0,y:0};u.z=1==o?-1:1;var p=Math.sqrt(a*a-.25*l*l),g={};g.x=r.x/2+p*h.x*Math.cos(n)+p*u.x*Math.sin(n),g.y=r.y/2+p*h.y*Math.cos(n)+p*u.y*Math.sin(n),g.z=r.z/2+p*h.z*Math.cos(n)+p*u.z*Math.sin(n);var d={};d.x=g.x*Math.cos(i)-g.z*Math.sin(i),d.y=g.y,d.z=g.x*Math.sin(i)+g.z*Math.cos(i);var c={};return c.x=d.x+t.x,c.y=d.y+t.y,c.z=d.z+t.z,c}({x:x.jugglers[_].position.x+Math.cos(x.jugglers[_].rotation)*(tt==n?-1:1)*.225,y:1.425,z:x.jugglers[_].position.z+Math.sin(x.jugglers[_].rotation)*(tt==n?-1:1)*.225},d[_][tt],.45,x.armAngle,tt))}}x.propPositions=t,x.propRotations=s,x.jugglerHandPositions=r,x.jugglerElbowPositions=p,x.collision=function(){for(var t,e,a=0;a<x.propPositions.length;a++){t=x.props[a].radius;for(var n=0;n<x.propPositions[a].length;n++)for(var o=a+1;o<x.propPositions.length;o++)if(e=x.props[a].radius,Math.sqrt(Math.pow(x.propPositions[a][n].x-x.propPositions[o][n].x,2)+Math.pow(x.propPositions[a][n].y-x.propPositions[o][n].y,2)+Math.pow(x.propPositions[a][n].z-x.propPositions[o][n].z,2))<=t+e)return!0}return!1}()}catch(t){x.errorMessage=t.message}}(),x))}}("undefined"==typeof exports?this.SiteswapJS={}:exports);