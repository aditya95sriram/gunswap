function getURLQueryStringParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function cloneObject(a){var b=a instanceof Array?[]:{};for(var c in a)"clone"!=c&&(b[c]=a[c]&&"object"==typeof a[c]?cloneObject(a[c]):a[c]);return b}function arraysEqual(a,b){if(!(a instanceof Array&&b instanceof Array))return!1;if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]instanceof Array||b[c]instanceof Array){var d=arraysEqual(a[c],b[c]);if(!d)return!1}else if(a[c]!=b[c])return!1;return!0}function cross(a,b){return{x:a.y*b.z-a.z*b.y,y:a.z*b.x-a.x*b.z,z:a.x*b.y-a.y*b.x}}function dot(a,b){return a.x*b.x+a.y*b.y+a.z*b.z}function magnitude(a){return Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z)}function normalize(a){var b=magnitude(a);return a.x=a.x/b,a.y=a.y/b,a.z=a.z/b,a}function multiply(a,b){return a.x*=b,a.y*=b,a.z*=b,a}function add(a,b){return a.x+=b.x,a.y+=b.y,a.z+=b.z,a}function sub(a,b){return a.x-=b.x,a.y-=b.y,a.z-=b.z,a}function negate(a){return multiply(a,-1),a}function BounceGA(a,b){if(this.gaConfig=a,this.fitnessConfig=b,void 0===b.axis1)for(var c=0;c<this.fitnessConfig.surfaces.length;c++){var d=this.fitnessConfig.surfaces[c];normalize(d.normal);var e;e=0==d.normal.x&&0==d.normal.z?{x:1,y:0,z:0}:{x:-d.normal.z,y:0,z:d.normal.x};var f=cross(d.normal,e);normalize(e),normalize(f),multiply(e,d.scale),multiply(f,d.scale),d.axis1=e,d.axis2=f}this.generations=0,this.rankedPopulation=[],this.fittestMembers=[],this.ableToFindSolution=void 0}Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]}),BounceGA.prototype.getBouncePath=function(a){var b=cloneObject(this.fitnessConfig.p0),c=cloneObject(a),d=[],e=[];d.push(cloneObject(b)),e.push(cloneObject(c));for(var f=0;f<this.fitnessConfig.surfaces.length;f++)this.fitnessConfig.surfaces[f].bounces=0,this.fitnessConfig.surfaces[f].colliding=!1;for(var g=0,h=[],i=[],j=0;j<=this.fitnessConfig.maxT;j+=this.fitnessConfig.dt){add(b,multiply(cloneObject(c),this.fitnessConfig.dt)),c.y+=this.fitnessConfig.G*this.fitnessConfig.dt,d.push(cloneObject(b)),e.push(cloneObject(c));for(var f=0;f<this.fitnessConfig.surfaces.length;f++){var k=this.fitnessConfig.surfaces[f],l=k.normal.x*b.x+k.normal.y*b.y+k.normal.z*b.z-k.normal.x*k.position.x-k.normal.y*k.position.y-k.normal.z*k.position.z;if(Math.abs(l)<=this.fitnessConfig.R&&Math.abs(dot(sub(cloneObject(b),k.position),normalize(cloneObject(k.axis1))))<=k.scale&&Math.abs(dot(sub(cloneObject(b),k.position),normalize(cloneObject(k.axis2))))<=k.scale&&!k.colliding){k.colliding=!0,k.bounces++,h.push(f),g++;var m=(new THREE.Vector3).copy(k.normal),m=cloneObject(k.normal);multiply(m,dot(c,k.normal)),multiply(m,2*this.fitnessConfig.C),negate(m),add(c,m)}else Math.abs(l)>this.fitnessConfig.R&&k.colliding&&(k.colliding=!1)}if(j>=this.fitnessConfig.minT||j+this.fitnessConfig.dt>this.fitnessConfig.maxT){var n=!0;this.fitnessConfig.surfaceBounceOrder&&h.toString()!=this.fitnessConfig.surfaceBounceOrder.toString()&&(n=!1);var o=!1;g==this.fitnessConfig.numBounces&&(o=!0),n&&o&&(1==this.fitnessConfig.catchSign&&c.y>=0||-1==this.fitnessConfig.catchSign&&c.y<=0||void 0==this.fitnessConfig.catchSign)&&(1==this.fitnessConfig.tossSign&&a.y>=0||-1==this.fitnessConfig.tossSign&&a.y<=0||void 0==this.fitnessConfig.tossSign)&&i.push({pT:cloneObject(b),T:j,actualpT:this.fitnessConfig.pT})}}return i.length>0?(i.sort(function(a,b){return magnitude(sub(cloneObject(a.pT),a.actualpT))-magnitude(sub(cloneObject(b.pT),a.actualpT))}),{path:d.splice(0,i[0].T/this.fitnessConfig.dt),velocities:e.splice(0,i[0].T/this.fitnessConfig.dt),T:i[0].T}):{path:void 0,velocities:void 0,T:void 0}},BounceGA.prototype.generateMember=function(a){var b={x:0,y:0,z:0};if(a&&a.fitness<100)Math.random()<this.gaConfig.mutationChance?(b.x=(1-2*Math.random())*(a.fitness<this.gaConfig.mutationScale?a.fitness:this.gaConfig.mutationScale),b.y=(1-2*Math.random())*(a.fitness<this.gaConfig.mutationScale?a.fitness:this.gaConfig.mutationScale),b.z=(1-2*Math.random())*(a.fitness<this.gaConfig.mutationScale?a.fitness:this.gaConfig.mutationScale),add(b,a.v)):b=cloneObject(a.v);else{var c;c=this.fitnessConfig.surfaceBounceOrder?this.fitnessConfig.surfaces[this.fitnessConfig.surfaceBounceOrder[0]]:this.fitnessConfig.surfaces[Math.floor(Math.random()*this.fitnessConfig.surfaces.length)],b=cloneObject(c.position),add(b,multiply(cloneObject(c.axis1),1-2*Math.random())),add(b,multiply(cloneObject(c.axis2),1-2*Math.random()));var d=b.y;b.y=0;var e=cloneObject(this.fitnessConfig.p0);e.y=0;var f=cloneObject(this.fitnessConfig.pT);f.y=0;var g=0,h=this.gaConfig.initialScale;sub(b,e),normalize(b),multiply(b,g+(h-g)*Math.random()),g=1==this.fitnessConfig.tossSign||d>this.fitnessConfig.p0.y?0:-(2*(this.fitnessConfig.p0.y-d)/this.fitnessConfig.minT),h=this.gaConfig.initialScale,b.y=g+(h-g)*Math.random()}var i=this.getBouncePath(b);return{v:b,T:i.T,fitness:i.path?magnitude(sub(cloneObject(i.path[i.path.length-1]),this.fitnessConfig.pT)):100}},BounceGA.prototype.evolve=function(){if(this.generations>=this.gaConfig.maxGenerations)this.ableToFindSolution=!1;else if(this.rankedPopulation.length>0&&this.rankedPopulation[0].fitness<=this.gaConfig.fitnessThreshold)this.ableToFindSolution=!0;else{if(0==this.rankedPopulation.length||this.gaConfig.noGA){this.rankedPopulation=[];for(var a=0;a<this.gaConfig.populationSize;a++)this.rankedPopulation.push(this.generateMember(void 0))}else{for(var b=0,c=[],a=0;a<this.rankedPopulation.length;a++)b+=1/this.rankedPopulation[a].fitness,c.push(b);for(var d=[],a=0;a<this.gaConfig.populationSize;a++)if(a<.5*this.gaConfig.populationSize)d.push(this.generateMember(void 0));else for(var e=Math.random()*b,f=0;f<c.length;f++)if(e<c[f]){d.push(this.generateMember(this.rankedPopulation[f]));break}this.rankedPopulation=d}this.rankedPopulation.sort(function(a,b){return a.fitness-b.fitness});var g=this.rankedPopulation[0];this.fittestMembers.push(g),this.generations++,this.generations%100==0&&console.log(this.generations+" "+g.fitness),this.evolve()}},function(a){function b(a){var c=a instanceof Array?[]:{};for(var d in a)"clone"!=d&&(c[d]=a[d]&&"object"==typeof a[d]?b(a[d]):a[d]);return c}function c(a,b){if(!(a instanceof Array&&b instanceof Array))return!1;if(a.length!=b.length)return!1;for(var d=0;d<a.length;d++)if(a[d]instanceof Array||b[d]instanceof Array){var e=c(a[d],b[d]);if(!e)return!1}else if(a[d]!=b[d])return!1;return!0}function d(a,b){return{x:a.y*b.z-a.z*b.y,y:a.z*b.x-a.x*b.z,z:a.x*b.y-a.y*b.x}}function e(a){return Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z)}function f(a){var b=e(a);return a.x=a.x/b,a.y=a.y/b,a.z=a.z/b,a}function g(a,b){return a.x*=b,a.y*=b,a.z*=b,a}function h(a){for(var b=0,c=0;c<a.length;c++)parseInt(a[c])?b+=parseInt(a[c]):a.charCodeAt(c)>=97&&a.charCodeAt(c)<=119&&(b+=a.charCodeAt(0)-87),"P"!=a[c]&&"S"!=a[c]||!parseInt(a[c+1])||c++,"B"==a[c]&&"{"==a[c+1]&&(c=a.indexOf("}",c)+1);return b}function i(a,e){function i(){void 0===e&&(e={}),z.validationOnly=void 0===e.validationOnly?!1:e.validationOnly,z.beatDuration=void 0===e.beatDuration?.2:e.beatDuration,z.dwellDuration=void 0===e.dwellRatio?.5*z.beatDuration:z.beatDuration*e.dwellRatio,z.numStepsPerBeat=void 0===e.numStepsPerBeat?Math.floor(100*z.beatDuration):e.numStepsPerBeat,z.matchVelocity=void 0===e.matchVelocity?!1:e.matchVelocity,z.dwellCatchScale=void 0===e.dwellCatchScale?.05:e.dwellCatchScale,z.dwellTossScale=void 0===e.dwellTossScale?.05:e.dwellTossScale,z.emptyTossScale=void 0===e.emptyTossScale?.05:e.emptyTossScale,z.emptyCatchScale=void 0===e.emptyCatchScale?.05:e.emptyCatchScale,z.armAngle=void 0===e.armAngle?.1:e.armAngle,z.props=void 0===e.props?[{type:"ball",radius:.05,C:.95}]:e.props,z.dwellPath=void 0===e.dwellPath?[[{x:.3,y:0,z:0,rotation:{x:4,y:0,z:-1,th:Math.PI/2}},{x:.1,y:0,z:0,rotation:{x:4,y:0,z:1,th:Math.PI/2}}]]:e.dwellPath,z.surfaces=void 0===e.surfaces?[{position:{x:0,y:0,z:0},normal:{x:0,y:1,z:0},scale:5}]:e.surfaces;for(var a=0;a<z.surfaces.length;a++){var b=z.surfaces[a];f(b.normal);var c;c=0==b.normal.x&&0==b.normal.z?{x:1,y:0,z:0}:{x:-b.normal.z,y:0,z:b.normal.x};var h=d(b.normal,c);f(c),g(c,b.scale),f(h),g(h,b.scale),b.axis1=c,b.axis2=h}}function m(){var b=1,c=/<[^ ]+>/.test(a);if(c){var d=a.match(/<[^ <>]+>/g);if(b=d[0].split("|").length,1==b)return z;var e=b;d.map(function(a){return a.split("|").length!=e?z:void 0})}var f="";2==b?f="P":b>2&&(f="P[1-"+b+"]");var g="(R|L)?([\\da-o])x?("+f+")?(B({\\d*(L|HL|F|HF)?})?)?(S\\d?)?",h="\\[("+g+")+\\]",i="\\(("+g+"|"+h+"),("+g+"|"+h+")\\)",j="("+g+"|"+h+"|"+i+")",k="<"+j+"(\\|"+j+")+>",l="^("+k+")+|("+j+")+$";t=new RegExp(g,"g"),u=new RegExp(h,"g"),v=new RegExp(i,"g"),w=new RegExp(j,"g"),x=new RegExp(k,"g"),y=new RegExp(l,"g"),a.match(y)?(z.validSyntax=!0,z.multiplex=a.match(u)?!0:!1,z.sync=a.match(v)?!0:!1,z.pass=a.match(x)?!0:!1,z.numJugglers=b):z.errorMessage="Invalid syntax"}function n(a,b,c,d,e,f){if(b.match(x)){var g=b.match(w);g.map(function(b,c){f=n(a,b,c,void 0,void 0,f)})}else if(b.match(v)){var g=b.split(",");f=n(a,g[0].substr(1),c,!0,k,f),f=n(a,g[1].substr(0,g.length),c,!0,l,f)}else if(b.match(u)){var g=b.match(t);g.map(function(b){f=n(a,b,c,void 0,void 0,f)})}else{var h=b[0].charCodeAt(0)>=97&&b[0].charCodeAt(0)<=119?b[0].charCodeAt(0)-87:parseInt(b[0]),i=c,j=b.indexOf("P");j>0&&(i=z.numJugglers>2?parseInt(b[j+1])-1:1-c);var m=0,o=[],p=b.indexOf("B");if(p>0){if("{"!=b[p+1]||isNaN(b[p+2]))m=1,o=[0];else{m=parseInt(b[p+2]);for(var q=p+3;q<b.length&&!isNaN(b[q]);q++){var r=parseInt(b[q]);if(r>=z.surfaces.length)throw{message:"Bounce surface index out of range"};o.push(r)}}if(o.length<m)for(var s=o.length,q=0;m-s>q;q++)o.push(0)}var y=void 0;m>0&&(y=b.match("HF")?"HF":b.match("HL")?"HL":b.match("F")?"F":(b.match("L"),"L"));var A=h%2==1?!0:!1;b.length>1&&"x"==b[1]&&(A=!A),"R"==b[0]?e=l:"L"==b[0]&&(e=k);var B,C=b.indexOf("S");B=C>0&&!isNaN(parseInt(b[C+1]))?parseInt(b[C+1]):Math.floor(h/2),a.push({juggler:c,targetJuggler:i,hand:e,crossing:A,numBeats:h,siteswapStr:b,numBounces:m,bounceOrder:o,bounceType:y,numSpins:B,dwellPathIx:f})}return f==z.dwellPath.length-1?f=0:f++,f}function o(){z.beats=a.match(z.pass?x:w);for(var d=0;d<z.beats.length;d++)z.beats[d].match(v)&&(z.beats.splice(d+1,0,"(0,0)"),d++);var e=0;if(z.beats.map(function(a){if(a.match(x))for(var b=a.split("|"),c=0;c<b.length;c++)0==c&&(b[c]=b[c].substr(1)),c==b.length-1&&(b[c]=b[c].substr(0,b[c].length-1)),e+=h(b[c]);else e+=h(a)}),!(e/z.beats.length%1==0&&e/z.beats.length>0))return void(z.errorMessage="Cannot determine number of props");for(z.numProps=e/z.beats.length;z.props.length<z.numProps;)z.props.push(b(z.props.last()));for(;z.props.length>z.numProps;)z.props.pop();z.tosses=[];for(var f=0,d=0;d<z.beats.length;d++){var g=[];f=n(g,z.beats[d],0,void 0,void 0,f),z.tosses.push(g),d==z.beats.length-1&&0!=f&&(d=-1)}z.maxHeight=0;for(var d=0;d<z.tosses.length;d++)for(var i=0;i<z.tosses[d].length;i++)z.tosses[d][i].numBeats>z.maxHeight&&(z.maxHeight=z.tosses[d][i].numBeats);for(var j=[],d=0;d<z.numProps;d++)j.push(d);z.states=[],z.propOrbits=[];for(var m=[],i=0;i<z.numJugglers;i++){m.push([[],[]]);for(var o=0;o<z.maxHeight;o++)m[i][k].push(void 0),m[i][l].push(void 0)}for(var p=!1,q=!1,r=0,s=k;!p;){for(var t=b(z.propOrbits),u=[],i=0;i<z.numJugglers;i++){var y=m[i][k].shift();if(y)for(var o=0;o<y.length;o++)u.push({propId:y[o],juggler:i,hand:k});var A=m[i][l].shift();if(A)for(var o=0;o<A.length;o++)u.push({propId:A[o],juggler:i,hand:l});m[i][k].push(void 0),m[i][l].push(void 0)}for(var i=0;i<z.tosses[r%z.tosses.length].length;i++){for(var B=z.tosses[r%z.tosses.length][i],C=void 0==B.hand?s:B.hand,D=B.crossing?1-C:C,E=void 0,o=0;o<u.length;o++)if(u[o].juggler==B.juggler&&u[o].hand==C){if(0==B.numBeats)return void(z.errorMessage="Prop landing on 0 toss at beat "+r);E=u.splice(o,1)[0].propId;break}if(void 0==E&&B.numBeats>0&&(E=j.shift()),void 0==E&&B.numBeats>0)return void(z.errorMessage="No prop available to toss at beat "+r);B.numBeats>0&&(t[E]||(t[E]=[]),t[E].push({beat:r,juggler:B.juggler,hand:C,numBounces:B.numBounces,bounceType:B.bounceType,bounceOrder:B.bounceOrder,numSpins:B.numSpins,dwellPathIx:B.dwellPathIx}),void 0==m[B.targetJuggler][D][B.numBeats-1]?m[B.targetJuggler][D][B.numBeats-1]=[E]:m[B.targetJuggler][D][B.numBeats-1].push(E))}if(q&&r%z.tosses.length==0&&c(z.states[0],m)?p=!0:(z.states.push(b(m)),z.propOrbits=t),0!=j.length||(r+1)%z.tosses.length!=0||q||(q=!0,r=-1,z.states=[],z.propOrbits=[]),r++,s=1-s,r>500)return void(z.errorMessage="Pattern took more than 500 beats to repeat states")}z.numSteps=z.states.length*z.numStepsPerBeat,z.validPattern=!0}function p(){j={},z.jugglers=[];for(var a=0;a<z.numJugglers;a++)z.jugglers.push({position:{x:0,z:-2*a},rotation:a*Math.PI});for(var b=[],a=0;a<z.numProps;a++)b.push([]);for(var c=[],a=0;a<z.numProps;a++)c.push([]);for(var d=[],a=0;a<z.numJugglers;a++)d.push([[],[]]);for(var e=[],a=0;a<z.numJugglers;a++)e.push([[],[]]);for(var f=0;f<z.numSteps;f++){for(var g=[],a=0;a<z.numJugglers;a++)g.push([void 0,void 0]);for(var h=Math.floor(f*z.states.length/z.numSteps),i=z.beatDuration*f*z.states.length/z.numSteps,l=0;l<z.numProps;l++){var m=void 0,n=void 0,o=void 0;1==z.propOrbits[l].length&&(m=z.propOrbits[l][0],n=z.propOrbits[l][0],o=z.propOrbits[l][0]);for(var p=!1,a=0;a<z.propOrbits[l].length-1;a++)!p&&z.propOrbits[l][a].beat<=h&&z.propOrbits[l][a+1].beat>h?(m=0==a?z.propOrbits[l][z.propOrbits[l].length-1]:z.propOrbits[l][a-1],n=z.propOrbits[l][a],o=z.propOrbits[l][a+1],p=!0):p||a!=z.propOrbits[l].length-2||(m=z.propOrbits[l][a],n=z.propOrbits[l][a+1],o=z.propOrbits[l][0]);var t=n.beat*z.beatDuration+z.dwellDuration,u=o.beat*z.beatDuration;t>=u&&u>=i&&(t-=z.beatDuration*z.states.length),t>=u&&i>u&&(u+=z.beatDuration*z.states.length);var v=m.beat*z.beatDuration+z.dwellDuration,w=n.beat*z.beatDuration;if(v>=w&&w>=i&&(v-=z.beatDuration*z.states.length),v>=w&&i>w&&(w+=z.beatDuration*z.states.length),t>i){var x=q(r(z.dwellPath[n.dwellPathIx],n.juggler,n.hand,1),r(z.dwellPath[o.dwellPathIx],o.juggler,o.hand,0),u-t,0,{numBounces:n.numBounces,bounceType:n.bounceType,bounceOrder:n.bounceOrder,R:z.props[l].radius,C:z.props[l].C}),y=q(r(z.dwellPath[m.dwellPathIx],m.juggler,m.hand,1),r(z.dwellPath[n.dwellPathIx],n.juggler,n.hand,0),w-v,w-v,{numBounces:m.numBounces,bounceType:m.bounceType,bounceOrder:m.bounceOrder,R:z.props[l].radius,C:z.props[l].C}),A=1-(t-i)/z.dwellDuration,B=r(z.dwellPath[n.dwellPathIx],n.juggler,n.hand,A,y,x,z.dwellCatchScale,z.dwellTossScale),C=r(z.dwellPath[n.dwellPathIx],n.juggler,n.hand,0),D={x:y.x-C.x,y:y.y-C.y,z:y.z-C.z};B.x+=(1-A)*D.x,B.y+=(1-A)*D.y,B.z+=(1-A)*D.z,B.dwell=!0,b[l].push(B),void 0==g[n.juggler][n.hand]&&(g[n.juggler][n.hand]=B),c[l].push({x:z.dwellPath[n.dwellPathIx][0].rotation.x+(z.dwellPath[n.dwellPathIx].last().rotation.x-z.dwellPath[n.dwellPathIx][0].rotation.x)*A,y:z.dwellPath[n.dwellPathIx][0].rotation.y+(z.dwellPath[n.dwellPathIx].last().rotation.y-z.dwellPath[n.dwellPathIx][0].rotation.y)*A,z:(n.hand==k?1:-1)*z.dwellPath[n.dwellPathIx][0].rotation.z+((n.hand==k?1:-1)*z.dwellPath[n.dwellPathIx].last().rotation.z-(n.hand==k?1:-1)*z.dwellPath[n.dwellPathIx][0].rotation.z)*A,th:z.dwellPath[n.dwellPathIx][0].rotation.th+(z.dwellPath[n.dwellPathIx].last().rotation.th-z.dwellPath[n.dwellPathIx][0].rotation.th)*A})}else{var E=u-t,A=i-t,B=q(r(z.dwellPath[n.dwellPathIx],n.juggler,n.hand,1),r(z.dwellPath[o.dwellPathIx],o.juggler,o.hand,0),E,A,{numBounces:n.numBounces,bounceType:n.bounceType,bounceOrder:n.bounceOrder,R:z.props[l].radius,C:z.props[l].C});B.dwell=!1,b[l].push(B);var F=2*n.numSpins*Math.PI,G=0,H=G+A/E*(F-G);"ring"==z.props[l].type&&(H=0),c[l].push({x:z.dwellPath[n.dwellPathIx].last().rotation.x+(z.dwellPath[o.dwellPathIx][0].rotation.x-z.dwellPath[n.dwellPathIx].last().rotation.x)*(A/E),y:z.dwellPath[n.dwellPathIx].last().rotation.y+(z.dwellPath[o.dwellPathIx][0].rotation.y-z.dwellPath[n.dwellPathIx].last().rotation.y)*(A/E),z:(n.hand==k?1:-1)*z.dwellPath[n.dwellPathIx].last().rotation.z+((o.hand==k?1:-1)*z.dwellPath[o.dwellPathIx][0].rotation.z-(n.hand==k?1:-1)*z.dwellPath[n.dwellPathIx].last().rotation.z)*(A/E),th:H+z.dwellPath[n.dwellPathIx].last().rotation.th+(z.dwellPath[o.dwellPathIx][0].rotation.th-z.dwellPath[n.dwellPathIx].last().rotation.th)*(A/E)})}}for(var I=0;I<z.numJugglers;I++)for(var J=0;1>=J;J++){if(void 0==g[I][J]){for(var o=void 0,K=void 0,L=void 0,M=void 0,N=void 0,O=void 0,P=void 0,Q=void 0,R=void 0,S=void 0,T=void 0,U=void 0,V=void 0,W=void 0,l=0;l<z.propOrbits.length;l++)for(var X=0;X<z.propOrbits[l].length;X++)z.propOrbits[l][X].juggler==I&&z.propOrbits[l][X].hand==J&&((void 0==K||z.propOrbits[l][X].beat<K.beat)&&(K=z.propOrbits[l][X],N=l,O=X),z.propOrbits[l][X].beat>h&&(void 0==o||z.propOrbits[l][X].beat<o.beat)&&(o=z.propOrbits[l][X],P=l,Q=X),(void 0==M||z.propOrbits[l][X].beat>M.beat)&&(M=z.propOrbits[l][X],R=l,S=X),z.propOrbits[l][X].beat<=h&&(void 0==L||z.propOrbits[l][X].beat>L.beat)&&(L=z.propOrbits[l][X],T=l,U=X));void 0==o&&(o=K,P=N,Q=O),void 0==L&&(L=M,T=R,U=S),V=0==Q?z.propOrbits[P].last():z.propOrbits[P][Q-1],W=0==U?z.propOrbits[T].last():z.propOrbits[T][U-1];var Y=o.beat*z.beatDuration;i>Y&&(Y+=z.beatDuration*z.states.length);var Z=L.beat*z.beatDuration+z.dwellDuration;Z>i&&(Z-=z.beatDuration*z.states.length);var $=W.beat*z.beatDuration;Z>$&&($+=z.beatDuration*z.states.length);var _=V.beat*z.beatDuration+z.dwellDuration;_>Y&&(_-=z.beatDuration*z.states.length);var aa=q(r(z.dwellPath[L.dwellPathIx],L.juggler,L.hand,1),r(z.dwellPath[W.dwellPathIx],W.juggler,W.hand,0),$-Z,0,{numBounces:L.numBounces,bounceType:L.bounceType,bounceOrder:L.bounceOrder,R:z.props[T].radius,C:z.props[T].C}),ba=q(r(z.dwellPath[V.dwellPathIx],V.juggler,V.hand,1),r(z.dwellPath[o.dwellPathIx],o.juggler,o.hand,0),Y-_,Y-_,{numBounces:V.numBounces,bounceType:V.bounceType,bounceOrder:V.bounceOrder,R:z.props[P].radius,C:z.props[P].C}),A=(i-Z)/(Y-Z),B=r([z.dwellPath[L.dwellPathIx].last(),z.dwellPath[o.dwellPathIx][0]],L.juggler,L.hand,A,aa,ba,z.emptyTossScale,z.emptyCatchScale),ca=r([z.dwellPath[L.dwellPathIx].last(),z.dwellPath[o.dwellPathIx][0]],L.juggler,L.hand,1),da={x:ba.x-ca.x,y:ba.y-ca.y,z:ba.z-ca.z};B.x+=A*da.x,B.y+=A*da.y,B.z+=A*da.z,g[I][J]=B}d[I][J].push(g[I][J]),e[I][J].push(s({x:z.jugglers[I].position.x+Math.cos(z.jugglers[I].rotation)*(J==k?-1:1)*.225,y:1.425,z:z.jugglers[I].position.z+0*Math.sin(z.jugglers[I].rotation)},g[I][J],.45,z.armAngle,J))}}z.propPositions=b,z.propRotations=c,z.jugglerHandPositions=d,z.jugglerElbowPositions=e}function q(a,b,c,d,e){c=parseFloat(c.toFixed(2)),void 0==e&&(e={}),e.bounceType||(e.bounceType="L"),e.dt||(e.dt=.01),e.eps||(e.eps=.01),e.dv||(e.dv=.01),e.numBounces||(e.numBounces=0),e.bounceOrder||(e.bounceOrder=[0]),e.G||(e.G=-9.8),e.C||(e.C=.95),e.tries||(e.tries=1e4),e.R||(e.R=.1);var f=JSON.stringify({p0:a,p1:b,T:c,options:e});if(0==e.numBounces)return{x:a.x+(b.x-a.x)*d/c,y:a.y+(b.y-a.y-.5*e.G*c*c)*d/c+.5*e.G*d*d,z:a.z+(b.z-a.z)*d/c,dx:(b.x-a.x)/c,dy:(b.y-a.y-.5*e.G*c*c)/c+e.G*d,dz:(b.z-a.z)/c};if(void 0==j[f]){var g={p0:a,pT:b,minT:c,maxT:c,R:e.R,C:e.C,dt:e.dt,G:-9.8,numBounces:e.numBounces,surfaceBounceOrder:e.bounceOrder,tossSign:"L"==e.bounceType||"HL"==e.bounceType?1:-1,catchSign:"L"==e.bounceType||"HF"==e.bounceType?1:-1,surfaces:z.surfaces},h={maxGenerations:500,populationSize:50,mutationChance:.7,mutationScale:5,initialScale:20,fitnessThreshold:.05,noGA:!1};if(ga=new BounceGA(h,g),ga.evolve(),!ga.ableToFindSolution)throw{message:"Unable to calculate bounce path"};var i=ga.getBouncePath(ga.fittestMembers[ga.fittestMembers.length-1].v);j[f]={path:i.path,velocities:i.velocities}}var k=j[f];return{x:k.path[Math.floor((k.path.length-1)*d/c)].x,y:k.path[Math.floor((k.path.length-1)*d/c)].y,z:k.path[Math.floor((k.path.length-1)*d/c)].z,dx:k.velocities[Math.floor((k.velocities.length-1)*d/c)].x,dy:k.velocities[Math.floor((k.velocities.length-1)*d/c)].y,dz:k.velocities[Math.floor((k.velocities.length-1)*d/c)].z}}function r(a,b,c,d,e,f,g,h){var i;if(0==d)i=a[0];else if(1==d)i=a.last();else{1==a.length&&a.push(a[0]),c==k&&(e.dx*=-1,f.dx*=-1);for(var j=[{x:a[0].x+e.dx*g,y:a[0].y+e.dy*g,z:a[0].z+e.dz*g},{x:a.last().x-f.dx*h,y:a.last().y-f.dy*h,z:a.last().z-f.dz*h}],l=1e-5,m=[],n=[],o=0;o<a.length-1;o++){var p,q,r=a[o],s=a[o+1];if(0==o)p=j[0];else{var t=m[m.length-1],p={x:r.x+(r.x-t.x),y:r.y+(r.y-t.y),z:r.z+(r.z-t.z)};m.push(p)}if(o+1==a.length-1)q=j[1];else{var u={x:(a[o].x+a[o+1].x)/2,y:(a[o].y+a[o+1].y)/2,z:(a[o].z+a[o+1].z)/2},v={x:(a[o+1].x+a[o+2].x)/2,y:(a[o+1].y+a[o+2].y)/2,z:(a[o+1].z+a[o+2].z)/2},w=Math.sqrt(Math.pow(a[o].x-a[o+1].x,2)+Math.pow(a[o].y-a[o+1].y,2)+Math.pow(a[o].z-a[o+1].z,2)),x=Math.sqrt(Math.pow(a[o+1].x-a[o+2].x,2)+Math.pow(a[o+1].y-a[o+2].y,2)+Math.pow(a[o+1].z-a[o+2].z,2)),y=w/(w+x),A={x:(1-y)*u.x+y*v.x,y:(1-y)*u.y+y*v.y,z:(1-y)*u.z+y*v.z};q={x:s.x+(u.x-A.x),y:s.y+(u.y-A.y),z:s.z+(u.z-A.z)},m.push(q)}for(var y=0;1+l>=y;y+=.02)n.push({x:Math.pow(1-y,3)*r.x+3*Math.pow(1-y,2)*y*p.x+3*(1-y)*Math.pow(y,2)*q.x+Math.pow(y,3)*s.x,y:Math.pow(1-y,3)*r.y+3*Math.pow(1-y,2)*y*p.y+3*(1-y)*Math.pow(y,2)*q.y+Math.pow(y,3)*s.y,z:Math.pow(1-y,3)*r.z+3*Math.pow(1-y,2)*y*p.z+3*(1-y)*Math.pow(y,2)*q.z+Math.pow(y,3)*s.z}),n.last().dist=1==n.length?0:n[n.length-2].dist+Math.sqrt(Math.pow(n.last().x-n[n.length-2].x,2)+Math.pow(n.last().y-n[n.length-2].y,2)+Math.pow(n.last().z-n[n.length-2].z,2))}var B;if(z.matchVelocity){var C=Math.sqrt(Math.pow(e.dx,2)+Math.pow(e.dy,2)+Math.pow(e.dz,2)),D=Math.sqrt(Math.pow(f.dx,2)+Math.pow(f.dy,2)+Math.pow(f.dz,2)),E=n.last().dist,F=z.dwellDuration,G=(6*F*(D+C)-12*E)/Math.pow(F,3),H=(D-C-.5*G*Math.pow(F,2))/F,I=d*F,J=C*I+.5*H*Math.pow(I,2)+1/6*G*Math.pow(I,3);B=0;for(var o=0;o<n.length;o++)n[o].dist<=J&&(B=o)}else B=Math.floor(d*n.length);i=n[0>B?0:B]}return{x:z.jugglers[b].position.x+(i.z-.4125)*Math.sin(z.jugglers[b].rotation)+(c==k?-1:1)*i.x*Math.cos(z.jugglers[b].rotation),y:1.0125+i.y,z:z.jugglers[b].position.z+(i.z-.4125)*Math.cos(z.jugglers[b].rotation)+(c==k?-1:1)*i.x*Math.sin(z.jugglers[b].rotation)}}function s(a,b,c,d,e){var f={};f.x=b.x-a.x,f.y=b.y-a.y,f.z=b.z-a.z;var g={};g.x=Math.sqrt(f.x*f.x+f.z*f.z),g.y=f.y,g.z=0;var h=Math.atan2(f.z,f.x),i=Math.sqrt(f.x*f.x+f.y*f.y+f.z*f.z);i>2*c&&(c=i/2);var j={};j.x=g.y/i,j.y=-g.x/i,j.z=0;var k={x:0,y:0};k.z=1==e?-1:1;var l=Math.sqrt(c*c-.25*i*i),m={};m.x=g.x/2+l*j.x*Math.cos(d)+l*k.x*Math.sin(d),m.y=g.y/2+l*j.y*Math.cos(d)+l*k.y*Math.sin(d),m.z=g.z/2+l*j.z*Math.cos(d)+l*k.z*Math.sin(d);var n={};n.x=m.x*Math.cos(h)+m.z*Math.sin(h),n.y=m.y,n.z=m.x*Math.sin(h)+m.z*Math.cos(h);var o={};return o.x=n.x+a.x,o.y=n.y+a.y,o.z=n.z+a.z,o}var t,u,v,w,x,y,z={siteswap:a,validSyntax:!1,validPattern:!1,multiplex:void 0,sync:void 0,pass:void 0,numJugglers:void 0,numProps:void 0,maxHeight:void 0,tosses:void 0,beats:void 0,states:void 0,propOrbits:void 0,propPositions:void 0,propRotations:void 0,jugglerHandPositions:void 0,jugglerElbowPositions:void 0,jugglers:void 0,validationOnly:void 0,numStepsPerBeat:void 0,numSteps:void 0,beatDuration:void 0,dwellDuration:void 0,props:void 0,dwellPath:void 0,tossMatchVelocity:void 0,catchMatchVelocity:void 0,dwellCatchScale:void 0,dwellTossScale:void 0,emptyTossScale:void 0,emptyCatchScale:void 0,armAngle:void 0,surfaces:void 0,errorMessage:void 0};return i(),m(),z.errorMessage?z:(o(),z.errorMessage?z:(z.validationOnly||p(),z))}Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]});var j={},k=0,l=1;a.CreateSiteswap=i}("undefined"==typeof exports?this.SiteswapJS={}:exports);