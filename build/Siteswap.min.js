function getURLQueryStringParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function cloneObject(a){var b=a instanceof Array?[]:{};for(var c in a)"clone"!=c&&(b[c]=a[c]&&"object"==typeof a[c]?cloneObject(a[c]):a[c]);return b}function arraysEqual(a,b){if(!(a instanceof Array&&b instanceof Array))return!1;if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]instanceof Array||b[c]instanceof Array){var d=arraysEqual(a[c],b[c]);if(!d)return!1}else if(a[c]!=b[c])return!1;return!0}function cross(a,b){return{x:a.y*b.z-a.z*b.y,y:a.z*b.x-a.x*b.z,z:a.x*b.y-a.y*b.x}}function dot(a,b){return a.x*b.x+a.y*b.y+a.z*b.z}function magnitude(a){return Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z)}function normalize(a){var b=magnitude(a);return a.x=a.x/b,a.y=a.y/b,a.z=a.z/b,a}function multiply(a,b){return a.x*=b,a.y*=b,a.z*=b,a}function add(a,b){return a.x+=b.x,a.y+=b.y,a.z+=b.z,a}function sub(a,b){return a.x-=b.x,a.y-=b.y,a.z-=b.z,a}function negate(a){return multiply(a,-1),a}function BounceGA(a,b){if(this.gaConfig=a,this.fitnessConfig=b,void 0===b.axis1)for(var c=0;c<this.fitnessConfig.surfaces.length;c++){var d=this.fitnessConfig.surfaces[c];normalize(d.normal);var e;e=0==d.normal.x&&0==d.normal.z?{x:1,y:0,z:0}:{x:-d.normal.z,y:0,z:d.normal.x};var f=cross(d.normal,e);normalize(e),normalize(f),multiply(e,d.scale),multiply(f,d.scale),d.axis1=e,d.axis2=f}this.generations=0,this.rankedPopulation=[],this.fittestMembers=[],this.ableToFindSolution=void 0}Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]}),BounceGA.prototype.getBouncePath=function(a){var b=cloneObject(this.fitnessConfig.p0),c=cloneObject(a),d=[],e=[];d.push(cloneObject(b)),e.push(cloneObject(c));for(var f=0;f<this.fitnessConfig.surfaces.length;f++)this.fitnessConfig.surfaces[f].bounces=0,this.fitnessConfig.surfaces[f].colliding=!1;for(var g=0,h=[],i=[],j=0;j<=this.fitnessConfig.maxT;j+=this.fitnessConfig.dt){add(b,multiply(cloneObject(c),this.fitnessConfig.dt)),c.y+=this.fitnessConfig.G*this.fitnessConfig.dt,d.push(cloneObject(b)),e.push(cloneObject(c));for(var f=0;f<this.fitnessConfig.surfaces.length;f++){var k=this.fitnessConfig.surfaces[f],l=k.normal.x*b.x+k.normal.y*b.y+k.normal.z*b.z-k.normal.x*k.position.x-k.normal.y*k.position.y-k.normal.z*k.position.z;if(Math.abs(l)<=this.fitnessConfig.R&&Math.abs(dot(sub(cloneObject(b),k.position),normalize(cloneObject(k.axis1))))<=k.scale&&Math.abs(dot(sub(cloneObject(b),k.position),normalize(cloneObject(k.axis2))))<=k.scale&&!k.colliding){k.colliding=!0,k.bounces++,h.push(f),g++;var m=(new THREE.Vector3).copy(k.normal),m=cloneObject(k.normal);multiply(m,dot(c,k.normal)),multiply(m,2*this.fitnessConfig.C),negate(m),add(c,m)}else Math.abs(l)>this.fitnessConfig.R&&k.colliding&&(k.colliding=!1)}if(j>=this.fitnessConfig.minT||j+this.fitnessConfig.dt>this.fitnessConfig.maxT){var n=!0;this.fitnessConfig.surfaceBounceOrder&&h.toString()!=this.fitnessConfig.surfaceBounceOrder.toString()&&(n=!1);var o=!1;g==this.fitnessConfig.numBounces&&(o=!0),n&&o&&(1==this.fitnessConfig.catchSign&&c.y>=0||-1==this.fitnessConfig.catchSign&&c.y<=0||void 0==this.fitnessConfig.catchSign)&&(1==this.fitnessConfig.tossSign&&a.y>=0||-1==this.fitnessConfig.tossSign&&a.y<=0||void 0==this.fitnessConfig.tossSign)&&i.push({pT:cloneObject(b),T:j,actualpT:this.fitnessConfig.pT})}}return i.length>0?(i.sort(function(a,b){return magnitude(sub(cloneObject(a.pT),a.actualpT))-magnitude(sub(cloneObject(b.pT),a.actualpT))}),{path:d.splice(0,i[0].T/this.fitnessConfig.dt),velocities:e.splice(0,i[0].T/this.fitnessConfig.dt),T:i[0].T}):{path:void 0,velocities:void 0,T:void 0}},BounceGA.prototype.generateMember=function(a){var b={x:0,y:0,z:0};if(a&&a.fitness<100)Math.random()<this.gaConfig.mutationChance?(b.x=(1-2*Math.random())*(a.fitness<this.gaConfig.mutationScale?a.fitness:this.gaConfig.mutationScale),b.y=(1-2*Math.random())*(a.fitness<this.gaConfig.mutationScale?a.fitness:this.gaConfig.mutationScale),b.z=(1-2*Math.random())*(a.fitness<this.gaConfig.mutationScale?a.fitness:this.gaConfig.mutationScale),add(b,a.v)):b=cloneObject(a.v);else{var c;c=this.fitnessConfig.surfaceBounceOrder?this.fitnessConfig.surfaces[this.fitnessConfig.surfaceBounceOrder[0]]:this.fitnessConfig.surfaces[Math.floor(Math.random()*this.fitnessConfig.surfaces.length)],b=cloneObject(c.position),add(b,multiply(cloneObject(c.axis1),1-2*Math.random())),add(b,multiply(cloneObject(c.axis2),1-2*Math.random()));var d=b.y;b.y=0;var e=cloneObject(this.fitnessConfig.p0);e.y=0;var f=cloneObject(this.fitnessConfig.pT);f.y=0;var g=0,h=this.gaConfig.initialScale;sub(b,e),normalize(b),multiply(b,g+(h-g)*Math.random()),g=1==this.fitnessConfig.tossSign||d>this.fitnessConfig.p0.y?0:-(2*(this.fitnessConfig.p0.y-d)/this.fitnessConfig.minT),h=this.gaConfig.initialScale,b.y=g+(h-g)*Math.random()}var i=this.getBouncePath(b);return{v:b,T:i.T,fitness:i.path?magnitude(sub(cloneObject(i.path[i.path.length-1]),this.fitnessConfig.pT)):100}},BounceGA.prototype.evolve=function(){if(this.generations>=this.gaConfig.maxGenerations)this.ableToFindSolution=!1;else if(this.rankedPopulation.length>0&&this.rankedPopulation[0].fitness<=this.gaConfig.fitnessThreshold)this.ableToFindSolution=!0;else{if(0==this.rankedPopulation.length||this.gaConfig.noGA){this.rankedPopulation=[];for(var a=0;a<this.gaConfig.populationSize;a++)this.rankedPopulation.push(this.generateMember(void 0))}else{for(var b=0,c=[],a=0;a<this.rankedPopulation.length;a++)b+=1/this.rankedPopulation[a].fitness,c.push(b);for(var d=[],a=0;a<this.gaConfig.populationSize;a++)if(a<.5*this.gaConfig.populationSize)d.push(this.generateMember(void 0));else for(var e=Math.random()*b,f=0;f<c.length;f++)if(e<c[f]){d.push(this.generateMember(this.rankedPopulation[f]));break}this.rankedPopulation=d}this.rankedPopulation.sort(function(a,b){return a.fitness-b.fitness});var g=this.rankedPopulation[0];this.fittestMembers.push(g),this.generations++,this.generations%100==0&&console.log(this.generations+" "+g.fitness),this.evolve()}},function(a){a.interpolateBezierSpline=function(a,b,c,d,e,f){var g;if(0==b)g=a[0];else if(1==b)g=a.last();else{1==a.length&&a.push(a[0]);for(var h=[{x:a[0].x+c.dx*e,y:a[0].y+c.dy*e,z:a[0].z+c.dz*e},{x:a.last().x-d.dx*f,y:a.last().y-d.dy*f,z:a.last().z-d.dz*f}],i=1e-5,j=[],k=[],l=0;l<a.length-1;l++){var m,n,o=a[l],p=a[l+1];if(0==l)m=h[0];else{var q=j[j.length-1],m={x:o.x+(o.x-q.x),y:o.y+(o.y-q.y),z:o.z+(o.z-q.z)};j.push(m)}if(l+1==a.length-1)n=h[1];else{var r={x:(a[l].x+a[l+1].x)/2,y:(a[l].y+a[l+1].y)/2,z:(a[l].z+a[l+1].z)/2},s={x:(a[l+1].x+a[l+2].x)/2,y:(a[l+1].y+a[l+2].y)/2,z:(a[l+1].z+a[l+2].z)/2},t=Math.sqrt(Math.pow(a[l].x-a[l+1].x,2)+Math.pow(a[l].y-a[l+1].y,2)+Math.pow(a[l].z-a[l+1].z,2)),u=Math.sqrt(Math.pow(a[l+1].x-a[l+2].x,2)+Math.pow(a[l+1].y-a[l+2].y,2)+Math.pow(a[l+1].z-a[l+2].z,2)),v=t/(t+u),w={x:(1-v)*r.x+v*s.x,y:(1-v)*r.y+v*s.y,z:(1-v)*r.z+v*s.z};n={x:p.x+(r.x-w.x),y:p.y+(r.y-w.y),z:p.z+(r.z-w.z)},j.push(n)}for(var v=0;1+i>=v;v+=.02)k.push({x:Math.pow(1-v,3)*o.x+3*Math.pow(1-v,2)*v*m.x+3*(1-v)*Math.pow(v,2)*n.x+Math.pow(v,3)*p.x,y:Math.pow(1-v,3)*o.y+3*Math.pow(1-v,2)*v*m.y+3*(1-v)*Math.pow(v,2)*n.y+Math.pow(v,3)*p.y,z:Math.pow(1-v,3)*o.z+3*Math.pow(1-v,2)*v*m.z+3*(1-v)*Math.pow(v,2)*n.z+Math.pow(v,3)*p.z}),k.last().dist=1==k.length?0:k[k.length-2].dist+Math.sqrt(Math.pow(k.last().x-k[k.length-2].x,2)+Math.pow(k.last().y-k[k.length-2].y,2)+Math.pow(k.last().z-k[k.length-2].z,2))}var x;if(siteswap.matchVelocity){var y=Math.sqrt(Math.pow(c.dx,2)+Math.pow(c.dy,2)+Math.pow(c.dz,2)),z=Math.sqrt(Math.pow(d.dx,2)+Math.pow(d.dy,2)+Math.pow(d.dz,2)),A=k.last().dist,B=siteswap.dwellDuration,C=(6*B*(z+y)-12*A)/Math.pow(B,3),D=(z-y-.5*C*Math.pow(B,2))/B,E=b*B,F=y*E+.5*D*Math.pow(E,2)+1/6*C*Math.pow(E,3);x=0;for(var l=0;l<k.length;l++)k[l].dist<=F&&(x=l)}else x=Math.floor(b*k.length);g=k[0>x?0:x]}return g}}("undefined"==typeof exports?this.Bezier={}:exports),function(a){function b(a){for(var b=0,c=0;c<a.length;c++)parseInt(a[c])?b+=parseInt(a[c]):a.charCodeAt(c)>=97&&a.charCodeAt(c)<=119&&(b+=a.charCodeAt(c)-87),"P"!=a[c]&&"S"!=a[c]||!parseInt(a[c+1])||c++,"B"!=a[c]&&"D"!=a[c]&&"T"!=a[c]&&"C"!=a[c]&&"S"!=a[c]||"{"!=a[c+1]||(c=a.indexOf("}",c)+1);return b}var c={},d=0,e=1;a.CreateSiteswap=function(a,f){function g(){if(void 0===f&&(f={}),v.validationOnly=void 0===f.validationOnly?!1:f.validationOnly,v.beatDuration=void 0===f.beatDuration?.2:f.beatDuration,v.dwellDuration=void 0===f.dwellRatio?.5*v.beatDuration:v.beatDuration*f.dwellRatio,v.numStepsPerBeat=void 0===f.numStepsPerBeat?Math.floor(200*v.beatDuration):f.numStepsPerBeat,v.matchVelocity=void 0===f.matchVelocity?!1:f.matchVelocity,v.dwellCatchScale=void 0===f.dwellCatchScale?.05:f.dwellCatchScale,v.dwellTossScale=void 0===f.dwellTossScale?.05:f.dwellTossScale,v.emptyTossScale=void 0===f.emptyTossScale?.05:f.emptyTossScale,v.emptyCatchScale=void 0===f.emptyCatchScale?.05:f.emptyCatchScale,v.armAngle=void 0===f.armAngle?.1:f.armAngle,v.props=void 0===f.props?[{type:"ball",radius:.05,C:.95}]:f.props,v.dwellPath=void 0===f.dwellPath?[[{x:.3,y:0,z:0,rotation:{x:4,y:0,z:-1,th:Math.PI/2}},{x:.1,y:0,z:0,rotation:{x:4,y:0,z:1,th:Math.PI/2}}]]:f.dwellPath,v.surfaces=void 0===f.surfaces?[{position:{x:0,y:0,z:0},normal:{x:0,y:1,z:0},scale:5}]:f.surfaces,v.jugglers=[],void 0===f.jugglers)for(var a=0;a<v.numJugglers;a++)v.jugglers.push({position:{x:0,z:-2*a},rotation:a*Math.PI});else{if(v.numJugglers!=f.jugglers.length)throw"Number of jugglers doesn't match";for(var a=0;a<f.jugglers.length;a++)v.jugglers.push({position:f.jugglers[a].position,rotation:f.jugglers[a].rotation})}for(var a=0;a<v.surfaces.length;a++){var b=v.surfaces[a];normalize(b.normal);var c;c=0==b.normal.x&&0==b.normal.z?{x:1,y:0,z:0}:{x:-b.normal.z,y:0,z:b.normal.x};var d=cross(b.normal,c);normalize(c),multiply(c,b.scale),normalize(d),multiply(d,b.scale),b.axis1=c,b.axis2=d}}function h(){var b=1,c=/<[^ ]+>/.test(a);if(c){var d=a.match(/<[^ <>]+>/g);if(b=d[0].split("|").length,1==b)return v;var e=b;d.map(function(a){return a.split("|").length!=e?v:void 0})}var f="";2==b?f="P":b>2&&(f="P[1-"+b+"]");var g="(R|L)?([\\da-o])x?A?("+f+")?(C{(C|P)?})?(T{(C|P)?})?(B({\\d*(L|HL|F|HF)?})?)?(S{-?\\d+(.\\d+)?(,-?\\d+(.\\d+)?,-?\\d+(.\\d+)?,-?\\d+(.\\d+)?)?})?(D{\\d*\\.?\\d*})?",h="\\[("+g+")+\\]",i="\\(("+g+"|"+h+"),("+g+"|"+h+")\\)",j="("+g+"|"+h+"|"+i+")",k="<"+j+"(\\|"+j+")+>",l="^("+k+")+|("+j+")+$";p=new RegExp(g,"g"),q=new RegExp(h,"g"),r=new RegExp(i,"g"),s=new RegExp(j,"g"),t=new RegExp(k,"g"),u=new RegExp(l,"g"),a.match(u)?(v.validSyntax=!0,v.multiplex=a.match(q)?!0:!1,v.sync=a.match(r)?!0:!1,v.pass=a.match(t)?!0:!1,v.numJugglers=b):v.errorMessage="Invalid syntax"}function i(a,b,c,f,g,h){if(b.match(t)){var j=b.match(s);j.map(function(b,c){h=i(a,b,c,void 0,void 0,h)})}else if(b.match(r)){var j=b.split(",");h=i(a,j[0].substr(1),c,!0,d,h),h=i(a,j[1].substr(0,j[1].length-1),c,!0,e,h)}else if(b.match(q)){var j=b.match(p);j.map(function(b){h=i(a,b,c,void 0,g,h)})}else{var k=b[0].charCodeAt(0)>=97&&b[0].charCodeAt(0)<=119?b[0].charCodeAt(0)-87:parseInt(b[0]),l=c,m=b.indexOf("P"),n=!1;m>0&&"}"!=b[m+1]&&(l=v.numJugglers>2?parseInt(b[m+1])-1:1-c,n=!0);var o=0,u=[],w=b.indexOf("B");if(w>0){if("{"!=b[w+1]||isNaN(b[w+2]))o=1,u=[0];else{o=parseInt(b[w+2]);for(var x=w+3;x<b.length&&!isNaN(b[x]);x++){var y=parseInt(b[x]);if(y>=v.surfaces.length)throw{message:"Bounce surface index out of range"};u.push(y)}}if(u.length<o)for(var z=u.length,x=0;o-z>x;x++)u.push(0)}var A=void 0;o>0&&(A=b.match("HF")?"HF":b.match("HL")?"HL":b.match("F")?"F":(b.match("L"),"L"));var B,C=b.indexOf("D");C>0&&(B=v.beatDuration*parseFloat(b.substring(C+2,b.indexOf("}"))));var D=b.indexOf("T"),E="standard";if(D>0){var F=b.substring(D+2,b.indexOf("}",D));F.match("C")?E="claw":F.match("P")&&(F="penguin")}var G=b.indexOf("C"),H="standard";if(G>0){var I=b.substring(G+2,b.indexOf("}",G));I.match("C")?H="claw":I.match("P")&&(H="penguin")}var J=k%2==1?!0:!1;b.length>1&&"x"==b[1]&&(J=!J),"R"==b[0]?g=e:"L"==b[0]&&(g=d);var K,L=normalize({x:.1,y:.1,z:1}),M=b.indexOf("S");if(M>0){var N=b.substring(M+2,b.indexOf("}",M)).match(/-?\d+(\.\d+)?/g);K=parseFloat(N[0]),N.length>1&&(L.x=parseFloat(N[1]),L.y=parseFloat(N[2]),L.z=parseFloat(N[3]),normalize(L))}else K=Math.floor(k/2)+.2,n&&(K+=.1);a.push({juggler:c,targetJuggler:l,hand:g,crossing:J,numBeats:k,siteswapStr:b,numBounces:o,bounceOrder:u,bounceType:A,numSpins:K,dwellPathIx:h,dwellDuration:void 0===B?v.dwellDuration:B,tossType:E,catchType:H,tossOrientation:L,rotationAxis:{x:1,y:0,z:0},hold:2!=k||J||-1!=b.indexOf("A")?!1:!0}),h==v.dwellPath.length-1?h=0:h++}return h}function j(){v.beats=a.match(v.pass?t:s);for(var c=0;c<v.beats.length;c++)v.beats[c].match(r)&&(v.beats.splice(c+1,0,"(0,0)"),c++);var f=0;if(v.beats.map(function(a){if(a.match(t))for(var c=a.split("|"),d=0;d<c.length;d++)0==d&&(c[d]=c[d].substr(1)),d==c.length-1&&(c[d]=c[d].substr(0,c[d].length-1)),f+=b(c[d]);else f+=b(a)}),!(f/v.beats.length%1==0&&f/v.beats.length>0))return void(v.errorMessage="Cannot determine number of props");for(v.numProps=f/v.beats.length;v.props.length<v.numProps;)v.props.push(cloneObject(v.props.last()));for(;v.props.length>v.numProps;)v.props.pop();v.tosses=[];for(var g=0,c=0;c<v.beats.length;c++){var h=[];g=i(h,v.beats[c],0,void 0,void 0,g),v.tosses.push(h),c==v.beats.length-1&&0!=g&&(c=-1)}v.maxHeight=0;for(var c=0;c<v.tosses.length;c++)for(var j=0;j<v.tosses[c].length;j++)v.tosses[c][j].numBeats>v.maxHeight&&(v.maxHeight=v.tosses[c][j].numBeats);for(var k=[],c=0;c<v.numProps;c++)k.push(c);v.states=[],v.propOrbits=[];for(var l=[],j=0;j<v.numJugglers;j++){l.push([[],[]]);for(var m=0;m<v.maxHeight;m++)l[j][d].push(void 0),l[j][e].push(void 0)}for(var n=!1,o=!1,p=0,q=d;!n;){for(var u=cloneObject(v.propOrbits),w=[],j=0;j<v.numJugglers;j++){var x=l[j][d].shift();if(x)for(var m=0;m<x.length;m++)w.push({propId:x[m],juggler:j,hand:d});var y=l[j][e].shift();if(y)for(var m=0;m<y.length;m++)w.push({propId:y[m],juggler:j,hand:e});l[j][d].push(void 0),l[j][e].push(void 0)}for(var j=0;j<v.tosses[p%v.tosses.length].length;j++){for(var z=v.tosses[p%v.tosses.length][j],A=void 0==z.hand?q:z.hand,B=z.crossing?1-A:A,C=void 0,m=0;m<w.length;m++)if(w[m].juggler==z.juggler&&w[m].hand==A){if(0==z.numBeats)return void(v.errorMessage="Prop landing on 0 toss at beat "+p);C=w.splice(m,1)[0].propId;break}if(void 0==C&&z.numBeats>0&&(C=k.shift()),void 0==C&&z.numBeats>0)return void(v.errorMessage="No prop available to toss at beat "+p);z.numBeats>0&&(u[C]||(u[C]=[]),u[C].push({beat:p,numBeats:z.numBeats,juggler:z.juggler,hand:A,numBounces:z.numBounces,bounceType:z.bounceType,bounceOrder:z.bounceOrder,numSpins:z.numSpins,dwellPathIx:z.dwellPathIx,dwellDuration:z.dwellDuration,tossType:z.tossType,catchType:z.catchType,tossOrientation:z.tossOrientation,rotationAxis:z.rotationAxis,hold:z.hold}),void 0==l[z.targetJuggler][B][z.numBeats-1]?l[z.targetJuggler][B][z.numBeats-1]=[C]:l[z.targetJuggler][B][z.numBeats-1].push(C))}if(o&&p%v.tosses.length==0&&arraysEqual(v.states[0],l)?n=!0:(v.states.push(cloneObject(l)),v.propOrbits=u),0!=k.length||(p+1)%v.tosses.length!=0||o||(o=!0,p=-1,v.states=[],v.propOrbits=[]),p++,q=1-q,p>1e3)return void(v.errorMessage="Pattern took more than 1000 beats to repeat states")}v.numSteps=v.states.length*v.numStepsPerBeat,v.validPattern=!0}function k(){try{c={};for(var a=[],b=0;b<v.numProps;b++)a.push([]);for(var f=[],b=0;b<v.numProps;b++)f.push([]);for(var g=[],b=0;b<v.numJugglers;b++)g.push([[],[]]);for(var h=[],b=0;b<v.numJugglers;b++)h.push([[],[]]);for(var i=0;i<v.numSteps;i++){for(var j=[],b=0;b<v.numJugglers;b++)j.push([void 0,void 0]);for(var k=Math.floor(i*v.states.length/v.numSteps),p=v.beatDuration*i*v.states.length/v.numSteps,q=0;q<v.numProps;q++){var r=void 0,s=void 0,t=void 0;1==v.propOrbits[q].length&&(r=v.propOrbits[q][0],s=v.propOrbits[q][0],t=v.propOrbits[q][0]);for(var u=!1,b=0;b<v.propOrbits[q].length-1;b++)!u&&v.propOrbits[q][b].beat<=k&&v.propOrbits[q][b+1].beat>k?(r=0==b?v.propOrbits[q][v.propOrbits[q].length-1]:v.propOrbits[q][b-1],s=v.propOrbits[q][b],t=v.propOrbits[q][b+1],u=!0):u||b!=v.propOrbits[q].length-2||(r=v.propOrbits[q][b],s=v.propOrbits[q][b+1],t=v.propOrbits[q][0]);var w=s.beat*v.beatDuration+s.dwellDuration,x=t.beat*v.beatDuration;w>x&&p>=x?x+=v.beatDuration*v.states.length:w>x&&x>p&&(w-=v.beatDuration*v.states.length);var y=r.beat*v.beatDuration+s.dwellDuration,z=s.beat*v.beatDuration;if(y>z&&p>=z?z+=v.beatDuration*v.states.length:y>z&&z>p&&(y-=v.beatDuration*v.states.length),w>p){var A=l(m(v.dwellPath[s.dwellPathIx],s.juggler,s.hand,1),m(v.dwellPath[t.dwellPathIx],t.juggler,t.hand,0),x-w,0,{numBounces:s.numBounces,bounceType:s.bounceType,bounceOrder:s.bounceOrder,R:v.props[q].radius,C:v.props[q].C}),B=l(m(v.dwellPath[r.dwellPathIx],r.juggler,r.hand,1),m(v.dwellPath[s.dwellPathIx],s.juggler,s.hand,0),z-y,z-y,{numBounces:r.numBounces,bounceType:r.bounceType,bounceOrder:r.bounceOrder,R:v.props[q].radius,C:v.props[q].C}),C=1-(w-p)/s.dwellDuration,D=m(v.dwellPath[s.dwellPathIx],s.juggler,s.hand,C,B,A,v.dwellCatchScale,v.dwellTossScale),E=m(v.dwellPath[s.dwellPathIx],s.juggler,s.hand,0),F={x:B.x-E.x,y:B.y-E.y,z:B.z-E.z};D.x+=(1-C)*F.x,D.y+=(1-C)*F.y,D.z+=(1-C)*F.z;var G=Math.atan2(-B.dx,-B.dy),H=Math.atan2(A.dx,A.dy);"claw"==s.tossType?H-=Math.PI:"penguin"==s.tossTypeId&&(H-=2*Math.PI),"claw"==s.catchType?G-=Math.PI:"penguin"==s.catchType&&(G-=2*Math.PI),D.angle=G+C*(H-G),s.hand==e&&(D.angle*=-1),D.dwell=!0,a[q].push(D),void 0==j[s.juggler][s.hand]&&(j[s.juggler][s.hand]=D);var I=o(r.tossOrientation,r.rotationAxis,v.jugglers[r.juggler].rotation,2*r.numSpins*Math.PI,r.hand),J=o(s.tossOrientation,s.rotationAxis,v.jugglers[s.juggler].rotation,0,s.hand);I.slerp(J,C),f[q].push(I)}else{var D,K=x-w,C=p-w;if(s.hold){var L=m(v.dwellPath[s.dwellPathIx],s.juggler,s.hand,1),M=m(v.dwellPath[t.dwellPathIx],t.juggler,t.hand,0),N=l(L,M,K,0),O=l(L,M,K,K);D=m([v.dwellPath[s.dwellPathIx].last(),v.dwellPath[t.dwellPathIx][0]],s.juggler,s.hand,C/K,N,O,v.emptyTossScale,v.emptyCatchScale)}else D=l(m(v.dwellPath[s.dwellPathIx],s.juggler,s.hand,1),m(v.dwellPath[t.dwellPathIx],t.juggler,t.hand,0),K,C,{numBounces:s.numBounces,bounceType:s.bounceType,bounceOrder:s.bounceOrder,R:v.props[q].radius,C:v.props[q].C});D.dwell=!1,a[q].push(D);var P=2*s.numSpins*Math.PI,Q=0,R=Q+C/K*(P-Q);f[q].push(o(s.tossOrientation,s.rotationAxis,v.jugglers[s.juggler].rotation,R,s.hand))}}for(var S=0;S<v.numJugglers;S++)for(var T=0;1>=T;T++){if(void 0==j[S][T]){for(var t=void 0,U=void 0,V=void 0,W=void 0,X=void 0,Y=void 0,Z=void 0,$=void 0,_=void 0,aa=void 0,ba=void 0,ca=void 0,da=void 0,ea=void 0,q=0;q<v.propOrbits.length;q++)for(var fa=0;fa<v.propOrbits[q].length;fa++)v.propOrbits[q][fa].juggler==S&&v.propOrbits[q][fa].hand==T&&((void 0==U||v.propOrbits[q][fa].beat<U.beat)&&(U=v.propOrbits[q][fa],X=q,Y=fa),v.propOrbits[q][fa].beat>k&&(void 0==t||v.propOrbits[q][fa].beat<t.beat)&&(t=v.propOrbits[q][fa],Z=q,$=fa),(void 0==W||v.propOrbits[q][fa].beat>W.beat)&&(W=v.propOrbits[q][fa],_=q,aa=fa),v.propOrbits[q][fa].beat<=k&&(void 0==V||v.propOrbits[q][fa].beat>V.beat)&&(V=v.propOrbits[q][fa],ba=q,ca=fa));void 0==t&&(t=U,Z=X,$=Y),void 0==V&&(V=W,ba=_,ca=aa),da=0==$?v.propOrbits[Z].last():v.propOrbits[Z][$-1],ea=ca==v.propOrbits[ba].length-1?v.propOrbits[ba][0]:v.propOrbits[ba][ca+1];var ga=t.beat*v.beatDuration;p>ga&&(ga+=v.beatDuration*v.states.length);var ha=V.beat*v.beatDuration+V.dwellDuration;ha>p&&(ha-=v.beatDuration*v.states.length);var ia=ea.beat*v.beatDuration;ha>ia&&(ia+=v.beatDuration*v.states.length);var ja=da.beat*v.beatDuration+da.dwellDuration;ja>ga&&(ja-=v.beatDuration*v.states.length);var N=l(m(v.dwellPath[V.dwellPathIx],V.juggler,V.hand,1),m(v.dwellPath[ea.dwellPathIx],ea.juggler,ea.hand,0),V.numBeats*v.beatDuration-V.dwellDuration,0,{numBounces:V.numBounces,bounceType:V.bounceType,bounceOrder:V.bounceOrder,R:v.props[ba].radius,C:v.props[ba].C}),O=l(m(v.dwellPath[da.dwellPathIx],da.juggler,da.hand,1),m(v.dwellPath[t.dwellPathIx],t.juggler,t.hand,0),da.numBeats*v.beatDuration-da.dwellDuration,da.numBeats*v.beatDuration-da.dwellDuration,{numBounces:da.numBounces,bounceType:da.bounceType,bounceOrder:da.bounceOrder,R:v.props[Z].radius,C:v.props[Z].C}),C=(p-ha)/(ga-ha),D=m([v.dwellPath[V.dwellPathIx].last(),v.dwellPath[t.dwellPathIx][0]],V.juggler,V.hand,C,N,O,v.emptyTossScale,v.emptyCatchScale),ka=m([v.dwellPath[V.dwellPathIx].last(),v.dwellPath[t.dwellPathIx][0]],V.juggler,V.hand,1),la={x:O.x-ka.x,y:O.y-ka.y,z:O.z-ka.z};D.x+=C*la.x,D.y+=C*la.y,D.z+=C*la.z;var G=Math.atan2(-O.dx,-O.dy),H=Math.atan2(N.dx,N.dy);"claw"==V.tossType?H-=Math.PI:"penguin"==V.tossType&&(H-=2*Math.PI),"claw"==t.catchType?G-=Math.PI:"penguin"==t.catchType&&(G-=2*Math.PI),D.angle=H+C*(G-H),T==e&&(D.angle*=-1),j[S][T]=D}g[S][T].push(j[S][T]),h[S][T].push(n({x:v.jugglers[S].position.x+Math.cos(v.jugglers[S].rotation)*(T==d?-1:1)*.225,y:1.425,z:v.jugglers[S].position.z+Math.sin(v.jugglers[S].rotation)*(T==d?-1:1)*.225},j[S][T],.45,v.armAngle,T))}}v.propPositions=a,v.propRotations=f,v.jugglerHandPositions=g,v.jugglerElbowPositions=h}catch(ma){v.errorMessage=ma.message}}function l(a,b,d,e,f){d=parseFloat(d.toFixed(2)),void 0==f&&(f={}),f.bounceType||(f.bounceType="L"),f.dt||(f.dt=.01),f.eps||(f.eps=.01),f.dv||(f.dv=.01),f.numBounces||(f.numBounces=0),f.bounceOrder||(f.bounceOrder=[0]),f.G||(f.G=-9.8),f.C||(f.C=.95),f.tries||(f.tries=1e4),f.R||(f.R=.1);var g=JSON.stringify({p0:a,p1:b,T:d,options:f});if(0==f.numBounces)return{x:a.x+(b.x-a.x)*e/d,y:a.y+(b.y-a.y-.5*f.G*d*d)*e/d+.5*f.G*e*e,z:a.z+(b.z-a.z)*e/d,dx:(b.x-a.x)/d,dy:(b.y-a.y-.5*f.G*d*d)/d+f.G*e,dz:(b.z-a.z)/d};if(void 0==c[g]){var h={p0:a,pT:b,minT:d,maxT:d,R:f.R,C:f.C,dt:f.dt,G:-9.8,numBounces:f.numBounces,surfaceBounceOrder:f.bounceOrder,tossSign:"L"==f.bounceType||"HL"==f.bounceType?1:-1,catchSign:"L"==f.bounceType||"HF"==f.bounceType?1:-1,surfaces:v.surfaces},i={maxGenerations:500,populationSize:50,mutationChance:.7,mutationScale:5,initialScale:20,fitnessThreshold:.05,noGA:!1};if(ga=new BounceGA(i,h),ga.evolve(),!ga.ableToFindSolution)throw{message:"Unable to calculate bounce path"};var j=ga.getBouncePath(ga.fittestMembers[ga.fittestMembers.length-1].v);c[g]={path:j.path,velocities:j.velocities}}var k=c[g];return{x:k.path[Math.floor((k.path.length-1)*e/d)].x,y:k.path[Math.floor((k.path.length-1)*e/d)].y,z:k.path[Math.floor((k.path.length-1)*e/d)].z,dx:k.velocities[Math.floor((k.velocities.length-1)*e/d)].x,dy:k.velocities[Math.floor((k.velocities.length-1)*e/d)].y,dz:k.velocities[Math.floor((k.velocities.length-1)*e/d)].z}}function m(a,b,c,e,f,g,h,i,j){c==d&&(f||g)&&(f.dx*=-1,g.dx*=-1);var k=Bezier.interpolateBezierSpline(a,e,f,g,h,i,j);return{x:v.jugglers[b].position.x+(c==d?-1:1)*k.x*Math.cos(v.jugglers[b].rotation)-(k.z-.4125)*Math.sin(v.jugglers[b].rotation),y:1.0125+k.y,z:v.jugglers[b].position.z+(c==d?-1:1)*k.x*Math.sin(v.jugglers[b].rotation)+(k.z-.4125)*Math.cos(v.jugglers[b].rotation)}}function n(a,b,c,d,e){var f={};f.x=b.x-a.x,f.y=b.y-a.y,f.z=b.z-a.z;var g={};g.x=Math.sqrt(f.x*f.x+f.z*f.z),g.y=f.y,g.z=0;var h=Math.atan2(f.z,f.x),i=Math.sqrt(f.x*f.x+f.y*f.y+f.z*f.z);i>2*c&&(c=i/2);var j={};j.x=g.y/i,j.y=-g.x/i,j.z=0;var k={x:0,y:0};k.z=1==e?-1:1;var l=Math.sqrt(c*c-.25*i*i),m={};m.x=g.x/2+l*j.x*Math.cos(d)+l*k.x*Math.sin(d),m.y=g.y/2+l*j.y*Math.cos(d)+l*k.y*Math.sin(d),m.z=g.z/2+l*j.z*Math.cos(d)+l*k.z*Math.sin(d);var n={};n.x=m.x*Math.cos(h)+m.z*Math.sin(h),n.y=m.y,n.z=m.x*Math.sin(h)+m.z*Math.cos(h);var o={};return o.x=n.x+a.x,o.y=n.y+a.y,o.z=n.z+a.z,o}function o(a,b,c,e,f){T=new THREE.Vector3(a.x,a.y,a.z),R=new THREE.Vector3(b.x,b.y,b.z),C=new THREE.Vector3(0,-1,0),f==d&&(T.x*=-1,R.x*=-1);var g=new THREE.Quaternion;g.setFromAxisAngle(new THREE.Vector3(0,-1,0),c),T.applyQuaternion(g);var h=new THREE.Quaternion;h.setFromAxisAngle(new THREE.Vector3(T.z,0,-T.x),Math.acos(T.y));var i=new THREE.Quaternion;i.setFromAxisAngle(new THREE.Vector3(0,1,0),Math.acos(-R.z*T.x+R.x*T.z)),R.applyQuaternion(i);var j=new THREE.Quaternion;j.setFromAxisAngle(R,e);var k=new THREE.Quaternion;return k=(new THREE.Quaternion).multiplyQuaternions(h,j)}var p,q,r,s,t,u,v={siteswap:a,validSyntax:!1,validPattern:!1,multiplex:void 0,sync:void 0,pass:void 0,numJugglers:void 0,numProps:void 0,maxHeight:void 0,tosses:void 0,beats:void 0,states:void 0,propOrbits:void 0,propPositions:void 0,propRotations:void 0,jugglerHandPositions:void 0,jugglerElbowPositions:void 0,jugglers:void 0,validationOnly:void 0,numStepsPerBeat:void 0,numSteps:void 0,beatDuration:void 0,dwellDuration:void 0,props:void 0,dwellPath:void 0,tossMatchVelocity:void 0,catchMatchVelocity:void 0,dwellCatchScale:void 0,dwellTossScale:void 0,emptyTossScale:void 0,emptyCatchScale:void 0,armAngle:void 0,surfaces:void 0,errorMessage:void 0};return h(),g(),v.errorMessage?v:(j(),v.errorMessage?v:(v.validationOnly||k(),v))}}("undefined"==typeof exports?this.SiteswapJS={}:exports);